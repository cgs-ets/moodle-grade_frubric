function _createForOfIteratorHelper(a){if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(a=_unsupportedIterableToArray(a))){var b=0,c=function(){};return{s:c,n:function n(){if(b>=a.length)return{done:!0};return{done:!1,value:a[b++]}},e:function e(a){throw a},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d,e=!0,f=!1,g;return{s:function s(){d=a[Symbol.iterator]()},n:function n(){var a=d.next();e=a.done;return a},e:function e(a){f=!0;g=a},f:function f(){try{if(!e&&null!=d.return)d.return()}finally{if(f)throw g}}}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("gradingform_frubric/criterion_control",["jquery","core/log","core/templates","core/ajax","core/str","core/notification","gradingform_frubric/level_control","gradingform_frubric/feditor_helper"],function(a,b,c,d,e,f,g,h){'use strict';function i(a,b){var c=this;c.LEVEL_ROW="gradingform_frubric/editor_level_row";c.mode=a;c.id=b}i.prototype.main=function(){var a=this;b.debug(a);var c=document.getElementById(a.id);if("edit"==a.mode){try{a.setupEvents(c);var d=c.getAttribute("data-criterion-group"),e=document.querySelector(".level-".concat(d));g.init(a.id)}catch(a){b.debug(a)}}else{a.setupEvents(c)}};i.prototype.setupEvents=function(a){var c=this;b.debug("setupEvents");b.debug(a);var d=a.querySelector(".act");if(!d){return}var e=d.children;e[0].addEventListener("click",c.moveCriterionUp.bind(c,a));e[1].addEventListener("click",c.removeCriterion.bind(a));e[2].addEventListener("click",c.addLevel.bind(c,a));e[3].addEventListener("click",c.copyCriterion);if(1<document.getElementsByClassName("criterion-header").length){e[0].removeAttribute("hidden")}var f=a.querySelector(".crit-desc");f.addEventListener("click",c.editCriterionDescription.bind(this));f.addEventListener("focusout",c.focusoutHandlerDisabled);var g=h.getNextElement(a,".result-r");if(g!=void 0){g.getAttribute("data-criterion-group");b.debug("Result row");b.debug(g);var i=_slicedToArray(g.children,2),j=i[0],k=i[1];b.debug(j);b.debug(k);b.debug(k.querySelector(".total-input"));k.querySelector(".total-input").addEventListener("blur",c.validateTotal)}};i.prototype.moveCriterionUp=function(a){b.debug("moveCriterionUp");var c=a.getAttribute("data-criterion-group"),d=h.getPreviousElement(a,".criterion-header"),e=Array.from(document.querySelectorAll("[data-criterion-group='".concat(c,"']"))),f=0==d.rowIndex?!0:!1,g=h.getNextElement(document.querySelector("[data-criterion-group='".concat(c,"']")),".criterion-header"),i=this.getCriteriaJSON();b.debug("criterioncollection");b.debug(i);var j=i.filter(function(a){if(c==a.id){return a}},c),k=d.getAttribute("data-criterion-group"),l=i.filter(function(a){if(k==a.id){return a}},k),m=j[0].rowindex;j[0].rowindex=l[0].rowindex;l[0].rowindex=m;if(f){e[0].children[0].children[0].setAttribute("hidden",!0);d.children[0].children[0].removeAttribute("hidden")}if(!f&&!g){e[0].children[0].children[0].removeAttribute("hidden");e[0].children[0].children[4].removeAttribute("hidden")}if(!g){d.children[0].children[4].setAttribute("hidden",!0)}try{for(var n=0,o=e,p;n<o.length;n++){p=o[n];d.parentNode.insertBefore(p,d)}}catch(a){b.debug(a)}};i.prototype.moveCriterionDown=function(a){b.debug("moveCriterionDown");var c=a.getAttribute("data-criterion-group"),d=document.querySelector("[data-criterion-group='".concat(c,"']")),e=0==d.rowIndex?!0:!1,f=Array.from(document.querySelectorAll("[data-criterion-group='".concat(c,"']"))),g=h.getNextElement(d,".criterion-header"),i=h.getNextElement(d,".criterion-header"),j=!e&&i!=void 0;b.debug("firstCriterion",e);b.debug("notlastCriterion",i);b.debug("inBetween",j);g=g.getAttribute("data-criterion-group");g=Array.from(document.querySelectorAll("[data-criterion-group='".concat(g,"']")));if(e){g[0].children[0].children[0].setAttribute("hidden",!0);g[0].children[0].children[4].removeAttribute("hidden");if(!h.getNextElement(g,".criterion-header")){f[0].children[0].children[4].setAttribute("hidden",!0)}}if(e&&i!=void 0){f[0].children[0].children[0].removeAttribute("hidden")}if(j){g[0].children[0].children[0].removeAttribute("hidden");g[0].children[0].children[4].removeAttribute("hidden");if(!h.getNextElement(g,".criterion-header")){f[0].children[0].children[4].setAttribute("hidden",!0)}}if(i==void 0){f[0].children[0].children[0].removeAttribute("hidden");f[0].children[0].children[4].setAttribute("hidden",!0)}if(j&&i==void 0){g[0].children[0].children[4].removeAttribute("hidden")}try{var k=_createForOfIteratorHelper(g),l;try{for(k.s();!(l=k.n()).done;){var m=l.value;d.parentNode.insertBefore(m,d)}}catch(a){k.e(a)}finally{k.f()}}catch(a){b.debug(a)}};i.prototype.addLevel=function(a){b.debug("addLevel");var d=this,e=h.getRandomID(),f={score:"Click to edit Mark",definition:"Click to edit Level description",criteriongroupid:a.getAttribute("data-criterion-group"),id:e};c.render(d.LEVEL_ROW,f).done(function(b){var c,f=".level-".concat(a.getAttribute("data-criterion-group")),i=h.getNextElement(a,".criterion-header");if(i!=void 0){var l=h.getPreviousElement(i,".result-r");c=h.getPreviousElement(l,f);if(c==void 0){c=a}}else{var m=h.getNextElement(a,".result-r");c=h.getPreviousElement(m,f);if(c==void 0){c=a}}c.insertAdjacentHTML("afterend",b);var j=h.getCriteriaJSON(),k=h.getCriterionFromCriteriaCollection(a,j);k[0].levels.push({score:0,status:"NEW",id:e,descriptors:[]});h.setCriteriaJSON(j);g.init(e,d.id)}).fail(function(a){b.debug("error...");b.debug(a)})};i.prototype.removeCriterion=function(a){b.debug("remove...");e.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletecriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(c){f.confirm(c[0],c[1],c[2],c[3],function(){var c=document.getElementById("criteriaTable"),d=a.target.parentNode.parentNode.parentNode.parentNode.rowIndex,e=a.target.parentNode.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),f=JSON.parse(document.getElementById("id_criteria").value),g=f.filter(function(a,b){var c=this.getAttribute("data-criterion-group");a.rowindex=b;if(c==a.id){return a}},a.target.parentNode.parentNode.parentNode.parentNode);b.debug("TO DELETE");g[0].status="DELETE";var h=g[0].levels;b.debug(h);for(var k=0;k<h.length;k++){h[k].status="DELETE"}document.getElementById("id_criteria").value=JSON.stringify(f);for(var j=d+1;j<c.rows.length;j++){if(c.rows[j].getAttribute("data-criterion-group")==e){c.rows[j].classList.add("to-remove")}else{break}}(function(a){var b=document.getElementsByClassName(a);while(0<b.length){b[0].parentNode.removeChild(b[0])}})("to-remove");c.deleteRow(d)},function(){})})};i.prototype.copyCriterion=function(){b.debug("copyCriterion")};i.prototype.editCriterionDescription=function(a){a.stopPropagation();b.debug("edit criterion description");var c=a.target;if("Click to edit criterion"==c.innerHTML){c.innerHTML=""}c.removeAttribute("disabled");c.focus();c.addEventListener("change",this.changeCriterionHandlerDisabled.bind(this))};i.prototype.focusoutHandlerDisabled=function(a){b.debug("focusoutHandlerDisabled");b.debug(this);if(""==a.target.innerHTML){a.target.innerHTML="Click to edit criterion"}a.target.setAttribute("disabled",!0)};i.prototype.changeCriterionHandlerDisabled=function(a){b.debug("changeCriterionHandlerDisabled");b.debug(a);var c=document.getElementById("id_criteria").value?JSON.parse(document.getElementById("id_criteria").value):[],d=c.filter(function(b,c){var d=a.target.parentNode.parentNode.getAttribute("data-criterion-group");b.rowindex=c;if(d==b.id){return b}},a);b.debug(d);if(d[0].description!=a.target.value&&"edit"==h.getMode()){d[0].status="UPDATE"}d[0].description=a.target.value;document.getElementById("id_criteria").value=JSON.stringify(c)};i.prototype.getCriteriaJSON=function(){return document.getElementById("id_criteria").value?JSON.parse(document.getElementById("id_criteria").value):[]};i.prototype.validateTotal=function(a){a.target.classList.remove("total-input-error");a.target.removeAttribute("data-toggle");a.target.removeAttribute("data-placement");a.target.removeAttribute("data-title");var c=a.target.valueAsNumber,d=a.target.getAttribute("min"),e=a.target.getAttribute("max");if(c!=NaN&&(c<d||c>e)){a.target.classList.add("total-input-error");a.target.setAttribute("data-toggle","tooltip");a.target.setAttribute("data-placement","right");a.target.setAttribute("data-title","Value out of range")}else{var f=h.getCriteriaJSON(),g=h.getCriterionFromCriteriaCollection(a.target.parentNode.parentNode.parentNode,f);b.debug(g);g[0].sumscore=c;h.setCriteriaJSON(f)}};return{init:function(a){b.debug("Criterion control...");b.debug(a);var c=h.getMode(),d=new i(c,a);d.main()}}});
//# sourceMappingURL=criterion_control.min.js.map
