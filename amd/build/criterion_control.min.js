function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}
/**
 * @package   gradingform_frubric
 * @copyright 2021 Veronica Bermegui
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}define("gradingform_frubric/criterion_control",["core/log","core/templates","core/str","core/notification","gradingform_frubric/level_control","gradingform_frubric/feditor_helper"],(function(Log,Templates,Str,Notification,LevelControl,FeditorHelper){function CriterionControl(mode,id){this.LEVEL_ROW="gradingform_frubric/editor_level_row",this.mode=mode,this.id=id}return CriterionControl.prototype.main=function(){var currentRow=document.getElementById(this.id);if("edit"==this.mode)try{this.setupEvents(currentRow),currentRow.getAttribute("data-criterion-group"),LevelControl.init(this.id)}catch(error){Log.debug(error)}else this.setupEvents(currentRow)},CriterionControl.prototype.setupEvents=function(currentRow){var actions=currentRow.querySelector(".act"),addLevelRow=FeditorHelper.getNextElement(currentRow,".add-level-r");if(actions){actions.children[0].addEventListener("click",this.removeCriterion.bind(currentRow)),addLevelRow.children[0].addEventListener("click",this.addLevel.bind(this,currentRow));var description=currentRow.querySelector(".crit-desc");description.addEventListener("click",this.editCriterionDescription.bind(this)),description.addEventListener("focusout",this.focusoutHandlerDisabled);var resultRow=FeditorHelper.getNextElement(currentRow,".result-r");if(null!=resultRow){var _resultRow$children=_slicedToArray(resultRow.children,2);_resultRow$children[0];_resultRow$children[1].querySelector(".total-input").addEventListener("blur",this.validateTotal)}}},CriterionControl.prototype.addLevel=function(row){var self=this,randomid=FeditorHelper.getRandomID(),context={score:"Click to edit Mark",definition:"Click to edit Level description",criteriongroupid:row.getAttribute("data-criterion-group"),id:randomid};Templates.render(self.LEVEL_ROW,context).done((function(html,js){var prevlevel,classname=".level-".concat(row.getAttribute("data-criterion-group")),nextCriterion=FeditorHelper.getNextElement(row,".criterion-header");if(null!=nextCriterion){var prevresultlevel=FeditorHelper.getPreviousElement(nextCriterion,".result-r");null==(prevlevel=FeditorHelper.getPreviousElement(prevresultlevel,classname))&&(prevlevel=row)}else{var resultrow=FeditorHelper.getNextElement(row,".result-r");null==(prevlevel=FeditorHelper.getPreviousElement(resultrow,classname))&&(prevlevel=row),prevlevel.classList.contains("is-invalid")&&(prevlevel.classList.remove("is-invalid"),prevlevel.classList.remove("form-control"))}prevlevel.insertAdjacentHTML("beforebegin",html);var levelObject={score:0,status:"NEW",id:randomid,descriptors:[]},criterioncollection=FeditorHelper.getCriteriaJSON();FeditorHelper.getCriterionFromCriteriaCollection(row,criterioncollection)[0].levels.push(levelObject),FeditorHelper.setCriteriaJSON(criterioncollection),FeditorHelper.setHiddenCriteriaJSON(criterioncollection),LevelControl.init(randomid,self.id)})).fail((function(ex){Log.debug("error..."),Log.debug(ex)}))},CriterionControl.prototype.removeCriterion=function(row){Str.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletecriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done((function(strs){Notification.confirm(strs[0],strs[1],strs[2],strs[3],(function(){var criTable=document.getElementById("criteriaTable"),criterionToDelete=row.target.parentNode.parentNode.parentNode.parentNode.rowIndex,criteariaID=row.target.parentNode.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),frc=FeditorHelper.getCriteriaJSON(),frctodel=frc.filter((function(criterion,index){var criteariaID=this.getAttribute("data-criterion-group");if(criterion.rowindex=index,criteariaID==criterion.id)return criterion}),row.target.parentNode.parentNode.parentNode.parentNode);frctodel[0].status="DELETE";for(var levels=frctodel[0].levels,j=0;j<levels.length;j++)levels[j].status="DELETE";if("new"in frctodel[0]){var postodel=frctodel[0].id-1;frc.splice(postodel,1)}FeditorHelper.setCriteriaJSON(frc),FeditorHelper.setHiddenCriteriaJSON(frc);for(var i=criterionToDelete+1;i<criTable.rows.length&&criTable.rows[i].getAttribute("data-criterion-group")==criteariaID;i++)criTable.rows[i].classList.add("to-remove");!function(className){var elements=document.getElementsByClassName(className);for(;elements.length>0;)elements[0].parentNode.removeChild(elements[0])}("to-remove"),criTable.deleteRow(criterionToDelete)}),(function(){}))}))},CriterionControl.prototype.editCriterionDescription=function(e){e.stopPropagation();var textarea=e.target;textarea.removeAttribute("disabled"),textarea.focus(),textarea.addEventListener("change",this.changeCriterionHandlerDisabled.bind(this))},CriterionControl.prototype.focusoutHandlerDisabled=function(e){e.target.setAttribute("disabled",!0)},CriterionControl.prototype.changeCriterionHandlerDisabled=function(e){var criterioncollection=document.getElementById("id_criteria").value?FeditorHelper.getCriteriaJSON():[],filterCriterion=criterioncollection.filter((function(criterion,index){var id=e.target.parentNode.parentNode.getAttribute("data-criterion-group");if(criterion.rowindex=index,id==criterion.id)return criterion}),e);filterCriterion[0].description==e.target.value||"edit"!=FeditorHelper.getMode()||filterCriterion[0].cid.includes("frubric-criteria-NEWID")||(filterCriterion[0].status="UPDATE"),filterCriterion[0].description=e.target.value,FeditorHelper.setCriteriaJSON(criterioncollection),FeditorHelper.setHiddenCriteriaJSON(criterioncollection),e.target.classList.contains("is-invalid")&&(e.target.classList.remove("is-invalid"),e.target.classList.remove("form-control"),e.target.removeAttribute("title"))},CriterionControl.prototype.validateTotal=function(e){e.target.classList.remove("total-input-error"),e.target.removeAttribute("data-toggle"),e.target.removeAttribute("data-placement"),e.target.removeAttribute("data-title");var inputvalue=e.target.valueAsNumber,min=e.target.getAttribute("min"),max=e.target.getAttribute("max");if(NaN!=inputvalue&&(inputvalue<min||inputvalue>max))e.target.classList.add("total-input-error"),e.target.setAttribute("data-toggle","tooltip"),e.target.setAttribute("data-placement","right"),e.target.setAttribute("data-title","Value out of range");else{var criteria=FeditorHelper.getCriteriaJSON();FeditorHelper.getCriterionFromCriteriaCollection(e.target.parentNode.parentNode.parentNode,criteria)[0].sumscore=inputvalue,FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)}},{init:function(id){new CriterionControl(FeditorHelper.getMode(),id).main()}}}));

//# sourceMappingURL=criterion_control.min.js.map