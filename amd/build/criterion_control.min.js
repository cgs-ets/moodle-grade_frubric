define(["core/log","core/templates","core/str","core/notification","gradingform_frubric/level_control","gradingform_frubric/feditor_helper"],function(r,t,e,i,l,s){"use strict";function o(e,t){var r=this;r.LEVEL_ROW="gradingform_frubric/editor_level_row",r.mode=e,r.id=t}return o.prototype.main=function(){var e=this,t=document.getElementById(e.id);if("edit"==e.mode)try{e.setupEvents(t),t.getAttribute("data-criterion-group"),l.init(e.id)}catch(e){r.debug(e)}else e.setupEvents(t)},o.prototype.setupEvents=function(e){var t,r=this,i=e.querySelector(".act"),o=s.getNextElement(e,".add-level-r");i&&(i.children[0].addEventListener("click",r.removeCriterion.bind(e)),o.children[0].addEventListener("click",r.addLevel.bind(r,e)),e.querySelector(".crit-desc").addEventListener("click",r.editCriterionDescription.bind(this)),null!=(i=s.getNextElement(e,".result-r"))&&([t,o]=i.children,o.querySelector(".total-input").addEventListener("blur",r.validateTotal)),r.handleOutcomeSelect(e))},o.prototype.addLevel=function(n){let a=this;const d=s.getRandomID();var e={score:"Click to edit Mark",definition:"Click to edit Level description",criteriongroupid:n.getAttribute("data-criterion-group"),id:d};t.render(a.LEVEL_ROW,e).done(function(e,t){var r,i=".level-"+n.getAttribute("data-criterion-group"),o=s.getNextElement(n,".criterion-header"),o=(null!=o?(o=s.getPreviousElement(o,".result-r"),null==(r=s.getPreviousElement(o,i))&&(r=n)):(o=s.getNextElement(n,".result-r"),(r=null==(r=s.getPreviousElement(o,i))?n:r).classList.contains("is-invalid")&&(r.classList.remove("is-invalid"),r.classList.remove("form-control"))),r.insertAdjacentHTML("beforebegin",e),{score:0,status:"NEW",id:d,descriptors:[]}),i=s.getCriteriaJSON();s.getCriterionFromCriteriaCollection(n,i)[0].levels.push(o),s.setCriteriaJSON(i),s.setHiddenCriteriaJSON(i),l.init(d,a.id)}).fail(function(e){r.debug("error..."),r.debug(e)})},o.prototype.removeCriterion=function(d){e.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletecriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(e){i.confirm(e[0],e[1],e[2],e[3],function(){var t=document.getElementById("criteriaTable"),r=d.target.parentNode.parentNode.parentNode.parentNode.rowIndex,i=d.target.parentNode.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),e=s.getCriteriaJSON(),o=e.filter(function(e,t){var r=this.getAttribute("data-criterion-group");if(e.rowindex=t,r==e.id)return e},d.target.parentNode.parentNode.parentNode.parentNode),n=(o[0].status="DELETE",o[0].levels);for(let e=0;e<n.length;e++)n[e].status="DELETE";"new"in o[0]&&(o=o[0].id-1,e.splice(o,1)),s.setCriteriaJSON(e),s.setHiddenCriteriaJSON(e);for(let e=r+1;e<t.rows.length&&t.rows[e].getAttribute("data-criterion-group")==i;e++)t.rows[e].classList.add("to-remove");for(var o="to-remove",a=document.getElementsByClassName(o);0<a.length;)a[0].parentNode.removeChild(a[0]);t.deleteRow(r)},function(){})})},o.prototype.editCriterionDescription=function(e){e.stopPropagation();e=e.target;e.removeAttribute("disabled"),e.focus(),e.addEventListener("change",this.changeCriterionHandlerDisabled.bind(this))},o.prototype.focusoutHandlerDisabled=function(e){},o.prototype.changeCriterionHandlerDisabled=function(i){var e=document.getElementById("id_criteria").value?s.getCriteriaJSON():[],t=e.filter(function(e,t){var r=i.target.parentNode.parentNode.getAttribute("data-criterion-group");if(e.rowindex=t,r==e.id)return e},i);t[0].description==i.target.value||"edit"!=s.getMode()||t[0].cid.includes("frubric-criteria-NEWID")||(t[0].status="UPDATE"),t[0].description=i.target.value,s.setCriteriaJSON(e),s.setHiddenCriteriaJSON(e),i.target.classList.contains("is-invalid")&&(i.target.classList.remove("is-invalid"),i.target.classList.remove("form-control"),i.target.removeAttribute("title"))},o.prototype.validateTotal=function(e){e.target.classList.remove("total-input-error"),e.target.removeAttribute("data-toggle"),e.target.removeAttribute("data-placement"),e.target.removeAttribute("data-title");var t=e.target.valueAsNumber,r=e.target.getAttribute("min"),i=e.target.getAttribute("max");NaN!=t&&(t<r||i<t)?(e.target.classList.add("total-input-error"),e.target.setAttribute("data-toggle","tooltip"),e.target.setAttribute("data-placement","right"),e.target.setAttribute("data-title","Value out of range")):(r=s.getCriteriaJSON(),s.getCriterionFromCriteriaCollection(e.target.parentNode.parentNode.parentNode,r)[0].sumscore=t,s.setCriteriaJSON(r),s.setHiddenCriteriaJSON(r))},o.prototype.handleOutcomeSelect=function(e){},{init:function(e){new o(s.getMode(),e).main()}}});