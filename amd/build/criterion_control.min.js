/**
 * @package   gradingform_frubric
 * @copyright 2021 Veronica Bermegui
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("gradingform_frubric/criterion_control",["core/log","core/templates","core/str","core/notification","gradingform_frubric/level_control","gradingform_frubric/feditor_helper"],(function(Log,Templates,Str,Notification,LevelControl,FeditorHelper){function CriterionControl(mode,id){this.LEVEL_ROW="gradingform_frubric/editor_level_row",this.mode=mode,this.id=id}return CriterionControl.prototype.main=function(){let self=this;const currentRow=document.getElementById(self.id);if("edit"==self.mode)try{self.setupEvents(currentRow),currentRow.getAttribute("data-criterion-group"),LevelControl.init(self.id)}catch(error){Log.debug(error)}else self.setupEvents(currentRow)},CriterionControl.prototype.setupEvents=function(currentRow){let self=this;const actions=currentRow.querySelector(".act"),addLevelRow=FeditorHelper.getNextElement(currentRow,".add-level-r");if(!actions)return;actions.children[0].addEventListener("click",self.removeCriterion.bind(currentRow)),addLevelRow.children[0].addEventListener("click",self.addLevel.bind(self,currentRow));const description=currentRow.querySelector(".crit-desc");description.addEventListener("click",self.editCriterionDescription.bind(this)),description.addEventListener("focusout",self.focusoutHandlerDisabled);const resultRow=FeditorHelper.getNextElement(currentRow,".result-r");if(null!=resultRow){const[criterionTitletd,criterionTotaltd]=resultRow.children;criterionTotaltd.querySelector(".total-input").addEventListener("blur",self.validateTotal)}},CriterionControl.prototype.addLevel=function(row){let self=this;const randomid=FeditorHelper.getRandomID(),context={score:"Click to edit Mark",definition:"Click to edit Level description",criteriongroupid:row.getAttribute("data-criterion-group"),id:randomid};Templates.render(self.LEVEL_ROW,context).done((function(html,js){var prevlevel;const classname=".level-".concat(row.getAttribute("data-criterion-group"));let nextCriterion=FeditorHelper.getNextElement(row,".criterion-header");if(null!=nextCriterion){const prevresultlevel=FeditorHelper.getPreviousElement(nextCriterion,".result-r");null==(prevlevel=FeditorHelper.getPreviousElement(prevresultlevel,classname))&&(prevlevel=row)}else{const resultrow=FeditorHelper.getNextElement(row,".result-r");null==(prevlevel=FeditorHelper.getPreviousElement(resultrow,classname))&&(prevlevel=row),prevlevel.classList.contains("is-invalid")&&(prevlevel.classList.remove("is-invalid"),prevlevel.classList.remove("form-control"))}prevlevel.insertAdjacentHTML("beforebegin",html);const levelObject={score:0,status:"NEW",id:randomid,descriptors:[]},criterioncollection=FeditorHelper.getCriteriaJSON();FeditorHelper.getCriterionFromCriteriaCollection(row,criterioncollection)[0].levels.push(levelObject),FeditorHelper.setCriteriaJSON(criterioncollection),FeditorHelper.setHiddenCriteriaJSON(criterioncollection),LevelControl.init(randomid,self.id)})).fail((function(ex){Log.debug("error..."),Log.debug(ex)}))},CriterionControl.prototype.removeCriterion=function(row){Str.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletecriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done((function(strs){Notification.confirm(strs[0],strs[1],strs[2],strs[3],(function(){let criTable=document.getElementById("criteriaTable"),criterionToDelete=row.target.parentNode.parentNode.parentNode.parentNode.rowIndex;const criteariaID=row.target.parentNode.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");let frc=FeditorHelper.getCriteriaJSON();const frctodel=frc.filter((function(criterion,index){const criteariaID=this.getAttribute("data-criterion-group");if(criterion.rowindex=index,criteariaID==criterion.id)return criterion}),row.target.parentNode.parentNode.parentNode.parentNode);frctodel[0].status="DELETE";const levels=frctodel[0].levels;for(let j=0;j<levels.length;j++)levels[j].status="DELETE";if("new"in frctodel[0]){const postodel=frctodel[0].id-1;frc.splice(postodel,1)}FeditorHelper.setCriteriaJSON(frc),FeditorHelper.setHiddenCriteriaJSON(frc);for(let i=criterionToDelete+1;i<criTable.rows.length&&criTable.rows[i].getAttribute("data-criterion-group")==criteariaID;i++)criTable.rows[i].classList.add("to-remove");!function(className){var elements=document.getElementsByClassName(className);for(;elements.length>0;)elements[0].parentNode.removeChild(elements[0])}("to-remove"),criTable.deleteRow(criterionToDelete)}),(function(){}))}))},CriterionControl.prototype.editCriterionDescription=function(e){e.stopPropagation();let textarea=e.target;textarea.removeAttribute("disabled"),textarea.focus(),textarea.addEventListener("change",this.changeCriterionHandlerDisabled.bind(this))},CriterionControl.prototype.focusoutHandlerDisabled=function(e){e.target.setAttribute("disabled",!0)},CriterionControl.prototype.changeCriterionHandlerDisabled=function(e){const criterioncollection=document.getElementById("id_criteria").value?FeditorHelper.getCriteriaJSON():[],filterCriterion=criterioncollection.filter((function(criterion,index){const id=e.target.parentNode.parentNode.getAttribute("data-criterion-group");if(criterion.rowindex=index,id==criterion.id)return criterion}),e);filterCriterion[0].description==e.target.value||"edit"!=FeditorHelper.getMode()||filterCriterion[0].cid.includes("frubric-criteria-NEWID")||(filterCriterion[0].status="UPDATE"),filterCriterion[0].description=e.target.value,FeditorHelper.setCriteriaJSON(criterioncollection),FeditorHelper.setHiddenCriteriaJSON(criterioncollection),e.target.classList.contains("is-invalid")&&(e.target.classList.remove("is-invalid"),e.target.classList.remove("form-control"),e.target.removeAttribute("title"))},CriterionControl.prototype.validateTotal=function(e){e.target.classList.remove("total-input-error"),e.target.removeAttribute("data-toggle"),e.target.removeAttribute("data-placement"),e.target.removeAttribute("data-title");const inputvalue=e.target.valueAsNumber,min=e.target.getAttribute("min"),max=e.target.getAttribute("max");if(NaN!=inputvalue&&(inputvalue<min||inputvalue>max))e.target.classList.add("total-input-error"),e.target.setAttribute("data-toggle","tooltip"),e.target.setAttribute("data-placement","right"),e.target.setAttribute("data-title","Value out of range");else{const criteria=FeditorHelper.getCriteriaJSON();FeditorHelper.getCriterionFromCriteriaCollection(e.target.parentNode.parentNode.parentNode,criteria)[0].sumscore=inputvalue,FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)}},{init:function(id){new CriterionControl(FeditorHelper.getMode(),id).main()}}}));

//# sourceMappingURL=criterion_control.min.js.map