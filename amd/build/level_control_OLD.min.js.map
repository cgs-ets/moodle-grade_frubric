{"version":3,"sources":["../src/level_control_OLD.js"],"names":["define","$","Log","Str","Notification","FeditorHelper","LevelControl","level","mode","self","prototype","main","debug","setupEvents","children","del","markandesc","markdescontainer","addEventListener","deleteLevel","bind","editlevelhandler","e","get_strings","key","component","done","strs","confirm","criTable","document","getElementById","tr","target","parentNode","criterion","getPreviousElement","criteria","JSON","parse","value","getAttribute","length","dbids","index","getDistanceFromCriterionHeader","dblevelid","crid","levels","i","id","status","j","dbid","stringify","deleteRow","rowIndex","textarea","innerHTML","removeAttribute","focus","changeLevelHandlerDisabled","focusoutHandlerDisabled","txtarea","levelrow","criterionheader","leveldbids","criteriaJSON","getCriteriaJSON","levelid","filterCriterion","filter","rowindex","lev","critlevs","classList","contains","score","definition","criterionLevel","push","getMode","cid","includes","setAttribute","init","control"],"mappings":"+qCAsBAA,OAAM,yCAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,UAAvB,CAAmC,mBAAnC,CAAwD,oCAAxD,CAAD,CACJ,SAAUC,CAAV,CAAaC,CAAb,CAAkBC,CAAlB,CAAuBC,CAAvB,CAAqCC,CAArC,CAAoD,CAClD,aAiBA,QAASC,CAAAA,CAAT,CAAsBC,CAAtB,CAA6BC,CAA7B,CAAmC,CACjC,GAAMC,CAAAA,CAAI,CAAG,IAAb,CACAA,CAAI,CAACF,KAAL,CAAaA,CAAb,CACAE,CAAI,CAACD,IAAL,CAAYA,CACb,CAKDF,CAAY,CAACI,SAAb,CAAuBC,IAAvB,CAA8B,UAAY,CACxC,GAAIF,CAAAA,CAAI,CAAG,IAAX,CACAP,CAAG,CAACU,KAAJ,CAAU,MAAV,EACAV,CAAG,CAACU,KAAJ,CAAUH,CAAV,EAEAA,CAAI,CAACI,WAAL,CAAiBJ,CAAI,CAACF,KAAtB,CAED,CAPD,CASAD,CAAY,CAACI,SAAb,CAAuBG,WAAvB,CAAqC,SAAUN,CAAV,CAAiB,CACpD,GAAIE,CAAAA,CAAI,CAAG,IAAX,CACAP,CAAG,CAACU,KAAJ,CAAU,4BAAV,EAFoD,qBAG1BL,CAAK,CAACO,QAHoB,IAG7CC,CAH6C,MAGxCC,CAHwC,MAIpDd,CAAG,CAACU,KAAJ,CAAUI,CAAV,EACA,GAAMC,CAAAA,CAAgB,CAAID,CAAU,CAACF,QAAX,CAAoB,CAApB,CAA1B,CACAC,CAAG,CAACG,gBAAJ,CAAqB,OAArB,CAA8B,KAAKC,WAAL,CAAiBC,IAAjB,CAAsBX,CAAtB,CAA9B,EACAQ,CAAgB,CAACC,gBAAjB,CAAkC,OAAlC,CAA2C,KAAKG,gBAAL,CAAsBD,IAAtB,CAA2BX,CAA3B,CAA3C,CAED,CATD,CAWAH,CAAY,CAACI,SAAb,CAAuBS,WAAvB,CAAqC,SAAUG,CAAV,CAAa,CAChDpB,CAAG,CAACU,KAAJ,CAAU,aAAV,EACAV,CAAG,CAACU,KAAJ,CAAUU,CAAV,EAEAnB,CAAG,CAACoB,WAAJ,CAAgB,CAAC,CACbC,GAAG,CAAE,SADQ,CAEbC,SAAS,CAAE,qBAFE,CAAD,CAId,CACED,GAAG,CAAE,oBADP,CAEEC,SAAS,CAAE,qBAFb,CAJc,CAQd,CACED,GAAG,CAAE,KADP,CARc,CAWd,CACEA,GAAG,CAAE,IADP,CAXc,CAAhB,EAeGE,IAfH,CAeQ,SAAUC,CAAV,CAAgB,CACtBvB,CAAY,CAACwB,OAAb,CAAqBD,CAAI,CAAC,CAAD,CAAzB,CAA8BA,CAAI,CAAC,CAAD,CAAlC,CAAuCA,CAAI,CAAC,CAAD,CAA3C,CAAgDA,CAAI,CAAC,CAAD,CAApD,CAAyD,UAAY,IAC/DE,CAAAA,CAAQ,CAAGC,QAAQ,CAACC,cAAT,CAAwB,eAAxB,CADoD,CAE7DC,CAAE,CAAGV,CAAC,CAACW,MAAF,CAASC,UAAT,CAAoBA,UAApB,CAA+BA,UAFyB,CAG7DC,CAAS,CAAG9B,CAAa,CAAC+B,kBAAd,CAAiCJ,CAAjC,CAAqC,mBAArC,CAHiD,CAI/DK,CAAQ,CAAGC,IAAI,CAACC,KAAL,CAAWT,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCS,KAAlD,CAJoD,CAMnE,GAA6D,CAAzD,CAAAL,CAAS,CAACM,YAAV,CAAuB,uBAAvB,EAAgDC,MAApD,CAAgE,CAQ9D,OANMC,CAAAA,CAAK,CAAGL,IAAI,CAACC,KAAL,CAAWJ,CAAS,CAACM,YAAV,CAAuB,uBAAvB,CAAX,CAMd,CALMG,CAAK,CAAGvC,CAAa,CAACwC,8BAAd,CAA6Cb,CAA7C,CAAiD,mBAAjD,CAKd,CAJMc,CAAS,CAAGH,CAAK,CAACC,CAAD,CAIvB,CAHMG,CAAI,CAAGf,CAAE,CAACS,YAAH,CAAgB,sBAAhB,CAGb,CADIO,CACJ,CAASC,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGZ,CAAQ,CAACK,MAA7B,CAAqCO,CAAC,EAAtC,CAA0C,CACxC,GAAIZ,CAAQ,CAACY,CAAD,CAAR,CAAYC,EAAZ,EAAkBH,CAAtB,CAA4B,CAC1B7C,CAAG,CAACU,KAAJ,CAAU,UAAV,EACAyB,CAAQ,CAACY,CAAD,CAAR,CAAYE,MAAZ,CAAqB,QAArB,CACAH,CAAM,CAAGX,CAAQ,CAACY,CAAD,CAAR,CAAYD,MAArB,CACA,KACD,CACF,CAED,IAAK,GAAII,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGJ,CAAM,CAACN,MAA3B,CAAmCU,CAAC,EAApC,CAAwC,CACtC,GAAIJ,CAAM,CAACI,CAAD,CAAN,CAAUC,IAAV,EAAkBP,CAAtB,CAAiC,CAC/BE,CAAM,CAACI,CAAD,CAAN,CAAUD,MAAV,CAAmB,QAAnB,CACA,KACD,CACF,CAEF,CAGDrB,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCS,KAAvC,CAA+CF,IAAI,CAACgB,SAAL,CAAejB,CAAf,CAA/C,CACAR,CAAQ,CAAC0B,SAAT,CAAmBvB,CAAE,CAACwB,QAAtB,CAED,CApCD,CAoCG,UAAY,CAGd,CAvCD,CAwCD,CAxDD,CAyDC,CA7DH,CA+DAlD,CAAY,CAACI,SAAb,CAAuBW,gBAAvB,CAA0C,SAAUC,CAAV,CAAa,CACrDpB,CAAG,CAACU,KAAJ,CAAU,kBAAV,EACAV,CAAG,CAACU,KAAJ,CAAUU,CAAV,EACApB,CAAG,CAACU,KAAJ,CAAU,IAAV,EACA,GAAI6C,CAAAA,CAAQ,CAAGnC,CAAC,CAACW,MAAjB,CAEA,GAA0B,iCAAtB,EAAAwB,CAAQ,CAACC,SAAT,EAAiF,oBAAtB,EAAAD,CAAQ,CAACC,SAAxE,CAA2G,CACzGD,CAAQ,CAACC,SAAT,CAAqB,EACtB,CAEDD,CAAQ,CAACE,eAAT,CAAyB,UAAzB,EACAF,CAAQ,CAACG,KAAT,GACAH,CAAQ,CAACvC,gBAAT,CAA0B,QAA1B,CAAoC,KAAK2C,0BAAL,CAAgCzC,IAAhC,CAAqC,IAArC,CAA2CqC,CAA3C,CAApC,EACAA,CAAQ,CAACvC,gBAAT,CAA0B,UAA1B,CAAsC,KAAK4C,uBAA3C,CACD,CAdD,CAgBAxD,CAAY,CAACI,SAAb,CAAuBmD,0BAAvB,CAAoD,SAAUE,CAAV,CAAmBzC,CAAnB,CAAsB,CACxEpB,CAAG,CAACU,KAAJ,CAAU,4BAAV,EADwE,GAGpEsC,CAAAA,CAAE,CAAG5B,CAAC,CAACW,MAAF,CAASC,UAAT,CAAoBA,UAApB,CAA+BA,UAA/B,CAA0CO,YAA1C,CAAuD,sBAAvD,CAH+D,CAIlEuB,CAAQ,CAAG1C,CAAC,CAACW,MAAF,CAASC,UAAT,CAAoBA,UAApB,CAA+BA,UAJwB,CAMlE+B,CAAe,CAAG5D,CAAa,CAAC+B,kBAAd,CAAiC4B,CAAjC,CAA2C,mBAA3C,CANgD,CAOpEE,CAAU,CAAkE,CAA/D,CAAAD,CAAe,CAACxB,YAAhB,CAA6B,uBAA7B,EAAsDC,MAAtD,CAAmEJ,IAAI,CAACC,KAAL,CAAW0B,CAAe,CAACxB,YAAhB,CAA6B,uBAA7B,CAAX,CAAnE,CAAuI,EAPhF,CASlE0B,CAAY,CAAG9D,CAAa,CAAC+D,eAAd,EATmD,CAUlEZ,CAAQ,CAAGlC,CAAC,CAACW,MAAF,CAASC,UAAT,CAAoBA,UAApB,CAA+BA,UAA/B,CAA0CsB,QAVa,CAYpEa,CAAO,CAAGnB,CAAE,CAAG,GAAL,CAAWM,CAZ+C,CAcxE,GAAuB,CAApB,CAAAU,CAAU,CAACxB,MAAd,CAA0B,CACxB2B,CAAO,CAAIH,CAAU,CAACV,CAAQ,CAAG,CAAZ,CAAV,QAAD,WAA8CN,CAA9C,aAAoDgB,CAAU,CAACV,CAAQ,CAAG,CAAZ,CAA9D,EAAiFa,CAC5F,CAED,GAAMC,CAAAA,CAAe,CAAGH,CAAY,CAACI,MAAb,CAAoB,SAAUpC,CAAV,CAAqBS,CAArB,CAA4B,CACtE,GAAMM,CAAAA,CAAE,CAAG5B,CAAC,CAACW,MAAF,CAASC,UAAT,CAAoBA,UAApB,CAA+BA,UAA/B,CAA0CO,YAA1C,CAAuD,sBAAvD,CAAX,CACAN,CAAS,CAACqC,QAAV,CAAqB5B,CAArB,CACA,GAAIM,CAAE,EAAIf,CAAS,CAACe,EAApB,CAAwB,CACtB,MAAOf,CAAAA,CACR,CACF,CANuB,CAMrBb,CANqB,CAAxB,CASA,GAAIgD,CAAe,CAAC,CAAD,CAAf,CAAmBtB,MAAnB,QAAJ,CAA4C,CAI1C,OAHIyB,CAAAA,CAAG,CAAG,IAGV,CAFMC,CAAQ,CAAGJ,CAAe,CAAC,CAAD,CAAf,CAAmBtB,MAEpC,CAASC,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGyB,CAAQ,CAAChC,MAA7B,CAAqCO,CAAC,EAAtC,CAA0C,CAExC,GAAKyB,CAAQ,CAACzB,CAAD,CAAT,CAAcC,EAAd,EAAoBmB,CAAxB,CAAiC,CAC/B,QACD,CAFD,IAEO,CACLI,CAAG,CAAGC,CAAQ,CAACzB,CAAD,CAAd,CACA,KAED,CACF,CAED,GAAW,IAAP,EAAAwB,CAAJ,CAAiB,CACf,GAAInD,CAAC,CAACW,MAAF,CAAS0C,SAAT,CAAmBC,QAAnB,CAA4B,cAA5B,CAAJ,CAAiD,CAC/CH,CAAG,CAACI,KAAJ,CAAYvD,CAAC,CAACW,MAAF,CAASO,KACtB,CAFD,IAEO,CACLiC,CAAG,CAACK,UAAJ,CAAiBxD,CAAC,CAACW,MAAF,CAASO,KAC3B,CACD,GAAkB,SAAd,EAAAiC,CAAG,CAACtB,MAAJ,EAAyC,SAAd,EAAAsB,CAAG,CAACtB,MAAnC,CAAwD,CACtDsB,CAAG,CAACtB,MAAJ,CAAa,QACd,CAEF,CAVD,IAUO,CAEL,GAAI4B,CAAAA,CAAc,CAAG,CACnB7B,EAAE,CAAEmB,CADe,CAEnBlB,MAAM,CAAE,KAFW,CAGnB0B,KAAK,CAAE,EAHY,CAInBC,UAAU,CAAE,EAJO,CAArB,CAOA,GAAIxD,CAAC,CAACW,MAAF,CAAS0C,SAAT,CAAmBC,QAAnB,CAA4B,cAA5B,CAAJ,CAAiD,CAC/CG,CAAc,CAACF,KAAf,CAAuBvD,CAAC,CAACW,MAAF,CAASO,KACjC,CAFD,IAEO,CACLuC,CAAc,CAACD,UAAf,CAA4BxD,CAAC,CAACW,MAAF,CAASO,KACtC,CACA8B,CAAe,CAAC,CAAD,CAAhB,CAAqBtB,MAArB,CAA4BgC,IAA5B,CAAiCD,CAAjC,CACD,CAED,GAA+B,MAA3B,EAAA1E,CAAa,CAAC4E,OAAd,EAAJ,CAAuC,CAErC,GAAI,IAAAX,CAAe,CAAC,CAAD,CAAf,CAAmBY,GAAnB,CAAuBC,QAAvB,CAAgC,OAAhC,CAAJ,CAAsD,CACpDb,CAAe,CAAC,CAAD,CAAf,CAAmBnB,MAAnB,CAA4B,QAC7B,CAFD,IAEO,CACLmB,CAAe,CAAC,CAAD,CAAf,CAAmBnB,MAAnB,CAA4B,KAC7B,CACF,CAEF,CAEDrB,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCS,KAAvC,CAA+CF,IAAI,CAACgB,SAAL,CAAea,CAAf,CAA/C,CAGA7C,CAAC,CAACW,MAAF,CAASmD,YAAT,CAAsB,UAAtB,IACD,CApFD,CAsFA9E,CAAY,CAACI,SAAb,CAAuBoD,uBAAvB,CAAiD,SAASxC,CAAT,CAAY,CAC3DpB,CAAG,CAACU,KAAJ,CAAU,yBAAV,EACAU,CAAC,CAACW,MAAF,CAASmD,YAAT,CAAsB,UAAtB,IACD,CAHD,CAMA,MAAO,CACLC,IAAI,CAxNN,SAAcnC,CAAd,CAAkB,CAChBhD,CAAG,CAACU,KAAJ,CAAU,kBAAV,EADgB,GAEVJ,CAAAA,CAAI,CAAGH,CAAa,CAAC4E,OAAd,EAFG,CAGV1E,CAAK,CAAIuB,QAAQ,CAACC,cAAT,CAAwBmB,CAAxB,CAHC,CAIZoC,CAAO,CAAG,GAAIhF,CAAAA,CAAJ,CAAiBC,CAAjB,CAAwBC,CAAxB,CAJE,CAKhB8E,CAAO,CAAC3E,IAAR,EAED,CAgNM,CAGR,CA9NG,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/str', 'core/notification', 'gradingform_frubric/feditor_helper'],\n  function ($, Log, Str, Notification, FeditorHelper) {\n    'use strict';\n\n    function init(id) {\n      Log.debug('Level control...');\n      const mode = FeditorHelper.getMode();\n      const level  = document.getElementById(id);\n      let control = new LevelControl(level, mode);\n      control.main();\n\n    }\n\n\n /**\n  *\n  * @param {*} level\n  * @param {*} mode\n  */\n    function LevelControl(level, mode) {\n      const self = this;\n      self.level = level;\n      self.mode = mode;\n    }\n\n    /**\n     * Run the controller.\n     */\n    LevelControl.prototype.main = function () {\n      let self = this;\n      Log.debug(\"main\");\n      Log.debug(self);\n\n      self.setupEvents(self.level);\n\n    };\n\n    LevelControl.prototype.setupEvents = function (level) {\n      let self = this;\n      Log.debug(\"Level control: setupEvents\");\n      const [del, markandesc] = level.children;\n      Log.debug(markandesc);\n      const markdescontainer = (markandesc.children[0]); // The textareas are disabled so the event wont trigger. Attach the event to the div\n      del.addEventListener('click', this.deleteLevel.bind(self));\n      markdescontainer.addEventListener('click', this.editlevelhandler.bind(self));\n\n    };\n\n    LevelControl.prototype.deleteLevel = function (e) {\n      Log.debug('deleteLevel');\n      Log.debug(e);\n\n      Str.get_strings([{\n          key: 'confirm',\n          component: 'gradingform_frubric'\n        },\n        {\n          key: 'confirmdeletelevel',\n          component: 'gradingform_frubric'\n        },\n        {\n          key: 'yes'\n        },\n        {\n          key: 'no'\n        },\n\n      ]).done(function (strs) {\n        Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n          let criTable = document.getElementById('criteriaTable');\n          const tr = e.target.parentNode.parentNode.parentNode;\n          const criterion = FeditorHelper.getPreviousElement(tr, '.criterion-header');\n          let criteria = JSON.parse(document.getElementById('id_criteria').value);\n\n          if (criterion.getAttribute('data-criterion-levels').length > 0) {\n\n            const dbids = JSON.parse(criterion.getAttribute('data-criterion-levels')); // These are the ids of the levels given by the DB.\n            const index = FeditorHelper.getDistanceFromCriterionHeader(tr, '.criterion-header');\n            const dblevelid = dbids[index];\n            const crid = tr.getAttribute('data-criterion-group')\n\n            var levels;\n            for (let i = 0; i < criteria.length; i++) {\n              if (criteria[i].id == crid) {\n                Log.debug(\"en el if\");\n                criteria[i].status = 'UPDATE';\n                levels = criteria[i].levels;\n                break;\n              }\n            }\n\n            for (let j = 0; j < levels.length; j++) {\n              if (levels[j].dbid == dblevelid) {\n                levels[j].status = 'DELETE';\n                break;\n              }\n            }\n\n          }\n\n\n          document.getElementById('id_criteria').value = JSON.stringify(criteria);\n          criTable.deleteRow(tr.rowIndex); // span -> td -> tr.\n\n        }, function () {\n          // For the cancel btn.\n          return;\n        });\n      });\n      };\n\n    LevelControl.prototype.editlevelhandler = function (e) {\n      Log.debug('editlevelhandler');\n      Log.debug(e);\n      Log.debug(this);\n      let textarea = e.target;\n\n      if (textarea.innerHTML == 'Click to edit Level description' || textarea.innerHTML == 'Click to edit Mark') {\n        textarea.innerHTML = '';\n      }\n\n      textarea.removeAttribute('disabled');\n      textarea.focus();\n      textarea.addEventListener('change', this.changeLevelHandlerDisabled.bind(this, textarea));\n      textarea.addEventListener('focusout', this.focusoutHandlerDisabled);\n    };\n\n    LevelControl.prototype.changeLevelHandlerDisabled = function (txtarea, e) {\n      Log.debug('changeLevelHandlerDisabled');\n\n      let id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n      const levelrow = e.target.parentNode.parentNode.parentNode;\n      // Get the criterion row this level belongs to\n      const criterionheader = FeditorHelper.getPreviousElement(levelrow, '.criterion-header');\n      let leveldbids = criterionheader.getAttribute('data-criterion-levels').length > 0 ? JSON.parse(criterionheader.getAttribute('data-criterion-levels')) : []; // Get the dbids\n    \n      const criteriaJSON = FeditorHelper.getCriteriaJSON();\n      const rowIndex = e.target.parentNode.parentNode.parentNode.rowIndex;\n    \n      let levelid = id + '_' + rowIndex;\n \n      if(leveldbids.length > 0) {\n        levelid = (leveldbids[rowIndex - 1] != undefined)  ? `${id}_${leveldbids[rowIndex - 1]}` : levelid; // The criterion already exists but this is a new level, not saved in the DB yet.\n      } \n\n      const filterCriterion = criteriaJSON.filter(function (criterion, index) {\n        const id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n        criterion.rowindex = index;\n        if (id == criterion.id) {\n          return criterion;\n        }\n      }, e);\n\n      // Find the level and update the values\n      if (filterCriterion[0].levels != undefined) {\n        var lev = null;\n        const critlevs = filterCriterion[0].levels;\n\n        for (let i = 0; i < critlevs.length; i++) {\n\n          if ((critlevs[i]).id != levelid) {\n            continue;\n          } else {\n            lev = critlevs[i];\n            break;\n\n          }\n        }\n\n        if (lev != null) {\n          if (e.target.classList.contains('mark_txtarea')) {\n            lev.score = e.target.value;\n          } else {\n            lev.definition = e.target.value;\n          }\n          if (lev.status == 'CREATED' || lev.status == 'UPDATED') { // It was updated before. \n            lev.status = 'UPDATE';\n          }\n\n        } else {\n\n          let criterionLevel = {\n            id: levelid,\n            status: 'NEW',\n            score: '',\n            definition: ''\n          };\n\n          if (e.target.classList.contains('mark_txtarea')) {\n            criterionLevel.score = e.target.value;\n          } else {\n            criterionLevel.definition = e.target.value;\n          }\n          (filterCriterion[0]).levels.push(criterionLevel);\n        }\n\n        if (FeditorHelper.getMode() == 'edit') {\n\n          if (filterCriterion[0].cid.includes(\"NEWID\") != true) { // A new criterion added\n            filterCriterion[0].status = \"UPDATE\"; // The criterion was updated because it has new levels.\n          } else {\n            filterCriterion[0].status = \"NEW\"; \n          }\n        }\n\n      }\n\n      document.getElementById('id_criteria').value = JSON.stringify(criteriaJSON); // Criterionjson;\n\n\n      e.target.setAttribute('disabled', true);\n    };\n\n    LevelControl.prototype.focusoutHandlerDisabled = function(e) {\n      Log.debug('focusoutHandlerDisabled');\n      e.target.setAttribute('disabled', true);\n    };\n\n\n    return {\n      init: init\n    };\n  });"],"file":"level_control_OLD.min.js"}