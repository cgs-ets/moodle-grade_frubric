{"version":3,"file":"level_control.min.js","sources":["../src/level_control.js"],"sourcesContent":["/* eslint-disable no-eq-null */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/str', 'core/notification', 'gradingform_frubric/feditor_helper', 'core/templates'],\n    function ($, Log, Str, Notification, FeditorHelper, Templates) {\n        'use strict';\n        /**\n         *\n         * @param {*} id\n         * @param {*} parentid\n         */\n        function init(id, parentid) {\n\n            const mode = FeditorHelper.getMode();\n            const level = document.getElementById(id);\n\n            let control = new LevelControl(level, mode, id, parentid);\n            control.main();\n\n        }\n\n\n        /**\n         *\n         * @param {*} level\n         * @param {*} mode\n         * @param {*} id\n         * @param {*} parentid\n         */\n        function LevelControl(level, mode, id, parentid) {\n            const self = this;\n            self.level = level;\n            self.mode = mode;\n            self.id = id;\n            self.parentid = parentid;\n            self.parentidaux = parentid;\n            self.LEVEL_DESCRIPTOR_INPUT = 'gradingform_frubric/level_descriptor_input';\n            self.LEVEL_DECRIPTORS_DELETE_SET = 'gradingform_frubric/level_decriptors_delete_set';\n        }\n\n        /**\n         * Run the controller.\n         */\n        LevelControl.prototype.main = function () {\n            let self = this;\n\n            if (self.mode == 'edit') {\n                if (self.level.classList.contains('criterion-header')) {\n                    self.editModeSetupEvents(self.level.nextElementSibling);\n                } else {\n                    self.editModeSetupEvents(self.level);\n                }\n            }\n            else {\n                if (self.level != null) {\n                   // self.validatePreviousMarkValue();\n                    self.setupEvents(self.level);\n                }\n            }\n\n        };\n\n        LevelControl.prototype.editModeSetupEvents = function (level) {\n            const self = this;\n            // Get the current level. Its the new level added.\n            if (level.getAttribute('data-row-type') == 'result'\n                || level.getAttribute('data-row-type') == 'add-level-r') {\n                level = level.previousElementSibling;\n            }\n\n            const [del, markandesc] = level.children;\n\n            const markdesctable = markandesc.querySelector('.level-mark-desc-table');\n\n            if (markdesctable) {\n                var firstcell = markdesctable.closest('tr'); // Get the delete column for the entire level.\n                firstcell = $(firstcell).children('td:first')[0];\n                firstcell.querySelector('.action-el').addEventListener('click', self.deleteLevel.bind(self));\n\n                let rows = markdesctable.rows;\n                $(rows).each(function (index, row) {\n\n                    $(row).children().each(function (j, td) {\n                        if (td.classList.contains('level-mark')) {\n                            td.querySelector('.level-mark > textarea').addEventListener('focus', self.editmark.bind(self));\n                        }\n\n                        $(td).children().each(function (wy, i) {\n\n                            const container = this;\n\n                            if (container.classList.contains('standard-desc-container')) {\n\n                                self.editModeSetupEventsHelper(container);\n                            }\n\n                            if (container.classList.contains('add-descriptor')) {\n                                container.querySelector('.add-desc-btn').addEventListener('click', self.addDescriptor.bind(self));\n                            }\n\n                            if (container.classList.contains('action-delete-set-desc')) {\n\n                                container.addEventListener('click', self.deleteSetCriterion.bind(self));\n                            }\n\n                        });\n\n                    });\n\n                });\n            }\n\n\n        };\n\n        LevelControl.prototype.editModeSetupEventsHelper = function (desciptorContainer) {\n\n            var self = this;\n            let counter = 0;\n            counter = desciptorContainer.children.length;\n\n            if (counter > 0) { // All the descriptors for this level where deleted previously.\n\n                self.descriptorIndex = counter;\n                self.parentid = desciptorContainer.children[0].getAttribute('data-parent-id');\n                self.lid = desciptorContainer.children[0].getAttribute('id');\n\n                $(desciptorContainer).each(function (i, td) {\n                    $(td).children().each(function (x) {\n\n                        const container = this;\n\n                        if (container.classList.contains('fmark')) {\n                            return;\n                        }\n\n                        container.setAttribute('descriptor-index', x);\n                        const action = container.querySelector('.action-el');\n                        const checkbox = container.querySelector('.standard-check');\n                        const descriptor = container.querySelector('.standard-desc');\n\n                        /**Add focus and click events to the descriptor. SO it always picks up the change */\n                        descriptor.addEventListener('click', self.clickDescriptorHandler.bind(this, self));\n                        descriptor.addEventListener('focus', self.clickDescriptorHandler.bind(this, self));\n                        action.addEventListener('click', self.deleteDescriptor.bind(self, descriptor, container));\n                        checkbox.addEventListener('click', self.selectdescriptor.bind(this, self));\n\n                    });\n                });\n            }\n        }\n\n        LevelControl.prototype.setupEvents = function (level) {\n\n            let self = this;\n            const [del, markandesc] = level.children;\n            const markdesctable = markandesc.querySelector('.level-mark-desc-table');\n\n            if (markdesctable) {\n\n                const [marktd, descriptortd] = markdesctable.rows[0].children;\n                marktd.querySelector('.level-mark > textarea').addEventListener('focus', self.editmark.bind(self));\n\n                if (self.mode != 'edit') {\n                    descriptortd.querySelector('.add-desc-btn').addEventListener('click', self.addDescriptor.bind(self));\n                }\n\n                del.addEventListener('click', self.deleteLevel.bind(self));\n            }\n\n        };\n\n        LevelControl.prototype.editmark = function (e) {\n\n            const self = this;\n            const score = e.target;\n\n            if (score.innerHTML == '[Min - Max]') {\n                score.innerHTML = '';\n            }\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title');\n            }\n\n            score.focus();\n\n            if (!score.classList.contains('changeh')) {\n                score.addEventListener('change', self.changeMarkHandler.bind(this, self));\n                score.classList.add('changeh');\n            }\n\n        };\n\n        LevelControl.prototype.changeMarkHandler = function (s, e) {\n\n            // If it came from validatePreviousMarkValue we need to remove the class warning\n            s.cleanPreviousMarkWarning();\n            // Remove error message if the user inserted wrong data before.\n            e.target.classList.remove('total-input-error');\n            e.target.removeAttribute('data-toggle');\n            e.target.removeAttribute('data-placement');\n            e.target.removeAttribute('data-title');\n\n            const el = document.getElementById(e.target.getAttribute('aria-describedby'));\n\n            if (el != null) {\n                el.parentNode.removeChild(el);\n                e.target.removeAttribute('data-original-title');\n                e.target.removeAttribute('title');\n                e.target.removeAttribute('aria-describedby');\n\n            }\n\n            var levelid;\n\n            if (e.target.getAttribute('data-level-id') != null) {\n                levelid = e.target.getAttribute('data-level-id');\n            }\n            // Update the score for this criterion.\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(document.getElementById(s.id), criteria);\n            const levelsdesc = s.getLevelDescriptors(s.id, criteria, levelid);\n            const score = (e.target.value).trim();\n            const nonum = /[a-z]/gi.test(score);\n\n            let error = false;\n            let message = '';\n\n            if (nonum) {\n                error = true;\n                message = 'Please insert a number value range';\n            } else {\n\n                if (score.indexOf('-') == -1 && score.indexOf('/') == -1) {\n                    error = true;\n                    message = 'Invalid value. Accepts min-max or min/max';\n                } else {\n                    // Evaluate min/max\n                    var [min, max] = FeditorHelper.getMinMax(score);\n                    if (min.length == 0 || max.length == 0) {\n                        error = true;\n                    } else if ((min.length > 0 && max.length > 0) && (parseFloat(min) > parseFloat(max))) {\n                        error = true;\n                        message = 'Min value is greater than max value';\n                    }\n\n                }\n            }\n\n            if (error) {\n                s.setErrorMessage(e, message);\n                error = false;\n                return;\n            }\n\n            var groupid;\n            // Update the total result input. with the highest value.\n            groupid = document.getElementById(s.id).getAttribute('data-criterion-group');\n\n            const resultRow = document.querySelector(`[data-criterion-group=\"${groupid}\"][data-row-type=\"result\"]`);\n            var total = (resultRow.querySelector(`#out-of-value-${groupid}`).innerHTML).split(\"/\");\n\n            total = FeditorHelper.getMaxValueInLevelInCriterion(groupid);\n            const maxinput = resultRow.querySelector('.total-input');\n\n            levelsdesc[0].score = e.target.value.trim();\n\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n\n            resultRow.querySelector(`#out-of-value-${groupid}`).innerHTML = `/${total}`;\n\n            // Update the max attribute.\n            maxinput.setAttribute(\"max\", total);\n            criterion[0].totaloutof = total;\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n        };\n\n        LevelControl.prototype.addDescriptor = function (e) {\n            const self = this;\n            e.stopImmediatePropagation();\n            e.preventDefault();\n\n            // Get the standard-desc-container  that contains the descritors.\n            const descriptorContainer = FeditorHelper.getPreviousElement(e.target.parentNode, '.standard-desc-container');\n            var positionLevel = 0;\n\n            let id;\n            if ((self.mode != 'edit') || descriptorContainer.children.length == 0) {\n                id = `${self.id}-${FeditorHelper.getRandomID()}`;\n                positionLevel = descriptorContainer.children.length; // By adding the delete set\n            } else {\n                id = `${self.id}-${descriptorContainer.children[0].getAttribute('id')}`;\n            }\n            var countingdel = false;\n\n            if (descriptorContainer.children.length > 0) {\n                positionLevel = descriptorContainer.children.length - 1; // When we add the first element, the delete set span is addedd too. we need to only count the divs t oget the right index.\n\n                if (descriptorContainer.children[0].classList.contains('action-delete-set-desc')) {\n                    countingdel = true;\n                }\n            }\n\n            if (self.parentid == undefined) { // Level with no descriptor, User clicked save anf make it ready\n                var editaddnewlevel = false;\n\n            } else if (self.parentid.includes('frubric-criteria-NEWID')) {\n                editaddnewlevel = self.parentid.includes('frubric-criteria-NEWID');\n            }\n\n            const context = {\n                id: id,\n                parentid: self.parentid,\n                edit: self.mode == 'edit',\n                editaddnewlevel: editaddnewlevel,\n                index: (countingdel) ? descriptorContainer.children.length - 1 : descriptorContainer.children.length,\n                poslevel: positionLevel\n            };\n\n            if (self.mode != 'edit') {\n                delete context.index;\n            }\n\n            Templates.render(self.LEVEL_DESCRIPTOR_INPUT, context)\n                .done(function (html, js) {\n\n                    let addDeleteSet = false;\n                    if (descriptorContainer.children.length == 0) {\n                        addDeleteSet = true\n                    }\n                    descriptorContainer.insertAdjacentHTML('beforeend', html);\n\n                    if (addDeleteSet) {\n                        descriptorContainer.insertAdjacentHTML(\"afterbegin\", '  <span class=\"action-delete-set-desc  first-time-render\"> <i class=\"fa fa-close  first-time-render\" title=\"Delete set of descriptors\"></i></span>');\n                        descriptorContainer.querySelector('.action-delete-set-desc').addEventListener('click', self.deleteSetCriterion.bind(self));\n                    }\n\n                    const container = descriptorContainer.lastChild;\n                    const action = container.querySelector('.action-el');\n                    const checkbox = container.querySelector('.standard-check');\n                    const descriptor = container.querySelector('.standard-desc');\n\n                    descriptor.addEventListener('click', self.clickDescriptorHandler.bind(this, self));\n                    descriptor.addEventListener('focus', self.clickDescriptorHandler.bind(this, self));\n                    action.addEventListener('click', self.deleteDescriptor.bind(self, descriptorContainer, container));\n                    checkbox.addEventListener('click', self.selectdescriptor.bind(this, self)); // TODO: DO I NEED THIS?\n\n                    let criteria = FeditorHelper.getCriteriaJSON();\n                    let container2 = descriptorContainer.lastElementChild;\n                    if (container != null) {\n                        FeditorHelper.setCriteriaJSON(criteria);\n                        FeditorHelper.setHiddenCriteriaJSON(criteria);\n                    }\n                })\n                .fail(function (ex) {\n                    Log.debug(\"error...\");\n                });\n\n\n        }\n\n\n\n        LevelControl.prototype.clickDescriptorHandler = function (s, e) {\n\n            let descriptor = e.target;\n            descriptor.focus();\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title')\n            }\n            // Attach change event\n            descriptor.addEventListener('change', s.changeDescriptorHandler.bind(this, s));\n            // If you copy and paste content without clicking it doesnt pick up the change. Add paste event\n            descriptor.addEventListener('paste', s.changeDescriptorHandler.bind(this, s));\n\n        }\n\n        LevelControl.prototype.changeDescriptorHandler = function (s, e) {\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const containerid = e.target.getAttribute('data-container-id');\n            let levelid;\n            let descriptorIndex = e.target.parentNode.getAttribute('descriptor-index');\n\n            if (descriptorIndex != null) {\n                levelid = e.target.parentNode.getAttribute('id');\n            } else {\n                descriptorIndex = Array.from(document.getElementById(containerid).parentNode.children).indexOf(e.target.parentNode) - 1;\n            }\n\n            // We are adding a descriptor to a level that is already in the DB. Make sure is not a rerender for failing\n            if (levelid != undefined && levelid.includes(\"-\") && !document.getElementById('id_criteria').classList.contains('is-invalid')) {\n                levelid.slice(levelid.indexOf('-') + 1, levelid.length);\n            }\n\n            const levelsdesc = s.getLevelDescriptors(s.id, criteria, levelid);\n\n            if (descriptorIndex > levelsdesc[0].descriptors.length) { // Add descriptors inbetween when updating descriptors in different order.\n                for (var i = (levelsdesc[0].descriptors.length); i < descriptorIndex; i++) {\n\n                    levelsdesc[0].descriptors.push({\n                        checked: false,\n                        descText: '',\n                        delete: 0,\n                        descriptorid: 0\n                    });\n                }\n\n            }\n\n            const desc = levelsdesc[0].descriptors[descriptorIndex];\n\n            if (desc == undefined) { // New entry\n                levelsdesc[0].descriptors.push({\n                    checked: false,\n                    descText: e.target.value,\n                    delete: 0,\n                    descriptorid: 0\n                });\n\n            } else { // Existing entry, update text.\n\n                desc.descText = e.target.value;\n            }\n\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n        }\n\n        LevelControl.prototype.selectdescriptor = function (e, s) {\n\n            const containerid = s.target.getAttribute('data-container-id');\n            const criteria = FeditorHelper.getCriteriaJSON();\n            let levelsdesc;\n            let descriptorIndex = s.target.parentNode.getAttribute('descriptor-index');\n\n            if (descriptorIndex != null) {\n                const levelid = s.target.parentNode.getAttribute('id');\n                levelsdesc = e.getLevelDescriptors(e.id, criteria, levelid);\n            } else {\n                descriptorIndex = Array.from(document.getElementById(containerid).parentNode.children).indexOf(s.target.parentNode);\n                levelsdesc = e.getLevelDescriptors(e.id, criteria);\n            }\n\n            const d = levelsdesc[0].descriptors[descriptorIndex];\n            d.checked = s.target.checked;\n\n            // check if its already in the DB, if so, change the status\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n            // Update the input.\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n        }\n\n        LevelControl.prototype.deleteDescriptor = function (descriptorContainer, checkboxcontainer) {\n\n            var self = this;\n            if (checkboxcontainer.getAttribute('descriptor-index')) { // This means the descriptor is already saved in the BD. ask if theya re sure to remove\n\n                Str.get_strings([{\n                    key: 'confirm',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'confirmdeletedescriptor',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'yes'\n                },\n                {\n                    key: 'no'\n                },\n\n                ]).done(function (strs) {\n                    Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n\n\n                        const criteria = FeditorHelper.getCriteriaJSON();\n                        const levelid = checkboxcontainer.getAttribute('id');\n                        const parentid = self.id;\n                        const descriptorIndex = checkboxcontainer.getAttribute('descriptor-index');\n\n                        const levelsdesc = self.getLevelDescriptors(parentid, criteria, levelid);\n                        const d = levelsdesc[0].descriptors[descriptorIndex];\n                        console.log(d);\n                        console.log(checkboxcontainer);\n                        // Check that the descriptor you want to delete was saved in the DB.\n                        // Else, you just have to remove it and update the JSON to avoid updates to the level.\n                        if (d != undefined) { // Added a level but didnt put content, so it didnt trigger any event. Delete it as there is no info related to it.\n\n                            if (d.descriptorid != 0) {\n                                d.delete = 1;\n                                levelsdesc[0].status = 'UPDATE';\n\n                                let countdeleted = 0;\n                                levelsdesc[0].descriptors.forEach(function (desc, index) {\n                                    if (desc.delete == 1) {\n                                        countdeleted++;\n                                    }\n                                }, countdeleted);\n\n                                // Check if its the only descritor in the level.\n                                if (levelsdesc[0].descriptors.length == countdeleted) {\n                                    const checkboxaux = checkboxcontainer;\n                                    levelsdesc[0].status = 'DELETE';\n\n                                    // Check if the definition only has one criterion. If it does, and the level is removed. then the criterion has to be deleted too\n                                    if (criteria.length == 1) {\n                                        criteria[0].status = 'DELETE';\n                                    }\n\n                                    criteria.forEach(function (criterion) {\n                                        if (criterion.id == parentid) {\n                                            if (criterion.levels.length == 1) { // There is only one level in this criterion. Check if the descriptor has info.\n                                                criterion.status = 'DELETE'\n\n                                            } else {\n                                                criterion.status = 'UPDATE'\n                                            }\n                                        }\n                                    }, parentid);\n\n\n                                }\n                            } else {\n                                levelsdesc[0].descriptors.splice(descriptorIndex, 1);\n                                self.updateDescriptorIndex(descriptorContainer);\n                            }\n                        }\n                        // Get a reference to the parent container to be able to reasing the index\n                        //checkboxcontainer.parentNode\n                        checkboxcontainer.style.display = 'none'; // I need to keep the element in the dom because if i add a new element after deleting one, it doesnt work properly.\n                        // Update the input.\n                        FeditorHelper.setCriteriaJSON(criteria);\n                        FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n\n                    }, function () {\n                        // For the cancel btn.\n                        return;\n                    });\n                });\n\n            } else {\n\n                const descriptorindex = checkboxcontainer.getAttribute('data-pos-level');\n                const parentid = self.id;\n                const criteria = FeditorHelper.getCriteriaJSON();\n                const row = document.getElementById(parentid);\n                const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n                const level = criterion[0].levels.filter(function (l) {\n                    if (l.id == parentid) {\n                        return l.descriptors;\n                    }\n                }, parentid);\n\n                const descriptors = (level[0]).descriptors;\n                descriptors.splice(descriptorindex, 1);\n                descriptorContainer.removeChild(checkboxcontainer);\n                self.updateDescriptorIndex(descriptorContainer);\n\n                // UPDATE JSON\n                FeditorHelper.setCriteriaJSON(criteria);\n                FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n            }\n        };\n\n        LevelControl.prototype.deleteSingleDescriptorNotSavedInDB = function (checkboxcontainer) {\n\n            const descriptorindex = checkboxcontainer.getAttribute('data-pos-level');\n            const parentid = self.id;\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const row = document.getElementById(parentid);\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n            const level = criterion[0].levels.filter(function (l) {\n                if (l.id == parentid) {\n                    return l.descriptors;\n                }\n            }, parentid);\n\n            const descriptors = (level[0]).descriptors;\n            descriptors.splice(descriptorindex, 1);\n            descriptorContainer.removeChild(checkboxcontainer);\n            self.updateDescriptorIndex(descriptorContainer);\n            // UPDATE JSON\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n        }\n\n\n        LevelControl.prototype.updateDescriptorIndex = function (descriptorContainer) {\n\n            $(descriptorContainer).children('div.checkbox-container').each(function (i) {\n                this.setAttribute('data-pos-level', i);\n            });\n        }\n\n\n\n        LevelControl.prototype.deleteSetCriterion = function (e) {\n\n            Str.get_strings([{\n                key: 'confirm',\n                component: 'gradingform_frubric'\n            },\n            {\n                key: 'confirmdeletesetcriterion',\n                component: 'gradingform_frubric'\n            },\n            {\n                key: 'yes'\n            },\n            {\n                key: 'no'\n            },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n\n                    const tr = e.target.closest('tr'); // get the tr this element is in\n                    const table = e.target.closest('.level-mark-desc-table');\n                    const criteria = JSON.parse(document.getElementById('id_criteria').value);\n                    const fromRenderer = e.target.classList.contains(\"first-time-render\"); // When adding a new descriptor that was not saved in the db, just delete it But you need to update the json.\n\n                    if (table.rows.length == 1) {\n                        const level = table.closest(\"[data-criterion-group]\");\n                        const lid = level.getAttribute('id');\n                        criteria.forEach(function (criterion) {\n                            if (criterion.id == level.getAttribute('data-criterion-group')) {\n\n                                const cl = Object.values(criterion.levels);\n\n                                cl.forEach(function (level, index) {\n\n                                    if (level.status != \"NEW\" && level.id == lid) { // Case: We want to add a new level and delete the current one.\n                                        level.status = 'DELETE';\n                                        criterion.status = \"UPDATE\";\n                                    } else if (level.id == lid && level.status == \"NEW\") { // This is not saved in the DB. Remove from the JSON.\n                                        criterion.levels.splice(index, 1);\n                                        console.log(criterion);\n                                    }\n                                }, criterion);\n                            }\n                        });\n\n                        level.remove();\n\n                    } else {\n\n                        // It has a few levels.\n                        const crit = tr.closest(\"[data-criterion-group]\"); // This row has the criterion these levels belong to\n                        const descriptors = Array.from(e.target.parentNode.nextElementSibling.children);\n                        const descriptorids = [];\n\n                        descriptors.forEach(function (desc) {\n                            descriptorids.push(desc.id);\n                        }, descriptorids);\n\n                        const data = {\n                            crit: crit,\n                            descids: descriptorids\n                        }\n\n                        if (!fromRenderer) {\n                            criteria.forEach(function (criterion) {\n                                if (criterion.id == data.crit.getAttribute('data-criterion-group')) {\n                                    criterion.status = 'UPDATE';\n\n                                    if (!Array.isArray(criterion.levels)) { // Check if the criteria has levels\n                                        criterion.levels = Object.values(criterion.levels);\n                                    }\n                                    criterion.levels.forEach(function (level) {\n\n                                        if (data.descids.includes((level.id).toString())) {\n\n                                            level.descriptors.forEach(function (d) {\n                                                d.delete = 1;\n                                            });\n                                            level.status = 'DELETE';\n\n                                        }\n                                    }, data.descids);\n\n                                }\n                            }, data);\n                        }\n\n                        table.deleteRow(tr.rowIndex);\n\n                    }\n\n                    FeditorHelper.setCriteriaJSON(criteria);\n                    FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n                }, function () {\n                    // For the cancel btn.\n                    return;\n                });\n            });\n        }\n\n        LevelControl.prototype.deleteLevel = function (e) {\n\n            Str.get_strings([{\n                key: 'confirm',\n                component: 'gradingform_frubric'\n            },\n            {\n                key: 'confirmdeletelevel',\n                component: 'gradingform_frubric'\n            },\n            {\n                key: 'yes'\n            },\n            {\n                key: 'no'\n            },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n\n                    let criTable = document.getElementById('criteriaTable');\n                    const tr = e.target.parentNode.parentNode.parentNode;\n                    const criterion = FeditorHelper.getPreviousElement(tr, '.criterion-header');\n                    let criteria = FeditorHelper.getCriteriaJSON();\n\n\n                    if (criterion.getAttribute('data-criterion-levels').length > 0) {\n\n                        const crid = tr.getAttribute('data-criterion-group')\n                        const lid = tr.getAttribute('id'); // This is the level ID.\n                        var levels;\n\n                        for (let i = 0; i < criteria.length; i++) {\n                            if (criteria[i].id == crid) {\n                                criteria[i].status = 'UPDATE';\n                                levels = criteria[i].levels;\n                                break;\n                            }\n                        }\n\n                        for (let j = 0; j < levels.length; j++) {\n                            if (levels[j].id == lid && levels[j].status != 'NEW') {\n                                levels[j].status = 'DELETE';\n                                break;\n                            } else if (levels[j].status == 'NEW') { //  A new Level is added during editing BUT the user decides to delete it.\n                                levels.splice(j, j);\n                            }\n                        }\n\n\n                    } else {\n\n                        // The Criteria has not been saved. No need to send it to the DB.\n\n                        const tr = e.target.closest('tr');\n                        const lid = tr.getAttribute('id');\n                        const cid = criterion.getAttribute('id');\n                        const d = {\n                            levelid: parseInt(lid),\n                            criterionid: cid\n                        }\n\n\n                        criteria.forEach(function (criterion) {\n\n                            if (criterion.cid == d.criterionid) {\n                                criterion.levels = criterion.levels.filter(function (level) {\n\n                                    if (level.id != d.levelid) {\n                                        return level;\n                                    }\n                                }, d);\n\n                            }\n                        }, d);\n\n                    }\n\n\n                    FeditorHelper.setCriteriaJSON(criteria);\n                    FeditorHelper.setHiddenCriteriaJSON(criteria);\n                    criTable.deleteRow(tr.rowIndex);\n\n\n                }, function () {\n                    // For the cancel btn.\n                    return;\n                });\n            });\n        };\n\n        LevelControl.prototype.editlevelhandler = function (e) {\n            let textarea = e.target;\n\n            textarea.removeAttribute('disabled');\n            textarea.focus();\n            textarea.addEventListener('change', this.changeLevelHandlerDisabled.bind(this, textarea));\n            textarea.addEventListener('focusout', this.focusoutHandlerDisabled);\n        };\n\n        LevelControl.prototype.changeLevelHandlerDisabled = function (txtarea, e) {\n\n            let id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n            const levelrow = e.target.parentNode.parentNode.parentNode;\n\n            // Get the criterion row this level belongs to\n            const criterionheader = FeditorHelper.getPreviousElement(levelrow, '.criterion-header');\n            let leveldbids = criterionheader.getAttribute('data-criterion-levels').length > 0 ? JSON.parse(criterionheader.getAttribute('data-criterion-levels')) : []; // Get the dbids\n\n            const criteriaJSON = FeditorHelper.getCriteriaJSON();\n            const rowIndex = e.target.parentNode.parentNode.parentNode.rowIndex;\n\n            let levelid = id + '_' + rowIndex;\n\n            if (leveldbids.length > 0) {\n                levelid = (leveldbids[rowIndex - 1] != undefined) ? `${id}_${leveldbids[rowIndex - 1]}` : levelid; // The criterion already exists but this is a new level, not saved in the DB yet.\n            }\n\n            const filterCriterion = criteriaJSON.filter(function (criterion, index) {\n                const id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n                criterion.rowindex = index;\n                if (id == criterion.id) {\n                    return criterion;\n                }\n            }, e);\n\n            // Find the level and update the values\n            if (filterCriterion[0].levels != undefined) {\n                var lev = null;\n                const critlevs = filterCriterion[0].levels;\n\n                for (let i = 0; i < critlevs.length; i++) {\n\n                    if ((critlevs[i]).id != levelid) {\n                        continue;\n                    } else {\n                        lev = critlevs[i];\n                        break;\n\n                    }\n                }\n\n                if (lev != null) {\n                    if (e.target.classList.contains('mark_txtarea')) {\n                        lev.score = e.target.value;\n                    } else {\n                        lev.definition = e.target.value;\n                    }\n                    if (lev.status == 'CREATED' || lev.status == 'UPDATED') { // It was updated before.\n                        lev.status = 'UPDATE';\n                    }\n\n                } else {\n\n                    let criterionLevel = {\n                        id: levelid,\n                        status: 'NEW',\n                        score: '',\n                        definition: ''\n                    };\n\n                    if (e.target.classList.contains('mark_txtarea')) {\n                        criterionLevel.score = e.target.value;\n                    } else {\n                        criterionLevel.definition = e.target.value;\n                    }\n                    (filterCriterion[0]).levels.push(criterionLevel);\n                }\n\n                if (FeditorHelper.getMode() == 'edit') {\n\n                    if (filterCriterion[0].cid.includes(\"NEWID\") != true) { // A new criterion added\n                        filterCriterion[0].status = \"UPDATE\"; // The criterion was updated because it has new levels.\n                    } else {\n                        filterCriterion[0].status = \"NEW\";\n                    }\n                }\n\n            }\n\n\n            FeditorHelper.setCriteriaJSON(criteriaJSON);\n            FeditorHelper.setHiddenCriteriaJSON(criteriaJSON);\n\n            e.target.setAttribute('disabled', true);\n        };\n\n        LevelControl.prototype.focusoutHandlerDisabled = function (e) {\n            e.target.setAttribute('disabled', true);\n        };\n\n        LevelControl.prototype.getLevelDescriptors = function (parentid, criteria, levelid) {\n            var self = this;\n            let row = '';\n\n            if (document.getElementById(parentid) == null) {\n                row = document.getElementById(self.level.id);\n            } else {\n                row = document.getElementById(parentid);\n            }\n\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n            let ids;\n            // Get the level to add the descriptor\n            if (levelid != undefined) {\n                parentid = levelid; // compare to the id the DB gave to the level.\n            }\n\n            if (self.mode == 'edit' && levelid != undefined) { // if its come from the add descriptor we have the id of the level in the second part of the id given le\n                if (levelid.toString().indexOf('-') > -1) {\n                    parentid = levelid.slice(levelid.indexOf('-') + 1, levelid.length);\n                    ids = levelid.split('-');\n                    ids.forEach(function (id, index) {\n                        ids[index] = id.toString();\n                    }, ids);\n                }\n            }\n\n            const obj = {\n                mode: self.mode,\n                parentid: parentid,\n                parentidaux: self.parentidaux,\n                ids: ids\n\n            }\n\n            if (criterion[0].levels.length == 0) {\n                criterion[0].levels.push({\n                    score: '',\n                    status: \"NEW\",\n                    id: parentid,\n                    descriptors: [{\n                        checked: false,\n                        descText: '',\n                        delete: 0,\n                        descriptorid: 0\n                    }]\n                });\n            }\n            // User tried to save and make ready a criteria with a level with no descriptor.\n            //We are in the fix error view of the form\n            const levelsdesc = criterion[0].levels.filter(function (level) {\n                if (obj.ids != undefined) {\n                    if ((obj.ids).includes((level.id).toString())) {\n                        return level.descriptors;\n                    }\n                } else if (obj.parentid == (level.id).toString()\n                    || (obj.parentid).toString().includes((level.id).toString())) {\n                    return level.descriptors;\n                }\n\n\n            }, obj);\n\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n            return levelsdesc;\n        };\n\n        LevelControl.prototype.setErrorMessage = function (e, message) {\n\n            e.target.classList.add('total-input-error');\n            e.target.setAttribute('data-toggle', 'tooltip');\n            e.target.setAttribute('data-placement', 'right');\n            e.target.setAttribute('data-title', message);\n        };\n\n        LevelControl.prototype.validatePreviousMarkValue = function () {\n            const self = this;\n\n            const previousLevel = document.getElementById(self.id).previousElementSibling;\n            const previousMark = previousLevel.querySelector('.fmark');\n            if (previousMark != null && previousMark.value == 0 && previousMark.value != \"\") {\n\n                previousLevel.classList.add('alert-warning');\n                previousMark.insertAdjacentHTML('afterend', '<small>Change Mark</small>');\n\n            }\n\n        };\n\n        LevelControl.prototype.cleanPreviousMarkWarning = function () {\n            const self = this;\n\n            const level = document.getElementById(self.id);\n            if (level.classList.contains('alert-warning')) {\n                level.classList.remove('alert-warning');\n                level.querySelector('.level-mark').removeChild(level.querySelector('small'));\n            }\n\n        };\n\n        LevelControl.prototype.countSelectedDescriptors = function () {\n\n        };\n\n\n\n\n\n\n        return {\n            init: init\n        };\n    });"],"names":["define","$","Log","Str","Notification","FeditorHelper","Templates","LevelControl","level","mode","id","parentid","this","parentidaux","LEVEL_DESCRIPTOR_INPUT","LEVEL_DECRIPTORS_DELETE_SET","prototype","main","self","classList","contains","editModeSetupEvents","nextElementSibling","setupEvents","getAttribute","previousElementSibling","del","markandesc","children","markdesctable","querySelector","firstcell","closest","addEventListener","deleteLevel","bind","rows","each","index","row","j","td","editmark","wy","i","container","editModeSetupEventsHelper","addDescriptor","deleteSetCriterion","desciptorContainer","counter","length","descriptorIndex","lid","x","setAttribute","action","checkbox","descriptor","clickDescriptorHandler","deleteDescriptor","selectdescriptor","marktd","descriptortd","e","score","target","innerHTML","remove","removeAttribute","focus","changeMarkHandler","add","s","cleanPreviousMarkWarning","el","document","getElementById","levelid","parentNode","removeChild","criteria","getCriteriaJSON","criterion","getCriterionFromCriteriaCollection","levelsdesc","getLevelDescriptors","value","trim","error","message","test","indexOf","min","max","getMinMax","parseFloat","setErrorMessage","groupid","resultRow","total","split","getMaxValueInLevelInCriterion","maxinput","status","totaloutof","setCriteriaJSON","setHiddenCriteriaJSON","stopImmediatePropagation","preventDefault","descriptorContainer","getPreviousElement","positionLevel","getRandomID","countingdel","undefined","editaddnewlevel","includes","context","edit","poslevel","render","done","html","js","addDeleteSet","insertAdjacentHTML","lastChild","lastElementChild","fail","ex","debug","changeDescriptorHandler","containerid","Array","from","slice","descriptors","push","checked","descText","delete","descriptorid","desc","checkboxcontainer","get_strings","key","component","strs","confirm","d","console","log","countdeleted","forEach","levels","splice","updateDescriptorIndex","style","display","descriptorindex","filter","l","deleteSingleDescriptorNotSavedInDB","tr","table","JSON","parse","fromRenderer","Object","values","crit","descriptorids","data","descids","isArray","toString","deleteRow","rowIndex","criTable","crid","cid","parseInt","criterionid","editlevelhandler","textarea","changeLevelHandlerDisabled","focusoutHandlerDisabled","txtarea","levelrow","criterionheader","leveldbids","criteriaJSON","filterCriterion","rowindex","lev","critlevs","definition","criterionLevel","getMode","ids","obj","validatePreviousMarkValue","previousLevel","previousMark","countSelectedDescriptors","init"],"mappings":"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"}