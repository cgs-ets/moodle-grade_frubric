{"version":3,"file":"level_control.min.js","sources":["../src/level_control.js"],"sourcesContent":["/* eslint-disable no-eq-null */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/str', 'core/notification', 'gradingform_frubric/feditor_helper', 'core/templates'],\n    function ($, Log, Str, Notification, FeditorHelper, Templates) {\n        'use strict';\n        /**\n         *\n         * @param {*} id\n         * @param {*} parentid\n         */\n        function init(id, parentid) {\n\n            const mode = FeditorHelper.getMode();\n            const level = document.getElementById(id);\n\n            let control = new LevelControl(level, mode, id, parentid);\n            control.main();\n\n        }\n\n\n     /**\n      *\n      * @param {*} level\n      * @param {*} mode\n      * @param {*} id\n      * @param {*} parentid\n      */\n        function LevelControl(level, mode, id, parentid) {\n            const self = this;\n            self.level = level;\n            self.mode = mode;\n            self.id = id;\n            self.parentid = parentid;\n            self.parentidaux = parentid;\n            self.LEVEL_DESCRIPTOR_INPUT = 'gradingform_frubric/level_descriptor_input';\n            self.LEVEL_DECRIPTORS_DELETE_SET = 'gradingform_frubric/level_decriptors_delete_set';\n        }\n\n        /**\n         * Run the controller.\n         */\n        LevelControl.prototype.main = function() {\n            let self = this;\n\n            if (self.mode == 'edit') {\n                if (self.level.classList.contains('criterion-header')) {\n                    self.editModeSetupEvents(self.level.nextElementSibling);\n                } else {\n                    self.editModeSetupEvents(self.level);\n                }\n            } else {\n                if (self.level != null) {\n                    // CASE: last level  has 0 mark.\n                    // A new level is added, previous level can't be zero.\n                    // As 0 is only allowed for the last level,\n                    self.validatePreviousMarkValue();\n                    self.setupEvents(self.level);\n                }\n            }\n\n        };\n\n        LevelControl.prototype.editModeSetupEvents = function (level) {\n            const self = this;\n            // Get the current level. Its the new level added.\n            if (level.getAttribute('data-row-type') == 'result'\n                || level.getAttribute('data-row-type') == 'add-level-r') {\n                level = level.previousElementSibling;\n            }\n\n            const [del, markandesc] = level.children;\n\n            const markdesctable = markandesc.querySelector('.level-mark-desc-table');\n\n            if (markdesctable) {\n                var firstcell = markdesctable.closest('tr'); // Get the delete column for the entire level.\n                firstcell = $(firstcell).children('td:first')[0];\n                firstcell.querySelector('.action-el').addEventListener('click', self.deleteLevel.bind(self));\n\n                let rows = markdesctable.rows;\n                $(rows).each(function (index, row) {\n\n                    $(row).children().each(function (j, td) {\n                        if (td.classList.contains('level-mark')) {\n                            td.querySelector('.level-mark > textarea').addEventListener('focus', self.editmark.bind(self));\n                        }\n\n                        $(td).children().each(function (wy, i) {\n\n                            const container = this;\n\n                            if (container.classList.contains('standard-desc-container')) {\n\n                                self.editModeSetupEventsHelper(container);\n                            }\n\n                            if (container.classList.contains('add-descriptor')) {\n                                container.querySelector('.add-desc-btn').addEventListener('click', self.addDescriptor.bind(self));\n                            }\n\n                            if (container.classList.contains('action-delete-set-desc')) {\n\n                                container.addEventListener('click', self.deleteSetCriterion.bind(self));\n                            }\n\n                        });\n\n                    });\n\n                });\n            }\n\n\n        };\n\n        LevelControl.prototype.editModeSetupEventsHelper = function (desciptorContainer) {\n\n            var self = this;\n            let counter = 0;\n            counter = desciptorContainer.children.length;\n\n            if (counter > 0) { // All the descriptors for this level where deleted previously.\n\n                self.descriptorIndex = counter;\n                self.parentid = desciptorContainer.children[0].getAttribute('data-parent-id');\n                self.lid = desciptorContainer.children[0].getAttribute('id');\n\n                $(desciptorContainer).each(function (i, td) {\n                    $(td).children().each(function (x) {\n\n                        const container = this;\n\n                        if (container.classList.contains('fmark')) {\n                            return;\n                        }\n\n                        container.setAttribute('descriptor-index', x);\n                        const action = container.querySelector('.action-el');\n                        const checkbox = container.querySelector('.standard-check');\n                        const descriptor = container.querySelector('.standard-desc');\n\n                        /**Add focus and click events to the descriptor. SO it always picks up the change */\n                        descriptor.addEventListener('click', self.clickDescriptorHandler.bind(this, self));\n                        descriptor.addEventListener('focus', self.clickDescriptorHandler.bind(this, self));\n                        action.addEventListener('click', self.deleteDescriptor.bind(self, descriptor, container));\n                        checkbox.addEventListener('click', self.selectdescriptor.bind(this, self));\n\n                    });\n                });\n            }\n        }\n\n        LevelControl.prototype.setupEvents = function (level) {\n\n            let self = this;\n            const [del, markandesc] = level.children;\n            const markdesctable = markandesc.querySelector('.level-mark-desc-table');\n\n            if (markdesctable) {\n\n                const [marktd, descriptortd] = markdesctable.rows[0].children;\n                marktd.querySelector('.level-mark > textarea').addEventListener('focus', self.editmark.bind(self));\n\n                if (self.mode != 'edit') {\n                    descriptortd.querySelector('.add-desc-btn').addEventListener('click', self.addDescriptor.bind(self));\n                }\n\n                del.addEventListener('click', self.deleteLevel.bind(self));\n            }\n\n        };\n\n        LevelControl.prototype.editmark = function (e) {\n\n            const self = this;\n            const score = e.target;\n\n            if (score.innerHTML == '[Min - Max]') {\n                score.innerHTML = '';\n            }\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title');\n            }\n\n            score.focus();\n\n            if (!score.classList.contains('changeh')) {\n                score.addEventListener('change', self.changeMarkHandler.bind(this, self));\n                score.classList.add('changeh');\n            }\n\n        };\n\n        LevelControl.prototype.changeMarkHandler = function (s, e) {\n\n            // If it came from validatePreviousMarkValue we need to remove the class warning\n            s.cleanPreviousMarkWarning();\n            // Remove error message if the user inserted wrong data before.\n            e.target.classList.remove('total-input-error');\n            e.target.removeAttribute('data-toggle');\n            e.target.removeAttribute('data-placement');\n            e.target.removeAttribute('data-title');\n\n            const el = document.getElementById(e.target.getAttribute('aria-describedby'));\n\n            if (el != null) {\n                el.parentNode.removeChild(el);\n                e.target.removeAttribute('data-original-title');\n                e.target.removeAttribute('title');\n                e.target.removeAttribute('aria-describedby');\n\n            }\n\n            var levelid;\n\n            if (e.target.getAttribute('data-level-id') != null) {\n                levelid = e.target.getAttribute('data-level-id');\n            }\n            // Update the score for this criterion.\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(document.getElementById(s.id), criteria);\n            const levelsdesc = s.getLevelDescriptors(s.id, criteria, levelid);\n            const score = e.target.value;\n            const nonum = /[a-z]/gi.test(e.target.value);\n\n            let error = false;\n            let message = '';\n\n            if (nonum) {\n                error = true;\n                message = 'Please insert a number value range';\n            } else {\n\n                if (score.indexOf('-') == -1 && score.indexOf('/') == -1) {\n                    error = true;\n                    message = 'Invalid value. Accepts min-max or min/max';\n                } else {\n                    // Evaluate min/max\n                    var [min, max] = FeditorHelper.getMinMax(score);\n                    if (min.length == 0 || max.length == 0) {\n                        error = true;\n                    } else if ((min.length > 0 && max.length > 0) && (parseFloat(min) > parseFloat(max))) {\n                        error = true;\n                        message = 'Min value is greater than max value';\n                    }\n\n                }\n            }\n\n            if (error) {\n                s.setErrorMessage(e, message);\n                error = false;\n                return;\n            }\n\n            var groupid;\n            // Update the total result input. with the highest value.\n            groupid = document.getElementById(s.id).getAttribute('data-criterion-group');\n\n            const resultRow = document.querySelector(`[data-criterion-group=\"${groupid}\"][data-row-type=\"result\"]`);\n            var total = (resultRow.querySelector(`#out-of-value-${groupid}`).innerHTML).split(\"/\");\n\n            total =  FeditorHelper.getMaxValueInLevelInCriterion(groupid);\n            const maxinput = resultRow.querySelector('.total-input');\n\n            levelsdesc[0].score = e.target.value;\n\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n\n            resultRow.querySelector(`#out-of-value-${groupid}`).innerHTML = `/${total}`;\n\n            // Update the max attribute.\n            maxinput.setAttribute(\"max\", total);\n            criterion[0].totaloutof = total;\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n        };\n\n        LevelControl.prototype.addDescriptor = function (e) {\n            const self = this;\n            e.stopImmediatePropagation();\n            e.preventDefault();\n\n            // Get the standard-desc-container  that contains the descritors.\n            const descriptorContainer = FeditorHelper.getPreviousElement(e.target.parentNode, '.standard-desc-container');\n            var positionLevel = 0;\n\n            let id;\n            if ((self.mode != 'edit') || descriptorContainer.children.length == 0) {\n                id = `${self.id}-${FeditorHelper.getRandomID()}`;\n                positionLevel = descriptorContainer.children.length; // By adding the delete set\n            } else {\n                id = `${self.id}-${descriptorContainer.children[0].getAttribute('id')}`;\n            }\n\n\n            var countingdel = false;\n\n            if (descriptorContainer.children.length > 0) {\n                positionLevel = descriptorContainer.children.length - 1; // When we add the first element, the delete set span is addedd too. we need to only count the divs t oget the right index.\n\n                if (descriptorContainer.children[0].classList.contains('action-delete-set-desc')) {\n                    countingdel = true;\n                }\n            }\n\n            if (self.parentid == undefined) { // Level with no descriptor, User clicked save anf make it ready\n                var editaddnewlevel = false;\n\n            } else if (self.parentid.includes('frubric-criteria-NEWID')) {\n                editaddnewlevel = self.parentid.includes('frubric-criteria-NEWID');\n            }\n\n\n            const context = {\n                id: id,\n                parentid: self.parentid,\n                edit: self.mode == 'edit',\n                editaddnewlevel: editaddnewlevel,\n                index: (countingdel) ? descriptorContainer.children.length - 1 : descriptorContainer.children.length,\n                poslevel: positionLevel\n            };\n\n\n            if (self.mode != 'edit') {\n                delete context.index;\n            }\n\n            Templates.render(self.LEVEL_DESCRIPTOR_INPUT, context)\n                .done(function (html, js) {\n\n                    let addDeleteSet = false;\n                    if (descriptorContainer.children.length == 0) {\n                        addDeleteSet = true\n                    }\n                    descriptorContainer.insertAdjacentHTML('beforeend', html);\n\n                    if (addDeleteSet) {\n                        descriptorContainer.insertAdjacentHTML(\"afterbegin\", '  <span class=\"action-delete-set-desc  first-time-render\"> <i class=\"fa fa-close  first-time-render\" title=\"Delete set of descriptors\"></i></span>');\n                        descriptorContainer.querySelector('.action-delete-set-desc').addEventListener('click', self.deleteSetCriterion.bind(self));\n                    }\n\n                    const container = descriptorContainer.lastChild;\n                    const action = container.querySelector('.action-el');\n                    const checkbox = container.querySelector('.standard-check');\n                    const descriptor = container.querySelector('.standard-desc');\n\n                    descriptor.addEventListener('click', self.clickDescriptorHandler.bind(this, self));\n                    action.addEventListener('click', self.deleteDescriptor.bind(self, descriptorContainer, container));\n                    checkbox.addEventListener('click', self.selectdescriptor.bind(this, self)); // TODO: DO I NEED THIS?\n\n                })\n                .fail(function (ex) {\n                    Log.debug(\"error...\");\n                });\n\n\n            let criteria = FeditorHelper.getCriteriaJSON();\n            let container = descriptorContainer.lastElementChild;\n\n            if (container != null) {\n                FeditorHelper.setCriteriaJSON(criteria);\n                FeditorHelper.setHiddenCriteriaJSON(criteria);\n            }\n        }\n\n\n\n        LevelControl.prototype.clickDescriptorHandler = function (s, e) {\n\n            let descriptor = e.target;\n            descriptor.focus();\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title')\n            }\n            // Attach change event\n            descriptor.addEventListener('change', s.changeDescriptorHandler.bind(this, s));\n            // If you copy and paste content without clicking it doesnt pick up the change. Add paste event\n            descriptor.addEventListener('paste', s.changeDescriptorHandler.bind(this, s));\n\n        }\n\n        LevelControl.prototype.changeDescriptorHandler = function (s, e) {\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const containerid = e.target.getAttribute('data-container-id');\n            let levelid;\n            let descriptorIndex = e.target.parentNode.getAttribute('descriptor-index');\n\n            if (descriptorIndex != null) {\n                levelid = e.target.parentNode.getAttribute('id');\n            } else {\n                descriptorIndex = Array.from(document.getElementById(containerid).parentNode.children).indexOf(e.target.parentNode) - 1;\n            }\n\n            // We are adding a descriptor to a level that is already in the DB. Make sure is not a rerender for failing\n            if (levelid != undefined && levelid.includes(\"-\") && !document.getElementById('id_criteria').classList.contains('is-invalid')) {\n                levelid.slice(levelid.indexOf('-') + 1, levelid.length);\n            }\n\n            const levelsdesc = s.getLevelDescriptors(s.id, criteria, levelid);\n            if (descriptorIndex > levelsdesc[0].descriptors.length) { // Add descriptors inbetween when updating descriptors in different order.\n                for (var i = (levelsdesc[0].descriptors.length); i < descriptorIndex; i++) {\n\n                    levelsdesc[0].descriptors.push({\n                        checked: false,\n                        descText: '',\n                        delete: 0,\n                        descriptorid: 0\n                    });\n                }\n\n            }\n\n            const desc = levelsdesc[0].descriptors[descriptorIndex];\n\n            if (desc == undefined) { // New entry\n                levelsdesc[0].descriptors.push({\n                    checked: false,\n                    descText: e.target.value,\n                    delete: 0,\n                    descriptorid: 0\n                });\n\n            } else { // Existing entry, update text.\n\n                desc.descText = e.target.value;\n            }\n\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n        }\n\n        LevelControl.prototype.selectdescriptor = function (e, s) {\n\n            const containerid = s.target.getAttribute('data-container-id');\n            const criteria = FeditorHelper.getCriteriaJSON();\n            let levelsdesc;\n            let descriptorIndex = s.target.parentNode.getAttribute('descriptor-index');\n\n            if (descriptorIndex != null) {\n                const levelid = s.target.parentNode.getAttribute('id');\n                levelsdesc = e.getLevelDescriptors(e.id, criteria, levelid);\n            } else {\n                descriptorIndex = Array.from(document.getElementById(containerid).parentNode.children).indexOf(s.target.parentNode);\n                levelsdesc = e.getLevelDescriptors(e.id, criteria);\n            }\n\n            const d = levelsdesc[0].descriptors[descriptorIndex];\n            d.checked = s.target.checked;\n\n            // check if its already in the DB, if so, change the status\n            if (levelsdesc[0].status == 'CREATED' || levelsdesc[0].status == 'UPDATED') {\n                levelsdesc[0].status = 'UPDATE';\n            }\n            // Update the input.\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n        }\n\n        LevelControl.prototype.deleteDescriptor = function (descriptorContainer, checkboxcontainer) {\n\n            var self = this;\n            if (checkboxcontainer.getAttribute('descriptor-index')) { // This means the descriptor is already saved in the BD. ask if theya re sure to remove\n\n                Str.get_strings([{\n                        key: 'confirm',\n                        component: 'gradingform_frubric'\n                    },\n                    {\n                        key: 'confirmdeletedescriptor',\n                        component: 'gradingform_frubric'\n                    },\n                    {\n                        key: 'yes'\n                    },\n                    {\n                        key: 'no'\n                    },\n\n                ]).done(function (strs) {\n                    Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n\n                        const criteria = FeditorHelper.getCriteriaJSON();\n                        const levelid = checkboxcontainer.getAttribute('id');\n                        const parentid = self.id;\n                        const descriptorIndex = checkboxcontainer.getAttribute('descriptor-index');\n\n                        const levelsdesc = self.getLevelDescriptors(parentid, criteria, levelid);\n                        const d = levelsdesc[0].descriptors[descriptorIndex];\n\n                        // Check that the descriptor you want to delete was saved in the DB.\n                        // Else, you just have to remove it and update the JSON to avoid updates to the level.\n                        if (d.descriptorid != 0) {\n                            d.delete = 1;\n                            levelsdesc[0].status = 'UPDATE';\n\n                            let countdeleted = 0;\n                            levelsdesc[0].descriptors.forEach(function (desc, index) {\n                                if (desc.delete == 1) {\n                                    countdeleted++;\n                                }\n                            }, countdeleted);\n\n                            // Check if its the only descritor in the level. If it is, then remove the level completely\n                            if (levelsdesc[0].descriptors.length == countdeleted) {\n                                const checkboxaux = checkboxcontainer;\n                                levelsdesc[0].status = 'DELETE';\n\n                                // Check if the definition only has one criterion. If it does, and the level is removed. then the criterion has to be deleted too\n                                if (criteria.length == 1) {\n                                    criteria[0].status = 'DELETE';\n                                }\n\n                                criteria.forEach(function (criterion) {\n                                    if (criterion.id == parentid) {\n                                        if (criterion.levels.length == 1) { // There is only one level in this criterion. Check if the descriptor has info.\n                                            criterion.status = 'DELETE'\n\n                                        } else {\n                                            criterion.status = 'UPDATE'\n                                        }\n                                    }\n                                }, parentid);\n\n\n                            }\n                        } else {\n                            levelsdesc[0].descriptors.splice(descriptorIndex, 1);\n                            self.updateDescriptorIndex(descriptorContainer);\n                        }\n\n                        checkboxcontainer.remove();\n\n                        // Update the input.\n                        FeditorHelper.setCriteriaJSON(criteria);\n                        FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n\n                    }, function () {\n                        // For the cancel btn.\n                        return;\n                    });\n                });\n\n            } else {\n\n                const descriptorindex = checkboxcontainer.getAttribute('data-pos-level');\n                const parentid = self.id;\n                const criteria = FeditorHelper.getCriteriaJSON();\n                const row = document.getElementById(parentid);\n                const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n                const level = criterion[0].levels.filter(function (l) {\n                    if (l.id == parentid) {\n                        return l.descriptors;\n                    }\n                }, parentid);\n\n                const descriptors = (level[0]).descriptors;\n                descriptors.splice(descriptorindex, 1);\n                descriptorContainer.removeChild(checkboxcontainer);\n                self.updateDescriptorIndex(descriptorContainer);\n\n                // UPDATE JSON\n                FeditorHelper.setCriteriaJSON(criteria);\n                FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n            }\n        };\n\n        LevelControl.prototype.deleteSingleDescriptorNotSavedInDB = function (checkboxcontainer) {\n\n            const descriptorindex = checkboxcontainer.getAttribute('data-pos-level');\n            const parentid = self.id;\n            const criteria = FeditorHelper.getCriteriaJSON();\n            const row = document.getElementById(parentid);\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n            const level = criterion[0].levels.filter(function (l) {\n                if (l.id == parentid) {\n                    return l.descriptors;\n                }\n            }, parentid);\n\n            const descriptors = (level[0]).descriptors;\n            descriptors.splice(descriptorindex, 1);\n            descriptorContainer.removeChild(checkboxcontainer);\n            self.updateDescriptorIndex(descriptorContainer);\n            // UPDATE JSON\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n        }\n\n\n        LevelControl.prototype.updateDescriptorIndex = function (descriptorContainer) {\n\n            $(descriptorContainer).children('div.checkbox-container').each(function (i) {\n                this.setAttribute('data-pos-level', i);\n            });\n        }\n\n\n\n        LevelControl.prototype.deleteSetCriterion = function (e) {\n\n            Str.get_strings([{\n                    key: 'confirm',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'confirmdeletesetcriterion',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'yes'\n                },\n                {\n                    key: 'no'\n                },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n                    const tr = e.target.closest('tr'); // get the tr this element is in\n                    const table = e.target.closest('.level-mark-desc-table');\n                    const criteria = JSON.parse(document.getElementById('id_criteria').value);\n                    const fromRenderer = e.target.classList.contains(\"first-time-render\"); // When adding a new descriptor that was not saved in the db, just delete it.\n\n                    if (table.rows.length == 1) {\n                        const level = table.closest(\"[data-criterion-group]\");\n\n                        if (!fromRenderer) {\n                            criteria.forEach(function (criterion) {\n                                if (criterion.id == level.getAttribute('data-criterion-group')) {\n                                    criterion.status = 'DELETE';\n\n                                    const cl = Object.values(criterion.levels);\n\n                                    cl.forEach(function (level) {\n\n                                        if (level.status != \"NEW\") { // Case: We want to add a new level and delete the current one.\n                                            level.status = 'DELETE';\n                                            criterion.status = \"UPDATE\";\n\n                                        }\n                                    }, criterion);\n                                }\n                            });\n\n                        }\n\n                        level.remove();\n\n                    } else {\n\n                        // It has a few levels.\n                        const crit = tr.closest(\"[data-criterion-group]\"); // This row has the criterion these levels belong to\n                        const descriptors = Array.from(e.target.parentNode.nextElementSibling.children);\n                        const descriptorids = [];\n\n                        descriptors.forEach(function (desc) {\n                            descriptorids.push(desc.id);\n                        }, descriptorids);\n\n                        const data = {\n                            crit: crit,\n                            descids: descriptorids\n                        }\n\n                        if (!fromRenderer) {\n                            criteria.forEach(function (criterion) {\n                                if (criterion.id == data.crit.getAttribute('data-criterion-group')) {\n                                    criterion.status = 'UPDATE';\n\n                                    if (!Array.isArray(criterion.levels)) { // Check if the criteria has levels\n                                        criterion.levels = Object.values(criterion.levels);\n                                    }\n                                    criterion.levels.forEach(function (level) {\n\n                                        if (data.descids.includes((level.id).toString())) {\n\n                                            level.descriptors.forEach(function (d) {\n                                                d.delete = 1;\n                                            });\n                                            level.status = 'DELETE';\n\n                                        }\n                                    }, data.descids);\n\n                                }\n                            }, data);\n                        }\n\n                        table.deleteRow(tr.rowIndex);\n                        // Controlar que el max value  refleje el maximo si hay cambios\n                    }\n\n                    // document.getElementById('id_criteria').value = JSON.stringify(criteria);\n                    FeditorHelper.setCriteriaJSON(criteria);\n                    FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n                }, function () {\n                    // For the cancel btn.\n                    return;\n                });\n            });\n        }\n\n        LevelControl.prototype.deleteLevel = function (e) {\n\n            Str.get_strings([{\n                    key: 'confirm',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'confirmdeletelevel',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'yes'\n                },\n                {\n                    key: 'no'\n                },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n\n                    let criTable = document.getElementById('criteriaTable');\n                    const tr = e.target.parentNode.parentNode.parentNode;\n                    const criterion = FeditorHelper.getPreviousElement(tr, '.criterion-header');\n                    let criteria = FeditorHelper.getCriteriaJSON();\n                    const crid = tr.getAttribute('data-criterion-group')\n\n\n                    if (criterion.getAttribute('data-criterion-levels').length > 0) {\n\n                        const dbids = JSON.parse(criterion.getAttribute('data-criterion-levels')); // These are the ids of the levels given by the DB.\n                        const index = FeditorHelper.getDistanceFromCriterionHeader(tr, '.criterion-header');\n                        const dblevelid = dbids[index];\n\n\n                        var levels;\n\n                        for (let i = 0; i < criteria.length; i++) {\n                            if (criteria[i].id == crid) {\n                                criteria[i].status = 'UPDATE';\n                                levels = criteria[i].levels;\n                                break;\n                            }\n                        }\n\n                        for (let j = 0; j < levels.length; j++) {\n                            if (levels[j].id == dblevelid) {\n                                levels[j].status = 'DELETE';\n                                break;\n                            }\n                        }\n\n                    } else {\n\n                        // The Criteria has not been saved. No need to send it to the DB.\n\n                        const tr = e.target.closest('tr');\n                        const lid = tr.getAttribute('id');\n                        const cid = criterion.getAttribute('id');\n                        const d = {\n                            levelid: parseInt(lid),\n                            criterionid: cid\n                        }\n\n\n                        criteria.forEach(function (criterion) {\n\n                            if (criterion.cid == d.criterionid) {\n                                criterion.levels = criterion.levels.filter(function (level) {\n\n                                    if (level.id != d.levelid) {\n                                        return level;\n                                    }\n                                }, d);\n\n                            }\n                        }, d);\n\n                    }\n\n\n                    FeditorHelper.setCriteriaJSON(criteria);\n                    FeditorHelper.setHiddenCriteriaJSON(criteria);\n                    criTable.deleteRow(tr.rowIndex);\n\n\n                }, function () {\n                    // For the cancel btn.\n                    return;\n                });\n            });\n        };\n\n        LevelControl.prototype.editlevelhandler = function (e) {\n            let textarea = e.target;\n\n            textarea.removeAttribute('disabled');\n            textarea.focus();\n            textarea.addEventListener('change', this.changeLevelHandlerDisabled.bind(this, textarea));\n            textarea.addEventListener('focusout', this.focusoutHandlerDisabled);\n        };\n\n        LevelControl.prototype.changeLevelHandlerDisabled = function (txtarea, e) {\n\n            let id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n            const levelrow = e.target.parentNode.parentNode.parentNode;\n\n            // Get the criterion row this level belongs to\n            const criterionheader = FeditorHelper.getPreviousElement(levelrow, '.criterion-header');\n            let leveldbids = criterionheader.getAttribute('data-criterion-levels').length > 0 ? JSON.parse(criterionheader.getAttribute('data-criterion-levels')) : []; // Get the dbids\n\n            const criteriaJSON = FeditorHelper.getCriteriaJSON();\n            const rowIndex = e.target.parentNode.parentNode.parentNode.rowIndex;\n\n            let levelid = id + '_' + rowIndex;\n\n            if (leveldbids.length > 0) {\n                levelid = (leveldbids[rowIndex - 1] != undefined) ? `${id}_${leveldbids[rowIndex - 1]}` : levelid; // The criterion already exists but this is a new level, not saved in the DB yet.\n            }\n\n            const filterCriterion = criteriaJSON.filter(function (criterion, index) {\n                const id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n                criterion.rowindex = index;\n                if (id == criterion.id) {\n                    return criterion;\n                }\n            }, e);\n\n            // Find the level and update the values\n            if (filterCriterion[0].levels != undefined) {\n                var lev = null;\n                const critlevs = filterCriterion[0].levels;\n\n                for (let i = 0; i < critlevs.length; i++) {\n\n                    if ((critlevs[i]).id != levelid) {\n                        continue;\n                    } else {\n                        lev = critlevs[i];\n                        break;\n\n                    }\n                }\n\n                if (lev != null) {\n                    if (e.target.classList.contains('mark_txtarea')) {\n                        lev.score = e.target.value;\n                    } else {\n                        lev.definition = e.target.value;\n                    }\n                    if (lev.status == 'CREATED' || lev.status == 'UPDATED') { // It was updated before.\n                        lev.status = 'UPDATE';\n                    }\n\n                } else {\n\n                    let criterionLevel = {\n                        id: levelid,\n                        status: 'NEW',\n                        score: '',\n                        definition: ''\n                    };\n\n                    if (e.target.classList.contains('mark_txtarea')) {\n                        criterionLevel.score = e.target.value;\n                    } else {\n                        criterionLevel.definition = e.target.value;\n                    }\n                    (filterCriterion[0]).levels.push(criterionLevel);\n                }\n\n                if (FeditorHelper.getMode() == 'edit') {\n\n                    if (filterCriterion[0].cid.includes(\"NEWID\") != true) { // A new criterion added\n                        filterCriterion[0].status = \"UPDATE\"; // The criterion was updated because it has new levels.\n                    } else {\n                        filterCriterion[0].status = \"NEW\";\n                    }\n                }\n\n            }\n\n\n            FeditorHelper.setCriteriaJSON(criteriaJSON);\n            FeditorHelper.setHiddenCriteriaJSON(criteriaJSON);\n\n            e.target.setAttribute('disabled', true);\n        };\n\n        LevelControl.prototype.focusoutHandlerDisabled = function (e) {\n            e.target.setAttribute('disabled', true);\n        };\n\n        LevelControl.prototype.getLevelDescriptors = function (parentid, criteria, levelid) {\n            var self = this;\n            let row = '';\n\n            if (document.getElementById(parentid) == null) {\n                row = document.getElementById(self.level.id);\n            } else {\n                row = document.getElementById(parentid);\n            }\n\n            const criterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criteria);\n            let ids;\n            // Get the level to add the descriptor\n            if (levelid != undefined) {\n                parentid = levelid; // compare to the id the DB gave to the level.\n            }\n\n            if (self.mode == 'edit' && levelid != undefined) { // if its come from the add descriptor we have the id of the level in the second part of the id given le\n                if (levelid.toString().indexOf('-') > -1) {\n                    parentid = levelid.slice(levelid.indexOf('-') + 1, levelid.length);\n                    ids = levelid.split('-');\n                    ids.forEach(function (id, index) {\n                        ids[index] = id.toString();\n                    }, ids);\n                }\n            }\n\n            const obj = {\n                mode: self.mode,\n                parentid: parentid,\n                parentidaux: self.parentidaux,\n                ids: ids\n\n            }\n\n            if (criterion[0].levels.length == 0) {\n                criterion[0].levels.push({\n                    score: '',\n                    status: \"NEW\",\n                    id: parentid,\n                    descriptors: [{\n                        checked: false,\n                        descText: '',\n                        delete: 0,\n                        descriptorid: 0\n                    }]\n                });\n            }\n            // User tried to save and make ready a criteria with a level with no descriptor.\n            //We are in the fix error view of the form\n            const levelsdesc = criterion[0].levels.filter(function (level) {\n                if (obj.ids != undefined) {\n                    if ((obj.ids).includes((level.id).toString())) {\n                        return level.descriptors;\n                    }\n                } else if (obj.parentid == (level.id).toString()\n                            || (obj.parentid).toString().includes((level.id).toString())) {\n                    return level.descriptors;\n                }\n\n\n            }, obj);\n\n\n            FeditorHelper.setCriteriaJSON(criteria);\n            FeditorHelper.setHiddenCriteriaJSON(criteria);\n\n            return levelsdesc;\n        };\n\n        LevelControl.prototype.setErrorMessage = function (e, message) {\n\n            e.target.classList.add('total-input-error');\n            e.target.setAttribute('data-toggle', 'tooltip');\n            e.target.setAttribute('data-placement', 'right');\n            e.target.setAttribute('data-title', message);\n        };\n\n        LevelControl.prototype.validatePreviousMarkValue = function () {\n            const self = this;\n\n            const previousLevel = document.getElementById(self.id).previousElementSibling;\n            const previousMark = previousLevel.querySelector('.fmark');\n            if (previousMark != null && previousMark.value == 0 && previousMark.value != \"\") {\n\n                previousLevel.classList.add('alert-warning');\n                previousMark.insertAdjacentHTML('afterend', '<small>Change Mark</small>');\n\n            }\n\n        };\n\n        LevelControl.prototype.cleanPreviousMarkWarning = function () {\n            const self = this;\n\n            const level = document.getElementById(self.id);\n            if (level.classList.contains('alert-warning')) {\n                level.classList.remove('alert-warning');\n                level.querySelector('.level-mark').removeChild(level.querySelector('small'));\n            }\n\n        };\n\n        LevelControl.prototype.countSelectedDescriptors = function () {\n\n        };\n\n\n\n\n\n\n        return {\n            init: init\n        };\n    });"],"names":["define","$","Log","Str","Notification","FeditorHelper","Templates","LevelControl","level","mode","id","parentid","this","parentidaux","LEVEL_DESCRIPTOR_INPUT","LEVEL_DECRIPTORS_DELETE_SET","prototype","main","self","classList","contains","editModeSetupEvents","nextElementSibling","validatePreviousMarkValue","setupEvents","getAttribute","previousElementSibling","del","markandesc","children","markdesctable","querySelector","firstcell","closest","addEventListener","deleteLevel","bind","rows","each","index","row","j","td","editmark","wy","i","container","editModeSetupEventsHelper","addDescriptor","deleteSetCriterion","desciptorContainer","counter","length","descriptorIndex","lid","x","setAttribute","action","checkbox","descriptor","clickDescriptorHandler","deleteDescriptor","selectdescriptor","marktd","descriptortd","e","score","target","innerHTML","remove","removeAttribute","focus","changeMarkHandler","add","s","cleanPreviousMarkWarning","el","document","getElementById","levelid","parentNode","removeChild","criteria","getCriteriaJSON","criterion","getCriterionFromCriteriaCollection","levelsdesc","getLevelDescriptors","value","error","message","test","indexOf","min","max","getMinMax","parseFloat","setErrorMessage","groupid","resultRow","total","split","getMaxValueInLevelInCriterion","maxinput","status","totaloutof","setCriteriaJSON","setHiddenCriteriaJSON","stopImmediatePropagation","preventDefault","descriptorContainer","getPreviousElement","positionLevel","getRandomID","countingdel","undefined","editaddnewlevel","includes","context","edit","poslevel","render","done","html","js","addDeleteSet","insertAdjacentHTML","lastChild","fail","ex","debug","lastElementChild","changeDescriptorHandler","containerid","Array","from","slice","descriptors","push","checked","descText","delete","descriptorid","desc","checkboxcontainer","get_strings","key","component","strs","confirm","d","countdeleted","forEach","levels","splice","updateDescriptorIndex","descriptorindex","filter","l","deleteSingleDescriptorNotSavedInDB","tr","table","JSON","parse","fromRenderer","Object","values","crit","descriptorids","data","descids","isArray","toString","deleteRow","rowIndex","criTable","crid","dblevelid","getDistanceFromCriterionHeader","cid","parseInt","criterionid","editlevelhandler","textarea","changeLevelHandlerDisabled","focusoutHandlerDisabled","txtarea","levelrow","criterionheader","leveldbids","criteriaJSON","filterCriterion","rowindex","lev","critlevs","definition","criterionLevel","getMode","ids","obj","previousLevel","previousMark","countSelectedDescriptors","init"],"mappings":"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"}