{"version":3,"sources":["../src/level_control.js"],"names":["define","$","Log","Str","Notification","FeditorHelper","Templates","LevelControl","level","mode","id","self","LEVEL_DESCRIPTOR_INPUT","prototype","main","debug","setupEvents","children","del","markandesc","markdesctable","querySelector","rows","marktd","descriptortd","addEventListener","addDescriptor","bind","deleteLevel","e","preventDefault","descriptorContainer","getPreviousElement","target","parentNode","context","render","done","html","insertAdjacentHTML","checkboxcontainer","lastChild","action","deleteDescriptor","fail","removeChild","get_strings","key","component","strs","confirm","criTable","document","getElementById","tr","criterion","criteria","JSON","parse","value","getAttribute","length","dbids","index","getDistanceFromCriterionHeader","dblevelid","crid","levels","i","status","j","dbid","stringify","deleteRow","rowIndex","editlevelhandler","textarea","innerHTML","removeAttribute","focus","changeLevelHandlerDisabled","focusoutHandlerDisabled","txtarea","levelrow","criterionheader","leveldbids","criteriaJSON","getCriteriaJSON","levelid","filterCriterion","filter","rowindex","lev","critlevs","classList","contains","score","definition","criterionLevel","push","getMode","cid","includes","setAttribute","init","control"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/str', 'core/notification', 'gradingform_frubric/feditor_helper', 'core/templates'],\n  function ($, Log, Str, Notification, FeditorHelper, Templates) {\n    'use strict';\n\n    function init(id) {\n      Log.debug('Level control...');\n      Log.debug(id);\n      const mode = FeditorHelper.getMode();\n      const level  = document.getElementById(id);\n      let control = new LevelControl(level, mode, id);\n      control.main();\n\n    }\n\n\n /**\n  *\n  * @param {*} level\n  * @param {*} mode\n  */\n    function LevelControl(level, mode, id) {\n      const self = this;\n      self.level = level;\n      self.mode = mode;\n      self.id = id;\n      self.LEVEL_DESCRIPTOR_INPUT = 'gradingform_frubric/level_descriptor_input';\n    }\n\n    /**\n     * Run the controller.\n     */\n    LevelControl.prototype.main = function () {\n      let self = this;\n      Log.debug(\"main\");\n  \n\n      if (self.level != null) {\n        self.setupEvents(self.level);\n      }\n\n    };\n\n    LevelControl.prototype.setupEvents = function (level) {\n      let self = this;\n      Log.debug(\"Level control: setupEvents\");\n    \n      const [del, markandesc] = level.children;\n      const markdesctable = markandesc.querySelector('.level-mark-desc-table');\n      const[marktd, descriptortd] = markdesctable.rows[0].children;\n     \n      descriptortd.querySelector('.add-desc-btn').addEventListener('click', self.addDescriptor.bind(self));\n      del.addEventListener('click', self.deleteLevel.bind(self));\n\n    };\n\n    LevelControl.prototype.addDescriptor = function (e) {\n      const self = this;\n      Log.debug(e);\n      e.preventDefault();\n\n      // Get the standard-desc-container  that contains the descritors \n      const descriptorContainer = FeditorHelper.getPreviousElement(e.target.parentNode, '.standard-desc-container');\n      Log.debug(\"En test..\");\n      Log.debug(descriptorContainer);\n      const context = {id: self.id};\n\n      Templates.render(self.LEVEL_DESCRIPTOR_INPUT, context)\n        .done(function (html, js) {\n          descriptorContainer.insertAdjacentHTML('beforeend', html);\n          const checkboxcontainer = descriptorContainer.lastChild;\n          const action = descriptorContainer.lastChild.querySelector('.action-el');\n          action.addEventListener('click', self.deleteDescriptor.bind(this, descriptorContainer, checkboxcontainer));\n        })\n        .fail(function (ex) {\n          Log.debug(\"error...\");\n        });\n\n    }\n  \n    LevelControl.prototype.deleteDescriptor = function (descriptorContainer, checkboxcontainer) {\n      Log.debug('deleteDescriptor');\n      Log.debug(checkboxcontainer);\n      Log.debug(descriptorContainer);\n      descriptorContainer.removeChild(checkboxcontainer);\n    }\n\n    LevelControl.prototype.deleteLevel = function (e) {\n      Log.debug('deleteLevel');\n      Log.debug(e);\n\n      Str.get_strings([{\n          key: 'confirm',\n          component: 'gradingform_frubric'\n        },\n        {\n          key: 'confirmdeletelevel',\n          component: 'gradingform_frubric'\n        },\n        {\n          key: 'yes'\n        },\n        {\n          key: 'no'\n        },\n\n      ]).done(function (strs) {\n        Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n          let criTable = document.getElementById('criteriaTable');\n          const tr = e.target.parentNode.parentNode.parentNode;\n          const criterion = FeditorHelper.getPreviousElement(tr, '.criterion-header');\n          let criteria = JSON.parse(document.getElementById('id_criteria').value);\n\n          if (criterion.getAttribute('data-criterion-levels').length > 0) {\n\n            const dbids = JSON.parse(criterion.getAttribute('data-criterion-levels')); // These are the ids of the levels given by the DB.\n            const index = FeditorHelper.getDistanceFromCriterionHeader(tr, '.criterion-header');\n            const dblevelid = dbids[index];\n            const crid = tr.getAttribute('data-criterion-group')\n\n            var levels;\n            for (let i = 0; i < criteria.length; i++) {\n              if (criteria[i].id == crid) {\n                Log.debug(\"en el if\");\n                criteria[i].status = 'UPDATE';\n                levels = criteria[i].levels;\n                break;\n              }\n            }\n\n            for (let j = 0; j < levels.length; j++) {\n              if (levels[j].dbid == dblevelid) {\n                levels[j].status = 'DELETE';\n                break;\n              }\n            }\n\n          }\n\n\n          document.getElementById('id_criteria').value = JSON.stringify(criteria);\n          criTable.deleteRow(tr.rowIndex); // span -> td -> tr.\n\n        }, function () {\n          // For the cancel btn.\n          return;\n        });\n      });\n    };\n\n    LevelControl.prototype.editlevelhandler = function (e) {\n      Log.debug('editlevelhandler');\n      Log.debug(e);\n      Log.debug(this);\n      let textarea = e.target;\n\n      if (textarea.innerHTML == 'Click to edit Level description' || textarea.innerHTML == 'Click to edit Mark') {\n        textarea.innerHTML = '';\n      }\n\n      textarea.removeAttribute('disabled');\n      textarea.focus();\n      textarea.addEventListener('change', this.changeLevelHandlerDisabled.bind(this, textarea));\n      textarea.addEventListener('focusout', this.focusoutHandlerDisabled);\n    };\n\n    LevelControl.prototype.changeLevelHandlerDisabled = function (txtarea, e) {\n      Log.debug('changeLevelHandlerDisabled');\n\n      let id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n      const levelrow = e.target.parentNode.parentNode.parentNode;\n      // Get the criterion row this level belongs to\n      const criterionheader = FeditorHelper.getPreviousElement(levelrow, '.criterion-header');\n      let leveldbids = criterionheader.getAttribute('data-criterion-levels').length > 0 ? JSON.parse(criterionheader.getAttribute('data-criterion-levels')) : []; // Get the dbids\n    \n      const criteriaJSON = FeditorHelper.getCriteriaJSON();\n      const rowIndex = e.target.parentNode.parentNode.parentNode.rowIndex;\n    \n      let levelid = id + '_' + rowIndex;\n \n      if(leveldbids.length > 0) {\n        levelid = (leveldbids[rowIndex - 1] != undefined)  ? `${id}_${leveldbids[rowIndex - 1]}` : levelid; // The criterion already exists but this is a new level, not saved in the DB yet.\n      } \n\n      const filterCriterion = criteriaJSON.filter(function (criterion, index) {\n        const id = e.target.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n        criterion.rowindex = index;\n        if (id == criterion.id) {\n          return criterion;\n        }\n      }, e);\n\n      // Find the level and update the values\n      if (filterCriterion[0].levels != undefined) {\n        var lev = null;\n        const critlevs = filterCriterion[0].levels;\n\n        for (let i = 0; i < critlevs.length; i++) {\n\n          if ((critlevs[i]).id != levelid) {\n            continue;\n          } else {\n            lev = critlevs[i];\n            break;\n\n          }\n        }\n\n        if (lev != null) {\n          if (e.target.classList.contains('mark_txtarea')) {\n            lev.score = e.target.value;\n          } else {\n            lev.definition = e.target.value;\n          }\n          if (lev.status == 'CREATED' || lev.status == 'UPDATED') { // It was updated before. \n            lev.status = 'UPDATE';\n          }\n\n        } else {\n\n          let criterionLevel = {\n            id: levelid,\n            status: 'NEW',\n            score: '',\n            definition: ''\n          };\n\n          if (e.target.classList.contains('mark_txtarea')) {\n            criterionLevel.score = e.target.value;\n          } else {\n            criterionLevel.definition = e.target.value;\n          }\n          (filterCriterion[0]).levels.push(criterionLevel);\n        }\n\n        if (FeditorHelper.getMode() == 'edit') {\n\n          if (filterCriterion[0].cid.includes(\"NEWID\") != true) { // A new criterion added\n            filterCriterion[0].status = \"UPDATE\"; // The criterion was updated because it has new levels.\n          } else {\n            filterCriterion[0].status = \"NEW\"; \n          }\n        }\n\n      }\n\n      document.getElementById('id_criteria').value = JSON.stringify(criteriaJSON); // Criterionjson;\n\n\n      e.target.setAttribute('disabled', true);\n    };\n\n    LevelControl.prototype.focusoutHandlerDisabled = function(e) {\n      Log.debug('focusoutHandlerDisabled');\n      e.target.setAttribute('disabled', true);\n    };\n\n\n    return {\n      init: init\n    };\n  });"],"file":"level_control.min.js"}