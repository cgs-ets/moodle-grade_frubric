{"version":3,"sources":["../src/evaluate_control.js"],"names":["define","FeditorHelper","EvaluateControl","self","criteria","JSON","parse","document","querySelector","getAttribute","definitionID","getElementById","prototype","main","setupEvents","forEach","element","criterion","criteriaid","level","children","score","addEventListener","focusEvaluationHandler","bind","Array","from","leveldetails","descriptorsCollection","descriptors","descriptor","HTMLInputElement","type","clickDescriptorHandler","e","id","target","split","criteriaID","levelID","descriptorID","length","levelsInput","getLevelsJSON","definition","replace","levelDescriptors","descriptorids","push","descriptorid","indexOf","parseInt","descText","nextSibling","textContent","checked","delete","filter","stringify","value","s","onChangeEvaluationHandler","sumTotal","classList","remove","enteredscore","parseFloat","maxscore","innerText","add","tables","querySelectorAll","sum","haserror","i","t","index","contains","maxtotal","init","control"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable promise/always-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['gradingform_frubric/feditor_helper'],\n    function (FeditorHelper) {\n        'use strict';\n\n        function init() {\n\n          \n            const control = new EvaluateControl();\n            control.main();\n        }\n\n        function EvaluateControl() {\n            const self = this;\n            self.criteria = (JSON.parse(document.querySelector('.form-frubric-evaluate').getAttribute('data-criteria')).criteria); //criteria;\n            self.definitionID = document.getElementById('advancedgrading-criteria').getAttribute('data-definition-id');\n        }\n\n        EvaluateControl.prototype.main = function () {\n            const self = this;\n            self.setupEvents(self.criteria);\n        }\n\n        EvaluateControl.prototype.setupEvents = function (criteria) {\n            const self = this;\n\n            criteria.forEach(function (element) {\n                const self = this;\n                const criterion = document.getElementById(`advancedgrading-frubric-criteria-${element.criteriaid}`);\n                const level = criterion.children[0].children;\n                const score = document.getElementById(`advancedgrading-frubric-criteria-${element.criteriaid}-level-grade`);\n                score.addEventListener('focus', self.focusEvaluationHandler.bind(this, self));\n\n                Array.from(level).forEach(function (leveldetails) {\n                    const descriptorsCollection = leveldetails.children[1];\n                    const descriptors = descriptorsCollection.children;\n                    Array.from(descriptors).forEach(function (descriptor) {\n\n                        if (descriptor instanceof HTMLInputElement) {\n                            switch (descriptor.type) {\n                                case 'checkbox':\n                                    descriptor.addEventListener('click', self.clickDescriptorHandler.bind(self));\n                                    break;\n                            }\n                        }\n                    });\n                }, self);\n\n            }, self);\n\n        }\n\n        EvaluateControl.prototype.clickDescriptorHandler = function (e) {\n            const id = (e.target.id).split('-');\n            const criteriaID = id[3];\n            const levelID = id[5];\n            const descriptorID = id[id.length - 1];\n            let levelsInput = JSON.parse(FeditorHelper.getLevelsJSON(criteriaID));\n            levelsInput[levelID].definition.replace(/\\\\/g, ''); // Remove the //  from the string. \n            let definition = JSON.parse(levelsInput[levelID].definition);\n            let levelDescriptors = levelsInput[levelID].descriptors;\n        \n            let descriptorids = [];\n            levelDescriptors.forEach(element => {\n                descriptorids.push(element.descriptorid);\n            }, descriptorids);\n\n\n            if (descriptorids.indexOf(parseInt(descriptorID)) == -1) {\n                const descText = document.getElementById(`advancedgrading-frubric-criteria-${criteriaID}-level-${levelID}-descriptor-${descriptorID}`).nextSibling.textContent;\n                const newdesc = {\n                    checked: false,\n                    descText: descText,\n                    delete: 0,\n                    descriptorid: descriptorID\n                }\n\n                levelDescriptors.push(newdesc);\n\n            }\n\n            levelDescriptors.filter(descriptor => {\n                if (descriptor.descriptorid == descriptorID) {\n                    descriptor.checked = !descriptor.checked;\n                }\n            }, descriptorID);\n\n\n            definition.descriptors = levelDescriptors;\n            definition = JSON.stringify(definition);\n\n            levelsInput[levelID].definition = definition;\n            // Replace the json value with the updated one\n            document.getElementById(`advancedgrading-frubric-${criteriaID}-leveljson`).value = JSON.stringify(levelsInput);\n            document.getElementById(`advancedgrading-frubric-${criteriaID}-leveljsonaux`).value = JSON.stringify(levelsInput);\n        }\n\n\n        EvaluateControl.prototype.focusEvaluationHandler = function (s, e) {\n\n            document.getElementById(e.target.id).addEventListener('change', s.onChangeEvaluationHandler.bind(this, s));\n            document.getElementById(e.target.id).addEventListener('change', s.sumTotal.bind(this, s));\n        }\n\n        EvaluateControl.prototype.onChangeEvaluationHandler = function (s, e) {\n\n           e.target.classList.remove('total-input-error');\n\n            let enteredscore = parseFloat(document.getElementById(e.target.id).value);\n\n            let maxscore = document.getElementById(e.target.id + '-out-of-value').innerText.split('/');\n            maxscore = parseFloat(maxscore[maxscore.length - 1]);\n    \n            if (enteredscore > maxscore || enteredscore < 0) {\n                e.target.classList.add('total-input-error');\n            } else {\n                document.getElementById(e.target.id).value = enteredscore;\n            }\n\n        }\n\n        EvaluateControl.prototype.sumTotal = function (s, e) {\n            var tables = document.getElementById('advancedgrading-criteria').querySelectorAll('.total-input');\n            var sum = 0;\n            var haserror = false;\n            var i = 0;\n            \n            tables.forEach((t, index) => {\n                \n                if (!t.classList.contains('result') && !t.classList.contains('total-input-error')) {\n                    sum += parseFloat(t.value);\n                }\n                \n                if (t.classList.contains('result'))  {\n                    i = index;\n                }\n\n                if (t.classList.contains('total-input-error')) {\n                    haserror = true;\n                }\n\n                var maxtotal = parseFloat(tables[i].getAttribute('max'));\n    \n                if (!haserror && sum <= maxtotal) {\n                    tables[i].value = sum;\n                }\n            });\n\n        }\n\n        return {\n            init: init\n        };\n    });"],"file":"evaluate_control.min.js"}