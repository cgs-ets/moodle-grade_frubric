function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("gradingform_frubric/level_control",["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],function(a,b,c,d,f,g){'use strict';function h(a,b,c,d){var e=this;e.level=a;e.mode=b;e.id=c;e.parentid=d;e.parentidaux=d;e.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input";e.LEVEL_DECRIPTORS_DELETE_SET="gradingform_frubric/level_decriptors_delete_set"}h.prototype.main=function(){var a=this;Y.log("LEVEL CONTROL..., main");Y.log(a.level);Y.log(a);if("edit"==a.mode){if(a.level.classList.contains("criterion-header")){a.editModeSetupEvents(a.level.nextElementSibling)}else{a.editModeSetupEvents(a.level)}}else{if(null!=a.level){a.validatePreviousMarkValue();a.setupEvents(a.level)}}};h.prototype.editModeSetupEvents=function(b){var c=this;if("result"==b.getAttribute("data-row-type")||"add-level-r"==b.getAttribute("data-row-type")){b=b.previousElementSibling}var d=_slicedToArray(b.children,2),e=d[0],f=d[1],g=f.querySelector(".level-mark-desc-table");if(g){var h=g.closest("tr");h=a(h).children("td:first")[0];h.querySelector(".action-el").addEventListener("click",c.deleteLevel.bind(c));var i=g.rows;a(i).each(function(b,d){a(d).children().each(function(b,d){if(d.classList.contains("level-mark")){d.querySelector(".level-mark > textarea").addEventListener("focus",c.editmark.bind(c))}a(d).children().each(function(){var a=this;if(a.classList.contains("standard-desc-container")){c.editModeSetupEventsHelper(a)}if(a.classList.contains("add-descriptor")){a.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c))}if(a.classList.contains("action-delete-set-desc")){a.addEventListener("click",c.deleteSetCriterion.bind(c))}})})})}};h.prototype.editModeSetupEventsHelper=function(b){var c=this,d=0;d=b.children.length;if(0<d){c.descriptorIndex=d;c.parentid=b.children[0].getAttribute("data-parent-id");c.lid=b.children[0].getAttribute("id");a(b).each(function(b,d){a(d).children().each(function(a){var b=this;if(b.classList.contains("fmark")){return}b.setAttribute("descriptor-index",a);var d=b.querySelector(".action-el"),e=b.querySelector(".standard-check"),f=b.querySelector(".standard-desc");f.addEventListener("click",c.clickDescriptorHandler.bind(this,c));f.addEventListener("focus",c.clickDescriptorHandler.bind(this,c));d.addEventListener("click",c.deleteDescriptor.bind(c,f,b));e.addEventListener("click",c.selectdescriptor.bind(this,c))})})}};h.prototype.setupEvents=function(a){b.debug("Level control: setupEvents");var c=this,d=_slicedToArray(a.children,2),e=d[0],f=d[1],g=f.querySelector(".level-mark-desc-table");if(g){var h=_slicedToArray(g.rows[0].children,2),i=h[0],j=h[1];i.querySelector(".level-mark > textarea").addEventListener("focus",c.editmark.bind(c));if("edit"!=c.mode){j.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c))}e.addEventListener("click",c.deleteLevel.bind(c))}};h.prototype.editmark=function(a){b.debug("editmark...");var c=this,d=a.target;if("[Min - Max]"==d.innerHTML){d.innerHTML=""}if(a.target.classList.contains("is-invalid")){a.target.classList.remove("is-invalid");a.target.classList.remove("form-control")}d.focus();if(!d.classList.contains("changeh")){d.addEventListener("change",c.changeMarkHandler.bind(this,c));d.classList.add("changeh")}};h.prototype.changeMarkHandler=function(a,c){b.debug("changeMarkHandler");a.cleanPreviousMarkWarning();c.target.classList.remove("total-input-error");c.target.removeAttribute("data-toggle");c.target.removeAttribute("data-placement");c.target.removeAttribute("data-title");var d=document.getElementById(c.target.getAttribute("aria-describedby"));if(null!=d){d.parentNode.removeChild(d);c.target.removeAttribute("data-original-title");c.target.removeAttribute("title");c.target.removeAttribute("aria-describedby")}var e;if(null!=c.target.getAttribute("data-level-id")){e=c.target.getAttribute("data-level-id")}var g=f.getCriteriaJSON(),h=f.getCriterionFromCriteriaCollection(document.getElementById(a.id),g),i=a.getLevelDescriptors(a.id,g,e),j=c.target.value,k=/[a-z]/gi.test(c.target.value),l=!1,m="";if(k){l=!0;m="Please insert a number value range"}else if(0==j){var n=document.getElementById(a.id).previousElementSibling.getAttribute("data-row-type"),o=document.getElementById(a.id).nextElementSibling.getAttribute("data-row-type");if(!("level"==n&&"result"==o)){l=!0;m="Zero mark only allowed in last level"}}else{if(-1==j.indexOf("-")&&-1==j.indexOf("/")){l=!0;m="Invalid value. Accepts min-max or min/max"}else{var p=a.getMinMaxMark(j),q=_slicedToArray(p,2),r=q[0],s=q[1];if(0==r.length||0==s.length){l=!0}else if(0<r.length&&0<s.length&&parseFloat(r)>parseFloat(s)){l=!0;m="Min value is greater than max value"}}}if(l){a.setErrorMessage(c,m);l=!1;return}var t;if(!a.parentid.includes("frubric-criteria-NEWID")){t=document.getElementById(a.id).getAttribute("data-criterion-group")}else{t=document.getElementById(a.parentid).getAttribute("data-criterion-group")}var u=document.querySelector("[data-criterion-group=\"".concat(t,"\"][data-row-type=\"result\"]")),v=u.querySelector("#out-of-value-".concat(t)).innerHTML.split("/"),w=u.querySelector(".total-input");i[0].score=c.target.value;if("CREATED"==i[0].status||"UPDATED"==i[0].status){i[0].status="UPDATE"}v=v[v.length-1];if(""===v){u.querySelector("#out-of-value-".concat(t)).innerHTML="/".concat(s);v=s}else{if(parseFloat(v)<s){v=s;u.querySelector("#out-of-value-".concat(t)).innerHTML="/".concat(s)}}w.setAttribute("max",v);h[0].totaloutof=v;f.setCriteriaJSON(g);f.setHiddenCriteriaJSON(g)};h.prototype.addDescriptor=function(a){var c=this;a.stopImmediatePropagation();a.preventDefault();var d=f.getPreviousElement(a.target.parentNode,".standard-desc-container"),e=0,h;if("edit"!=c.mode||0==d.children.length){h="".concat(c.id,"-").concat(f.getRandomID());e=d.children.length}else{h="".concat(c.id,"-").concat(d.children[0].getAttribute("id"))}if(0<d.children.length){e=d.children.length-1}Y.log("self.parentid");Y.log(c.parentid);Y.log(this);if(c.parentid==void 0){var i=!1}else if(c.parentid.includes("frubric-criteria-NEWID")){i=c.parentid.includes("frubric-criteria-NEWID")}Y.log(i);var j={id:h,parentid:c.parentid,edit:"edit"==c.mode,editaddnewlevel:i,index:d.children.length,poslevel:e};if("edit"!=c.mode){delete j.index}g.render(c.LEVEL_DESCRIPTOR_INPUT,j).done(function(a){var b=!1;if(0==d.children.length){b=!0}d.insertAdjacentHTML("beforeend",a);if(b){d.insertAdjacentHTML("afterbegin","  <span class=\"action-delete-set-desc  first-time-render\"> <i class=\"fa fa-close  first-time-render\" title=\"Delete set of descriptors\"></i></span>");d.querySelector(".action-delete-set-desc").addEventListener("click",c.deleteSetCriterion.bind(c))}var e=d.lastChild,f=e.querySelector(".action-el"),g=e.querySelector(".standard-check"),h=e.querySelector(".standard-desc");h.addEventListener("click",c.clickDescriptorHandler.bind(this,c));h.addEventListener("focus",c.clickDescriptorHandler.bind(this,c));f.addEventListener("click",c.deleteDescriptor.bind(c,d,e));g.addEventListener("click",c.selectdescriptor.bind(this,c))}).fail(function(){b.debug("error...")});var k=f.getCriteriaJSON(),l=d.lastElementChild,m="";if(c.lid!=void 0){m=c.getLevelDescriptors(c.parentid,k,c.lid)}else{m=c.getLevelDescriptors(c.parentid,k,c.id)}if(null!=l){Y.log("container..");Y.log(l);var n=l.getAttribute("id");if(n.includes("-")){n=n.split("-")[0]}m=c.getLevelDescriptors(c.parentid,k,l.getAttribute("id"));var o=m[0].descriptors;o.push({checked:!1,descText:"",delete:0});f.setCriteriaJSON(k);f.setHiddenCriteriaJSON(k)}};h.prototype.clickDescriptorHandler=function(a,c){b.debug("clickDescriptorHandler...");var d=c.target;d.focus();d.addEventListener("change",a.changeDescriptorHandler.bind(this,a));d.addEventListener("paste",a.changeDescriptorHandler.bind(this,a))};h.prototype.changeDescriptorHandler=function(a,c){b.debug("changeDescriptorHandler");var d=f.getCriteriaJSON(),e=c.target.getAttribute("data-container-id"),g;if(c.target.classList.contains("is-invalid")){c.target.classList.remove("is-invalid");c.target.classList.remove("form-control")}var h=c.target.parentNode.getAttribute("descriptor-index");if(null!=h){g=c.target.parentNode.getAttribute("id")}else{h=Array.from(document.getElementById(e).parentNode.children).indexOf(c.target.parentNode)-1}if(g!=void 0&&g.includes("-")&&!document.getElementById("id_criteria").classList.contains("is-invalid")){g.slice(g.indexOf("-")+1,g.length)}var i=a.getLevelDescriptors(a.id,d,g),j=i[0].descriptors[h];if(j==void 0){i[0].descriptors.push({checked:!1,descText:c.target.value,delete:0})}else{j.descText=c.target.value;if("CREATED"==i[0].status||"UPDATED"==i[0].status){i[0].status="UPDATE"}}f.setCriteriaJSON(d);f.setHiddenCriteriaJSON(d)};h.prototype.selectdescriptor=function(a,c){b.debug("selectdescriptor");var e=c.target.getAttribute("data-container-id"),g=f.getCriteriaJSON(),h,i=c.target.parentNode.getAttribute("descriptor-index");if(null!=i){var d=c.target.parentNode.getAttribute("id");h=a.getLevelDescriptors(a.id,g,d)}else{i=Array.from(document.getElementById(e).parentNode.children).indexOf(c.target.parentNode);h=a.getLevelDescriptors(a.id,g)}var j=h[0].descriptors[i];j.checked=c.target.checked;if("CREATED"==h[0].status||"UPDATED"==h[0].status){h[0].status="UPDATE"}f.setCriteriaJSON(g);f.setHiddenCriteriaJSON(g)};h.prototype.deleteDescriptor=function(a,e){b.debug("deleteDescriptor");var g=this;if(e.getAttribute("descriptor-index")){c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletedescriptor",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){b.debug("Notification...");var c=f.getCriteriaJSON(),h=e.getAttribute("id"),i=g.id,j=e.getAttribute("descriptor-index"),k=g.getLevelDescriptors(i,c,h),l=k[0].descriptors[j];if(l.hasOwnProperty("descriptorid")){l.delete=1;k[0].status="UPDATE";var d=0;k[0].descriptors.forEach(function(a){if(1==a.delete){d++}},d);if(k[0].descriptors.length==d){e.parentElement.parentElement.parentElement.parentElement;k[0].status="DELETE";if(1==c.length){c[0].status="DELETE"}c.forEach(function(a){if(a.id==i){if(1==a.levels.length){a.status="DELETE"}else{a.status="UPDATE"}}},i)}}else{k[0].descriptors.splice(j,1);g.updateDescriptorIndex(a)}e.remove();f.setCriteriaJSON(c);f.setHiddenCriteriaJSON(c)},function(){})})}else{var h=e.getAttribute("data-pos-level"),i=g.id,j=f.getCriteriaJSON(),k=document.getElementById(i),l=f.getCriterionFromCriteriaCollection(k,j),m=l[0].levels.filter(function(a){if(a.id==i){return a.descriptors}},i),n=m[0].descriptors;n.splice(h,1);a.removeChild(e);g.updateDescriptorIndex(a);f.setCriteriaJSON(j);f.setHiddenCriteriaJSON(j)}};h.prototype.deleteSingleDescriptorNotSavedInDB=function(a){var b=a.getAttribute("data-pos-level"),c=self.id,d=f.getCriteriaJSON(),e=document.getElementById(c),g=f.getCriterionFromCriteriaCollection(e,d),h=g[0].levels.filter(function(a){if(a.id==c){return a.descriptors}},c),i=h[0].descriptors;i.splice(b,1);descriptorContainer.removeChild(a);self.updateDescriptorIndex(descriptorContainer);f.setCriteriaJSON(d);f.setHiddenCriteriaJSON(d)};h.prototype.updateDescriptorIndex=function(b){a(b).children("div.checkbox-container").each(function(a){this.setAttribute("data-pos-level",a)})};h.prototype.deleteSetCriterion=function(a){Y.log("deleteSetCriterion");c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletesetcriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){var b=a.target.closest("tr"),c=a.target.closest(".level-mark-desc-table"),d=JSON.parse(document.getElementById("id_criteria").value),e=a.target.classList.contains("first-time-render");if(1==c.rows.length){var j=c.closest("[data-criterion-group]");if(!e){d.forEach(function(a){if(a.id==j.getAttribute("data-criterion-group")){a.status="DELETE";var b=Object.values(a.levels);b.forEach(function(a){a.status="DELETE"})}})}j.remove()}else{var g=b.closest("[data-criterion-group]"),h=Array.from(a.target.parentNode.nextElementSibling.children),i=[];h.forEach(function(a){i.push(a.id)},i);var k={crit:g,descids:i};if(!e){d.forEach(function(a){if(a.id==k.crit.getAttribute("data-criterion-group")){a.status="UPDATE";if(!Array.isArray(a.levels)){a.levels=Object.values(a.levels)}a.levels.forEach(function(a){if(k.descids.includes(a.id.toString())){a.descriptors.forEach(function(a){a.delete=1});a.status="DELETE"}},k.descids)}},k)}c.deleteRow(b.rowIndex)}f.setCriteriaJSON(d);f.setHiddenCriteriaJSON(d)},function(){})})};h.prototype.deleteLevel=function(a){b.debug("deleteLevel");c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){var b=document.getElementById("criteriaTable"),c=a.target.parentNode.parentNode.parentNode,e=f.getPreviousElement(c,".criterion-header"),g=f.getCriteriaJSON(),h=c.getAttribute("data-criterion-group");if(0<e.getAttribute("data-criterion-levels").length){for(var k=JSON.parse(e.getAttribute("data-criterion-levels")),l=f.getDistanceFromCriterionHeader(c,".criterion-header"),m=k[l],n,o=0;o<g.length;o++){if(g[o].id==h){g[o].status="UPDATE";n=g[o].levels;break}}for(var d=0;d<n.length;d++){if(n[d].id==m){n[d].status="DELETE";break}}}else{var p=a.target.closest("tr"),q=p.getAttribute("id"),r=e.getAttribute("id"),s={levelid:q,criterionid:r};g.forEach(function(a){if(a.cid==s.criterionid){a.levels=a.levels.filter(function(a){a.id!=s.lid},s)}},s)}f.setCriteriaJSON(g);f.setHiddenCriteriaJSON(g);b.deleteRow(c.rowIndex)},function(){})})};h.prototype.editlevelhandler=function(a){b.debug("editlevelhandler");var c=a.target;c.removeAttribute("disabled");c.focus();c.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,c));c.addEventListener("focusout",this.focusoutHandlerDisabled)};h.prototype.changeLevelHandlerDisabled=function(a,c){b.debug("changeLevelHandlerDisabled");var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),e=c.target.parentNode.parentNode.parentNode,g=f.getPreviousElement(e,".criterion-header"),h=0<g.getAttribute("data-criterion-levels").length?JSON.parse(g.getAttribute("data-criterion-levels")):[],j=f.getCriteriaJSON(),k=c.target.parentNode.parentNode.parentNode.rowIndex,l=d+"_"+k;if(0<h.length){l=h[k-1]!=void 0?"".concat(d,"_").concat(h[k-1]):l}var m=j.filter(function(a,b){var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");a.rowindex=b;if(d==a.id){return a}},c);if(m[0].levels!=void 0){for(var n=null,o=m[0].levels,p=0;p<o.length;p++){if(o[p].id!=l){continue}else{n=o[p];break}}if(null!=n){if(c.target.classList.contains("mark_txtarea")){n.score=c.target.value}else{n.definition=c.target.value}if("CREATED"==n.status||"UPDATED"==n.status){n.status="UPDATE"}}else{var q={id:l,status:"NEW",score:"",definition:""};if(c.target.classList.contains("mark_txtarea")){q.score=c.target.value}else{q.definition=c.target.value}m[0].levels.push(q)}if("edit"==f.getMode()){if(!0!=m[0].cid.includes("NEWID")){m[0].status="UPDATE"}else{m[0].status="NEW"}}}f.setCriteriaJSON(j);f.setHiddenCriteriaJSON(j);c.target.setAttribute("disabled",!0)};h.prototype.focusoutHandlerDisabled=function(a){b.debug("focusoutHandlerDisabled");a.target.setAttribute("disabled",!0)};h.prototype.getLevelDescriptors=function(a,c,d){b.debug("getLevelDescriptors...");var e=this,g=document.getElementById(a);if(null==document.getElementById(a)){g=document.getElementById(e.level.id)}Y.log(this);var h=f.getCriterionFromCriteriaCollection(g,c),i;if(d!=void 0){a=d}if("edit"==e.mode&&d!=void 0){if(-1<d.toString().indexOf("-")){a=d.slice(d.indexOf("-")+1,d.length);i=d.split("-");i.forEach(function(a,b){i[b]=a.toString()},i)}}b.debug("parentid",a);var j={mode:e.mode,parentid:a,parentidaux:e.parentidaux,ids:i};if(0==h[0].levels.length){h[0].levels.push({score:"",status:"NEW",id:a,descriptors:[{checked:!1,descText:"",delete:0}]})}var k=h[0].levels.filter(function(a){if(j.ids!=void 0){if(j.ids.includes(a.id.toString())){return a.descriptors}}else if(j.parentid==a.id.toString()||j.parentid.toString().includes(a.id.toString())){return a.descriptors}},j);f.setCriteriaJSON(c);f.setHiddenCriteriaJSON(c);Y.log(c);return k};h.prototype.getMinMaxMark=function(a){if(-1!=a.indexOf("-")){return a.split("-")}else{return a.split("/")}};h.prototype.setErrorMessage=function(a,b){a.target.classList.add("total-input-error");a.target.setAttribute("data-toggle","tooltip");a.target.setAttribute("data-placement","right");a.target.setAttribute("data-title",b)};h.prototype.validatePreviousMarkValue=function(){var a=this,b=document.getElementById(a.id).previousElementSibling,c=b.querySelector(".fmark");if(null!=c&&0==c.value&&""!=c.value){b.classList.add("alert-warning");c.insertAdjacentHTML("afterend","<small>Change Mark</small>")}};h.prototype.cleanPreviousMarkWarning=function(){var a=this,b=document.getElementById(a.id);if(b.classList.contains("alert-warning")){b.classList.remove("alert-warning");b.querySelector(".level-mark").removeChild(b.querySelector("small"))}};h.prototype.countSelectedDescriptors=function(){};return{init:function(a,b){var c=f.getMode(),d=document.getElementById(a),e=new h(d,c,a,b);e.main()}}});
//# sourceMappingURL=level_control.min.js.map
