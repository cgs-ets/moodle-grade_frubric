define(["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],function(r,n,o,u,g,a){"use strict";function i(e,t,r,i){var n=this;n.level=e,n.mode=t,n.id=r,n.parentid=i,n.parentidaux=i,n.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input",n.LEVEL_DECRIPTORS_DELETE_SET="gradingform_frubric/level_decriptors_delete_set"}return i.prototype.main=function(){var e=this;"edit"==e.mode?e.level.classList.contains("criterion-header")?e.editModeSetupEvents(e.level.nextElementSibling):e.editModeSetupEvents(e.level):null!=e.level&&e.setupEvents(e.level)},i.prototype.editModeSetupEvents=function(e){const i=this;var t,[,e]=(e="result"!=e.getAttribute("data-row-type")&&"add-level-r"!=e.getAttribute("data-row-type")?e:e.previousElementSibling).children,e=e.querySelector(".level-mark-desc-table");e&&(t=e.closest("tr"),(t=r(t).children("td:first")[0]).querySelector(".action-el").addEventListener("click",i.deleteLevel.bind(i)),t=e.rows,r(t).each(function(e,t){r(t).children().each(function(e,t){t.classList.contains("level-mark")&&t.querySelector(".level-mark > textarea").addEventListener("focus",i.editmark.bind(i)),r(t).children().each(function(e,t){var r=this;r.classList.contains("standard-desc-container")&&i.editModeSetupEventsHelper(r),r.classList.contains("add-descriptor")&&r.querySelector(".add-desc-btn").addEventListener("click",i.addDescriptor.bind(i)),r.classList.contains("action-delete-set-desc")&&r.addEventListener("click",i.deleteSetCriterion.bind(i))})})}))},i.prototype.editModeSetupEventsHelper=function(e){var t,n=this;0<(t=e.children.length)&&(n.descriptorIndex=t,n.parentid=e.children[0].getAttribute("data-parent-id"),n.lid=e.children[0].getAttribute("id"),r(e).each(function(e,t){r(t).children().each(function(e){var t,r,i=this;i.classList.contains("fmark")||(i.setAttribute("descriptor-index",e),e=i.querySelector(".action-el"),t=i.querySelector(".standard-check"),(r=i.querySelector(".standard-desc")).addEventListener("click",n.clickDescriptorHandler.bind(this,n)),r.addEventListener("focus",n.clickDescriptorHandler.bind(this,n)),e.addEventListener("click",n.deleteDescriptor.bind(n,r,i)),t.addEventListener("click",n.selectdescriptor.bind(this,n)))})}))},i.prototype.setupEvents=function(e){var t,r=this,[e,i]=e.children,i=i.querySelector(".level-mark-desc-table");i&&([i,t]=i.rows[0].children,i.querySelector(".level-mark > textarea").addEventListener("focus",r.editmark.bind(r)),"edit"!=r.mode&&t.querySelector(".add-desc-btn").addEventListener("click",r.addDescriptor.bind(r)),e.addEventListener("click",r.deleteLevel.bind(r)))},i.prototype.editmark=function(e){var t=e.target;"[Min - Max]"==t.innerHTML&&(t.innerHTML=""),e.target.classList.contains("is-invalid")&&(e.target.classList.remove("is-invalid"),e.target.classList.remove("form-control"),e.target.removeAttribute("title")),t.focus(),t.classList.contains("changeh")||(t.addEventListener("change",this.changeMarkHandler.bind(this,this)),t.classList.add("changeh"))},i.prototype.changeMarkHandler=function(e,t){e.cleanPreviousMarkWarning(),t.target.classList.remove("total-input-error"),t.target.removeAttribute("data-toggle"),t.target.removeAttribute("data-placement"),t.target.removeAttribute("data-title");var r,i,n=document.getElementById(t.target.getAttribute("aria-describedby")),n=(null!=n&&(n.parentNode.removeChild(n),t.target.removeAttribute("data-original-title"),t.target.removeAttribute("title"),t.target.removeAttribute("aria-describedby")),null!=t.target.getAttribute("data-level-id")&&(d=t.target.getAttribute("data-level-id")),g.getCriteriaJSON()),a=g.getCriterionFromCriteriaCollection(document.getElementById(e.id),n),d=e.getLevelDescriptors(e.id,n,d),s=t.target.value.trim();let o=!1,l="";/[a-z]/gi.test(s)?(o=!0,l="Please insert a number value range"):-1==s.indexOf("-")&&-1==s.indexOf("/")?(o=!0,l="Invalid value. Accepts min-max or min/max"):([s,r]=g.getMinMax(s),0==s.length||0==r.length?o=!0:0<s.length&&0<r.length&&parseFloat(s)>parseFloat(r)&&(o=!0,l="Min value is greater than max value")),o?(e.setErrorMessage(t,l),o=!1):(s=document.getElementById(e.id).getAttribute("data-criterion-group"),e=(r=document.querySelector(`[data-criterion-group="${s}"][data-row-type="result"]`)).querySelector("#out-of-value-"+s).innerHTML.split("/"),e=g.getMaxValueInLevelInCriterion(s),i=r.querySelector(".total-input"),d[0].score=t.target.value.trim(),"CREATED"!=d[0].status&&"UPDATED"!=d[0].status||(d[0].status="UPDATE"),r.querySelector("#out-of-value-"+s).innerHTML="/"+e,i.setAttribute("max",e),a[0].totaloutof=e,g.setCriteriaJSON(n),g.setHiddenCriteriaJSON(n))},i.prototype.addDescriptor=function(e){const d=this,s=(e.stopImmediatePropagation(),e.preventDefault(),g.getPreviousElement(e.target.parentNode,".standard-desc-container"));e=0;let t;"edit"!=d.mode||0==s.children.length?(t=d.id+"-"+g.getRandomID(),e=s.children.length):t=d.id+"-"+s.children[0].getAttribute("id");var r=!1,i=(0<s.children.length&&(e=s.children.length-1,s.children[0].classList.contains("action-delete-set-desc"))&&(r=!0),null==d.parentid?i=!1:d.parentid.includes("frubric-criteria-NEWID")&&(i=d.parentid.includes("frubric-criteria-NEWID")),{id:t,parentid:d.parentid,edit:"edit"==d.mode,editaddnewlevel:i,index:r?s.children.length-1:s.children.length,poslevel:e});"edit"!=d.mode&&delete i.index,a.render(d.LEVEL_DESCRIPTOR_INPUT,i).done(function(e,t){let r=!1;0==s.children.length&&(r=!0),s.insertAdjacentHTML("beforeend",e),r&&(s.insertAdjacentHTML("afterbegin",'  <span class="action-delete-set-desc  first-time-render"> <i class="fa fa-close  first-time-render" title="Delete set of descriptors"></i></span>'),s.querySelector(".action-delete-set-desc").addEventListener("click",d.deleteSetCriterion.bind(d)));var e=s.lastChild,i=e.querySelector(".action-el"),n=e.querySelector(".standard-check"),a=e.querySelector(".standard-desc"),a=(a.addEventListener("click",d.clickDescriptorHandler.bind(this,d)),a.addEventListener("focus",d.clickDescriptorHandler.bind(this,d)),i.addEventListener("click",d.deleteDescriptor.bind(d,s,e)),n.addEventListener("click",d.selectdescriptor.bind(this,d)),g.getCriteriaJSON());s.lastElementChild;null!=e&&(g.setCriteriaJSON(a),g.setHiddenCriteriaJSON(a))}).fail(function(e){n.debug("error...")})},i.prototype.clickDescriptorHandler=function(e,t){var r=t.target;r.focus(),t.target.classList.contains("is-invalid")&&(t.target.classList.remove("is-invalid"),t.target.classList.remove("form-control"),t.target.removeAttribute("title")),r.addEventListener("change",e.changeDescriptorHandler.bind(this,e)),r.addEventListener("paste",e.changeDescriptorHandler.bind(this,e))},i.prototype.changeDescriptorHandler=function(e,t){var r=g.getCriteriaJSON(),i=t.target.getAttribute("data-container-id");let n,a=t.target.parentNode.getAttribute("descriptor-index");null!=a?n=t.target.parentNode.getAttribute("id"):a=Array.from(document.getElementById(i).parentNode.children).indexOf(t.target.parentNode)-1,null!=n&&n.includes("-")&&!document.getElementById("id_criteria").classList.contains("is-invalid")&&n.slice(n.indexOf("-")+1,n.length);var d=e.getLevelDescriptors(e.id,r,n);if(a>d[0].descriptors.length)for(var s=d[0].descriptors.length;s<a;s++)d[0].descriptors.push({checked:!1,descText:"",delete:0,descriptorid:0});i=d[0].descriptors[a];null==i?d[0].descriptors.push({checked:!1,descText:t.target.value,delete:0,descriptorid:0}):i.descText=t.target.value,"CREATED"!=d[0].status&&"UPDATED"!=d[0].status||(d[0].status="UPDATE"),g.setCriteriaJSON(r),g.setHiddenCriteriaJSON(r)},i.prototype.selectdescriptor=function(e,t){var r,i=t.target.getAttribute("data-container-id"),n=g.getCriteriaJSON();let a,d=t.target.parentNode.getAttribute("descriptor-index");(a=null!=d?(r=t.target.parentNode.getAttribute("id"),e.getLevelDescriptors(e.id,n,r)):(d=Array.from(document.getElementById(i).parentNode.children).indexOf(t.target.parentNode),e.getLevelDescriptors(e.id,n)))[0].descriptors[d].checked=t.target.checked,"CREATED"!=a[0].status&&"UPDATED"!=a[0].status||(a[0].status="UPDATE"),g.setCriteriaJSON(n),g.setHiddenCriteriaJSON(n)},i.prototype.deleteDescriptor=function(a,d){var s=this;if(d.getAttribute("descriptor-index"))o.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletedescriptor",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(e){u.confirm(e[0],e[1],e[2],e[3],function(){var e=g.getCriteriaJSON(),t=d.getAttribute("id");const i=s.id;var r=d.getAttribute("descriptor-index"),t=s.getLevelDescriptors(i,e,t),n=t[0].descriptors[r];if(console.log(n),console.log(d),null!=n)if(0!=n.descriptorid){n.delete=1,t[0].status="UPDATE";let r=0;t[0].descriptors.forEach(function(e,t){1==e.delete&&r++},r),t[0].descriptors.length==r&&(t[0].status="DELETE",1==e.length&&(e[0].status="DELETE"),e.forEach(function(e){e.id==i&&(1==e.levels.length?e.status="DELETE":e.status="UPDATE")},i))}else t[0].descriptors.splice(r,1),s.updateDescriptorIndex(a);d.style.display="none",g.setCriteriaJSON(e),g.setHiddenCriteriaJSON(e)},function(){})});else{var e=d.getAttribute("data-pos-level");const i=s.id;var t=g.getCriteriaJSON(),r=document.getElementById(i);g.getCriterionFromCriteriaCollection(r,t)[0].levels.filter(function(e){if(e.id==i)return e.descriptors},i)[0].descriptors.splice(e,1),a.removeChild(d),s.updateDescriptorIndex(a),g.setCriteriaJSON(t),g.setHiddenCriteriaJSON(t)}},i.prototype.deleteSingleDescriptorNotSavedInDB=function(e){var t=e.getAttribute("data-pos-level");const r=self.id;var i=g.getCriteriaJSON(),n=document.getElementById(r);g.getCriterionFromCriteriaCollection(n,i)[0].levels.filter(function(e){if(e.id==r)return e.descriptors},r)[0].descriptors.splice(t,1),descriptorContainer.removeChild(e),self.updateDescriptorIndex(descriptorContainer),g.setCriteriaJSON(i),g.setHiddenCriteriaJSON(i)},i.prototype.updateDescriptorIndex=function(e){r(e).children("div.checkbox-container").each(function(e){this.setAttribute("data-pos-level",e)})},i.prototype.deleteSetCriterion=function(c){o.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletesetcriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(e){u.confirm(e[0],e[1],e[2],e[3],function(){var e=c.target.closest("tr"),t=c.target.closest(".level-mark-desc-table"),r=JSON.parse(document.getElementById("id_criteria").value),i=c.target.classList.contains("first-time-render");if(1==t.rows.length){const d=t.closest("[data-criterion-group]"),s=d.getAttribute("id");r.forEach(function(r){r.id==d.getAttribute("data-criterion-group")&&Object.values(r.levels).forEach(function(e,t){"NEW"!=e.status&&e.id==s?(e.status="DELETE",r.status="UPDATE"):e.id==s&&"NEW"==e.status&&(r.levels.splice(t,1),console.log(r))},r)}),d.remove()}else{var n=e.closest("[data-criterion-group]"),a=Array.from(c.target.parentNode.nextElementSibling.children);const o=[],l=(a.forEach(function(e){o.push(e.id)},o),{crit:n,descids:o});i||r.forEach(function(e){e.id==l.crit.getAttribute("data-criterion-group")&&(e.status="UPDATE",Array.isArray(e.levels)||(e.levels=Object.values(e.levels)),e.levels.forEach(function(e){l.descids.includes(e.id.toString())&&(e.descriptors.forEach(function(e){e.delete=1}),e.status="DELETE")},l.descids))},l),t.deleteRow(e.rowIndex)}g.setCriteriaJSON(r),g.setHiddenCriteriaJSON(r)},function(){})})},i.prototype.deleteLevel=function(l){o.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(e){u.confirm(e[0],e[1],e[2],e[3],function(){var e=document.getElementById("criteriaTable");const t=l.target.parentNode.parentNode.parentNode;var r=g.getPreviousElement(t,".criterion-header"),i=g.getCriteriaJSON();if(0<r.getAttribute("data-criterion-levels").length){var n,a=t.getAttribute("data-criterion-group"),d=t.getAttribute("id");for(let e=0;e<i.length;e++)if(i[e].id==a){i[e].status="UPDATE",n=i[e].levels;break}for(let e=0;e<n.length;e++){if(n[e].id==d&&"NEW"!=n[e].status){n[e].status="DELETE";break}"NEW"==n[e].status&&n.splice(e,e)}}else{const t=l.target.closest("tr");var s=t.getAttribute("id"),r=r.getAttribute("id");const o={levelid:parseInt(s),criterionid:r};i.forEach(function(e){e.cid==o.criterionid&&(e.levels=e.levels.filter(function(e){if(e.id!=o.levelid)return e},o))},o)}g.setCriteriaJSON(i),g.setHiddenCriteriaJSON(i),e.deleteRow(t.rowIndex)},function(){})})},i.prototype.editlevelhandler=function(e){e=e.target;e.removeAttribute("disabled"),e.focus(),e.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,e)),e.addEventListener("focusout",this.focusoutHandlerDisabled)},i.prototype.changeLevelHandlerDisabled=function(e,i){var t=i.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),r=i.target.parentNode.parentNode.parentNode,r=g.getPreviousElement(r,".criterion-header"),r=0<r.getAttribute("data-criterion-levels").length?JSON.parse(r.getAttribute("data-criterion-levels")):[],n=g.getCriteriaJSON(),a=i.target.parentNode.parentNode.parentNode.rowIndex;let d=t+"_"+a;0<r.length&&(d=null!=r[a-1]?t+"_"+r[a-1]:d);t=n.filter(function(e,t){var r=i.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");if(e.rowindex=t,r==e.id)return e},i);if(null!=t[0].levels){var s=null,o=t[0].levels;for(let e=0;e<o.length;e++)if(o[e].id==d){s=o[e];break}null!=s?(i.target.classList.contains("mark_txtarea")?s.score=i.target.value:s.definition=i.target.value,"CREATED"!=s.status&&"UPDATED"!=s.status||(s.status="UPDATE")):(r={id:d,status:"NEW",score:"",definition:""},i.target.classList.contains("mark_txtarea")?r.score=i.target.value:r.definition=i.target.value,t[0].levels.push(r)),"edit"==g.getMode()&&(1!=t[0].cid.includes("NEWID")?t[0].status="UPDATE":t[0].status="NEW")}g.setCriteriaJSON(n),g.setHiddenCriteriaJSON(n),i.target.setAttribute("disabled",!0)},i.prototype.focusoutHandlerDisabled=function(e){e.target.setAttribute("disabled",!0)},i.prototype.getLevelDescriptors=function(e,t,r){let i="";i=null==document.getElementById(e)?document.getElementById(this.level.id):document.getElementById(e);var n=g.getCriterionFromCriteriaCollection(i,t);let a;null!=r&&(e=r),"edit"==this.mode&&null!=r&&-1<r.toString().indexOf("-")&&(e=r.slice(r.indexOf("-")+1,r.length),(a=r.split("-")).forEach(function(e,t){a[t]=e.toString()},a));const d={mode:this.mode,parentid:e,parentidaux:this.parentidaux,ids:a};0==n[0].levels.length&&n[0].levels.push({score:"",status:"NEW",id:e,descriptors:[{checked:!1,descText:"",delete:0,descriptorid:0}]});r=n[0].levels.filter(function(e){if(null!=d.ids){if(d.ids.includes(e.id.toString()))return e.descriptors}else if(d.parentid==e.id.toString()||d.parentid.toString().includes(e.id.toString()))return e.descriptors},d);return g.setCriteriaJSON(t),g.setHiddenCriteriaJSON(t),r},i.prototype.setErrorMessage=function(e,t){e.target.classList.add("total-input-error"),e.target.setAttribute("data-toggle","tooltip"),e.target.setAttribute("data-placement","right"),e.target.setAttribute("data-title",t)},i.prototype.validatePreviousMarkValue=function(){var e=document.getElementById(this.id).previousElementSibling,t=e.querySelector(".fmark");null!=t&&0==t.value&&""!=t.value&&(e.classList.add("alert-warning"),t.insertAdjacentHTML("afterend","<small>Change Mark</small>"))},i.prototype.cleanPreviousMarkWarning=function(){var e=document.getElementById(this.id);e.classList.contains("alert-warning")&&(e.classList.remove("alert-warning"),e.querySelector(".level-mark").removeChild(e.querySelector("small")))},i.prototype.countSelectedDescriptors=function(){},{init:function(e,t){var r=g.getMode();new i(document.getElementById(e),r,e,t).main()}}});