/**
 * @package   gradingform_frubric
 * @copyright 2021 Veronica Bermegui
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("gradingform_frubric/level_control",["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],(function($,Log,Str,Notification,FeditorHelper,Templates){function LevelControl(level,mode,id,parentid){this.level=level,this.mode=mode,this.id=id,this.parentid=parentid,this.parentidaux=parentid,this.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input",this.LEVEL_DECRIPTORS_DELETE_SET="gradingform_frubric/level_decriptors_delete_set"}return LevelControl.prototype.main=function(){let self=this;"edit"==self.mode?self.level.classList.contains("criterion-header")?self.editModeSetupEvents(self.level.nextElementSibling):self.editModeSetupEvents(self.level):null!=self.level&&(self.validatePreviousMarkValue(),self.setupEvents(self.level))},LevelControl.prototype.editModeSetupEvents=function(level){const self=this;"result"!=level.getAttribute("data-row-type")&&"add-level-r"!=level.getAttribute("data-row-type")||(level=level.previousElementSibling);const[del,markandesc]=level.children,markdesctable=markandesc.querySelector(".level-mark-desc-table");if(markdesctable){var firstcell=markdesctable.closest("tr");(firstcell=$(firstcell).children("td:first")[0]).querySelector(".action-el").addEventListener("click",self.deleteLevel.bind(self));let rows=markdesctable.rows;$(rows).each((function(index,row){$(row).children().each((function(j,td){td.classList.contains("level-mark")&&td.querySelector(".level-mark > textarea").addEventListener("focus",self.editmark.bind(self)),$(td).children().each((function(wy,i){const container=this;container.classList.contains("standard-desc-container")&&self.editModeSetupEventsHelper(container),container.classList.contains("add-descriptor")&&container.querySelector(".add-desc-btn").addEventListener("click",self.addDescriptor.bind(self)),container.classList.contains("action-delete-set-desc")&&container.addEventListener("click",self.deleteSetCriterion.bind(self))}))}))}))}},LevelControl.prototype.editModeSetupEventsHelper=function(desciptorContainer){var self=this;let counter=0;counter=desciptorContainer.children.length,counter>0&&(self.descriptorIndex=counter,self.parentid=desciptorContainer.children[0].getAttribute("data-parent-id"),self.lid=desciptorContainer.children[0].getAttribute("id"),$(desciptorContainer).each((function(i,td){$(td).children().each((function(x){if(this.classList.contains("fmark"))return;this.setAttribute("descriptor-index",x);const action=this.querySelector(".action-el"),checkbox=this.querySelector(".standard-check"),descriptor=this.querySelector(".standard-desc");descriptor.addEventListener("click",self.clickDescriptorHandler.bind(this,self)),descriptor.addEventListener("focus",self.clickDescriptorHandler.bind(this,self)),action.addEventListener("click",self.deleteDescriptor.bind(self,descriptor,this)),checkbox.addEventListener("click",self.selectdescriptor.bind(this,self))}))})))},LevelControl.prototype.setupEvents=function(level){let self=this;const[del,markandesc]=level.children,markdesctable=markandesc.querySelector(".level-mark-desc-table");if(markdesctable){const[marktd,descriptortd]=markdesctable.rows[0].children;marktd.querySelector(".level-mark > textarea").addEventListener("focus",self.editmark.bind(self)),"edit"!=self.mode&&descriptortd.querySelector(".add-desc-btn").addEventListener("click",self.addDescriptor.bind(self)),del.addEventListener("click",self.deleteLevel.bind(self))}},LevelControl.prototype.editmark=function(e){const self=this,score=e.target;"[Min - Max]"==score.innerHTML&&(score.innerHTML=""),e.target.classList.contains("is-invalid")&&(e.target.classList.remove("is-invalid"),e.target.classList.remove("form-control"),e.target.removeAttribute("title")),score.focus(),score.classList.contains("changeh")||(score.addEventListener("change",self.changeMarkHandler.bind(this,self)),score.classList.add("changeh"))},LevelControl.prototype.changeMarkHandler=function(s,e){s.cleanPreviousMarkWarning(),e.target.classList.remove("total-input-error"),e.target.removeAttribute("data-toggle"),e.target.removeAttribute("data-placement"),e.target.removeAttribute("data-title");const el=document.getElementById(e.target.getAttribute("aria-describedby"));var levelid;null!=el&&(el.parentNode.removeChild(el),e.target.removeAttribute("data-original-title"),e.target.removeAttribute("title"),e.target.removeAttribute("aria-describedby")),null!=e.target.getAttribute("data-level-id")&&(levelid=e.target.getAttribute("data-level-id"));const criteria=FeditorHelper.getCriteriaJSON(),criterion=FeditorHelper.getCriterionFromCriteriaCollection(document.getElementById(s.id),criteria),levelsdesc=s.getLevelDescriptors(s.id,criteria,levelid),score=e.target.value;let error=!1,message="";if(/[a-z]/gi.test(e.target.value))error=!0,message="Please insert a number value range";else if(-1==score.indexOf("-")&&-1==score.indexOf("/"))error=!0,message="Invalid value. Accepts min-max or min/max";else{var[min,max]=FeditorHelper.getMinMax(score);0==min.length||0==max.length?error=!0:min.length>0&&max.length>0&&parseFloat(min)>parseFloat(max)&&(error=!0,message="Min value is greater than max value")}if(error)return s.setErrorMessage(e,message),void(error=!1);var groupid;groupid=document.getElementById(s.id).getAttribute("data-criterion-group");const resultRow=document.querySelector('[data-criterion-group="'.concat(groupid,'"][data-row-type="result"]'));var total=resultRow.querySelector("#out-of-value-".concat(groupid)).innerHTML.split("/");total=FeditorHelper.getMaxValueInLevelInCriterion(groupid);const maxinput=resultRow.querySelector(".total-input");levelsdesc[0].score=e.target.value,"CREATED"!=levelsdesc[0].status&&"UPDATED"!=levelsdesc[0].status||(levelsdesc[0].status="UPDATE"),resultRow.querySelector("#out-of-value-".concat(groupid)).innerHTML="/".concat(total),maxinput.setAttribute("max",total),criterion[0].totaloutof=total,FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)},LevelControl.prototype.addDescriptor=function(e){const self=this;e.stopImmediatePropagation(),e.preventDefault();const descriptorContainer=FeditorHelper.getPreviousElement(e.target.parentNode,".standard-desc-container");var positionLevel=0;let id;"edit"!=self.mode||0==descriptorContainer.children.length?(id="".concat(self.id,"-").concat(FeditorHelper.getRandomID()),positionLevel=descriptorContainer.children.length):id="".concat(self.id,"-").concat(descriptorContainer.children[0].getAttribute("id"));var countingdel=!1;if(descriptorContainer.children.length>0&&(positionLevel=descriptorContainer.children.length-1,descriptorContainer.children[0].classList.contains("action-delete-set-desc")&&(countingdel=!0)),null==self.parentid)var editaddnewlevel=!1;else self.parentid.includes("frubric-criteria-NEWID")&&(editaddnewlevel=self.parentid.includes("frubric-criteria-NEWID"));const context={id:id,parentid:self.parentid,edit:"edit"==self.mode,editaddnewlevel:editaddnewlevel,index:countingdel?descriptorContainer.children.length-1:descriptorContainer.children.length,poslevel:positionLevel};"edit"!=self.mode&&delete context.index,Templates.render(self.LEVEL_DESCRIPTOR_INPUT,context).done((function(html,js){let addDeleteSet=!1;0==descriptorContainer.children.length&&(addDeleteSet=!0),descriptorContainer.insertAdjacentHTML("beforeend",html),addDeleteSet&&(descriptorContainer.insertAdjacentHTML("afterbegin",'  <span class="action-delete-set-desc  first-time-render"> <i class="fa fa-close  first-time-render" title="Delete set of descriptors"></i></span>'),descriptorContainer.querySelector(".action-delete-set-desc").addEventListener("click",self.deleteSetCriterion.bind(self)));const container=descriptorContainer.lastChild,action=container.querySelector(".action-el"),checkbox=container.querySelector(".standard-check");container.querySelector(".standard-desc").addEventListener("click",self.clickDescriptorHandler.bind(this,self)),action.addEventListener("click",self.deleteDescriptor.bind(self,descriptorContainer,container)),checkbox.addEventListener("click",self.selectdescriptor.bind(this,self))})).fail((function(ex){Log.debug("error...")}));let criteria=FeditorHelper.getCriteriaJSON();null!=descriptorContainer.lastElementChild&&(FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria))},LevelControl.prototype.clickDescriptorHandler=function(s,e){let descriptor=e.target;descriptor.focus(),e.target.classList.contains("is-invalid")&&(e.target.classList.remove("is-invalid"),e.target.classList.remove("form-control"),e.target.removeAttribute("title")),descriptor.addEventListener("change",s.changeDescriptorHandler.bind(this,s)),descriptor.addEventListener("paste",s.changeDescriptorHandler.bind(this,s))},LevelControl.prototype.changeDescriptorHandler=function(s,e){const criteria=FeditorHelper.getCriteriaJSON(),containerid=e.target.getAttribute("data-container-id");let levelid,descriptorIndex=e.target.parentNode.getAttribute("descriptor-index");null!=descriptorIndex?levelid=e.target.parentNode.getAttribute("id"):descriptorIndex=Array.from(document.getElementById(containerid).parentNode.children).indexOf(e.target.parentNode)-1,null!=levelid&&levelid.includes("-")&&!document.getElementById("id_criteria").classList.contains("is-invalid")&&levelid.slice(levelid.indexOf("-")+1,levelid.length);const levelsdesc=s.getLevelDescriptors(s.id,criteria,levelid);if(descriptorIndex>levelsdesc[0].descriptors.length)for(var i=levelsdesc[0].descriptors.length;i<descriptorIndex;i++)levelsdesc[0].descriptors.push({checked:!1,descText:"",delete:0,descriptorid:0});const desc=levelsdesc[0].descriptors[descriptorIndex];null==desc?levelsdesc[0].descriptors.push({checked:!1,descText:e.target.value,delete:0,descriptorid:0}):desc.descText=e.target.value,"CREATED"!=levelsdesc[0].status&&"UPDATED"!=levelsdesc[0].status||(levelsdesc[0].status="UPDATE"),FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)},LevelControl.prototype.selectdescriptor=function(e,s){const containerid=s.target.getAttribute("data-container-id"),criteria=FeditorHelper.getCriteriaJSON();let levelsdesc,descriptorIndex=s.target.parentNode.getAttribute("descriptor-index");if(null!=descriptorIndex){const levelid=s.target.parentNode.getAttribute("id");levelsdesc=e.getLevelDescriptors(e.id,criteria,levelid)}else descriptorIndex=Array.from(document.getElementById(containerid).parentNode.children).indexOf(s.target.parentNode),levelsdesc=e.getLevelDescriptors(e.id,criteria);levelsdesc[0].descriptors[descriptorIndex].checked=s.target.checked,"CREATED"!=levelsdesc[0].status&&"UPDATED"!=levelsdesc[0].status||(levelsdesc[0].status="UPDATE"),FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)},LevelControl.prototype.deleteDescriptor=function(descriptorContainer,checkboxcontainer){var self=this;if(checkboxcontainer.getAttribute("descriptor-index"))Str.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletedescriptor",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done((function(strs){Notification.confirm(strs[0],strs[1],strs[2],strs[3],(function(){const criteria=FeditorHelper.getCriteriaJSON(),levelid=checkboxcontainer.getAttribute("id"),parentid=self.id,descriptorIndex=checkboxcontainer.getAttribute("descriptor-index"),levelsdesc=self.getLevelDescriptors(parentid,criteria,levelid),d=levelsdesc[0].descriptors[descriptorIndex];if(0!=d.descriptorid){d.delete=1,levelsdesc[0].status="UPDATE";let countdeleted=0;if(levelsdesc[0].descriptors.forEach((function(desc,index){1==desc.delete&&countdeleted++}),countdeleted),levelsdesc[0].descriptors.length==countdeleted){levelsdesc[0].status="DELETE",1==criteria.length&&(criteria[0].status="DELETE"),criteria.forEach((function(criterion){criterion.id==parentid&&(1==criterion.levels.length?criterion.status="DELETE":criterion.status="UPDATE")}),parentid)}}else levelsdesc[0].descriptors.splice(descriptorIndex,1),self.updateDescriptorIndex(descriptorContainer);checkboxcontainer.remove(),FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)}),(function(){}))}));else{const descriptorindex=checkboxcontainer.getAttribute("data-pos-level"),parentid=self.id,criteria=FeditorHelper.getCriteriaJSON(),row=document.getElementById(parentid);FeditorHelper.getCriterionFromCriteriaCollection(row,criteria)[0].levels.filter((function(l){if(l.id==parentid)return l.descriptors}),parentid)[0].descriptors.splice(descriptorindex,1),descriptorContainer.removeChild(checkboxcontainer),self.updateDescriptorIndex(descriptorContainer),FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)}},LevelControl.prototype.deleteSingleDescriptorNotSavedInDB=function(checkboxcontainer){const descriptorindex=checkboxcontainer.getAttribute("data-pos-level"),parentid=self.id,criteria=FeditorHelper.getCriteriaJSON(),row=document.getElementById(parentid);FeditorHelper.getCriterionFromCriteriaCollection(row,criteria)[0].levels.filter((function(l){if(l.id==parentid)return l.descriptors}),parentid)[0].descriptors.splice(descriptorindex,1),descriptorContainer.removeChild(checkboxcontainer),self.updateDescriptorIndex(descriptorContainer),FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)},LevelControl.prototype.updateDescriptorIndex=function(descriptorContainer){$(descriptorContainer).children("div.checkbox-container").each((function(i){this.setAttribute("data-pos-level",i)}))},LevelControl.prototype.deleteSetCriterion=function(e){Str.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletesetcriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done((function(strs){Notification.confirm(strs[0],strs[1],strs[2],strs[3],(function(){const tr=e.target.closest("tr"),table=e.target.closest(".level-mark-desc-table"),criteria=JSON.parse(document.getElementById("id_criteria").value),fromRenderer=e.target.classList.contains("first-time-render");if(1==table.rows.length){const level=table.closest("[data-criterion-group]");fromRenderer||criteria.forEach((function(criterion){if(criterion.id==level.getAttribute("data-criterion-group")){criterion.status="DELETE";Object.values(criterion.levels).forEach((function(level){"NEW"!=level.status&&(level.status="DELETE",criterion.status="UPDATE")}),criterion)}})),level.remove()}else{const crit=tr.closest("[data-criterion-group]"),descriptors=Array.from(e.target.parentNode.nextElementSibling.children),descriptorids=[];descriptors.forEach((function(desc){descriptorids.push(desc.id)}),descriptorids);const data={crit:crit,descids:descriptorids};fromRenderer||criteria.forEach((function(criterion){criterion.id==data.crit.getAttribute("data-criterion-group")&&(criterion.status="UPDATE",Array.isArray(criterion.levels)||(criterion.levels=Object.values(criterion.levels)),criterion.levels.forEach((function(level){data.descids.includes(level.id.toString())&&(level.descriptors.forEach((function(d){d.delete=1})),level.status="DELETE")}),data.descids))}),data),table.deleteRow(tr.rowIndex)}FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria)}),(function(){}))}))},LevelControl.prototype.deleteLevel=function(e){Str.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done((function(strs){Notification.confirm(strs[0],strs[1],strs[2],strs[3],(function(){let criTable=document.getElementById("criteriaTable");const tr=e.target.parentNode.parentNode.parentNode,criterion=FeditorHelper.getPreviousElement(tr,".criterion-header");let criteria=FeditorHelper.getCriteriaJSON();const crid=tr.getAttribute("data-criterion-group");if(criterion.getAttribute("data-criterion-levels").length>0){const dblevelid=JSON.parse(criterion.getAttribute("data-criterion-levels"))[FeditorHelper.getDistanceFromCriterionHeader(tr,".criterion-header")];var levels;for(let i=0;i<criteria.length;i++)if(criteria[i].id==crid){criteria[i].status="UPDATE",levels=criteria[i].levels;break}for(let j=0;j<levels.length;j++)if(levels[j].id==dblevelid){levels[j].status="DELETE";break}}else{const lid=e.target.closest("tr").getAttribute("id"),cid=criterion.getAttribute("id"),d={levelid:parseInt(lid),criterionid:cid};criteria.forEach((function(criterion){criterion.cid==d.criterionid&&(criterion.levels=criterion.levels.filter((function(level){if(level.id!=d.levelid)return level}),d))}),d)}FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria),criTable.deleteRow(tr.rowIndex)}),(function(){}))}))},LevelControl.prototype.editlevelhandler=function(e){let textarea=e.target;textarea.removeAttribute("disabled"),textarea.focus(),textarea.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,textarea)),textarea.addEventListener("focusout",this.focusoutHandlerDisabled)},LevelControl.prototype.changeLevelHandlerDisabled=function(txtarea,e){let id=e.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");const levelrow=e.target.parentNode.parentNode.parentNode,criterionheader=FeditorHelper.getPreviousElement(levelrow,".criterion-header");let leveldbids=criterionheader.getAttribute("data-criterion-levels").length>0?JSON.parse(criterionheader.getAttribute("data-criterion-levels")):[];const criteriaJSON=FeditorHelper.getCriteriaJSON(),rowIndex=e.target.parentNode.parentNode.parentNode.rowIndex;let levelid=id+"_"+rowIndex;leveldbids.length>0&&(levelid=null!=leveldbids[rowIndex-1]?"".concat(id,"_").concat(leveldbids[rowIndex-1]):levelid);const filterCriterion=criteriaJSON.filter((function(criterion,index){const id=e.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");if(criterion.rowindex=index,id==criterion.id)return criterion}),e);if(null!=filterCriterion[0].levels){var lev=null;const critlevs=filterCriterion[0].levels;for(let i=0;i<critlevs.length;i++)if(critlevs[i].id==levelid){lev=critlevs[i];break}if(null!=lev)e.target.classList.contains("mark_txtarea")?lev.score=e.target.value:lev.definition=e.target.value,"CREATED"!=lev.status&&"UPDATED"!=lev.status||(lev.status="UPDATE");else{let criterionLevel={id:levelid,status:"NEW",score:"",definition:""};e.target.classList.contains("mark_txtarea")?criterionLevel.score=e.target.value:criterionLevel.definition=e.target.value,filterCriterion[0].levels.push(criterionLevel)}"edit"==FeditorHelper.getMode()&&(1!=filterCriterion[0].cid.includes("NEWID")?filterCriterion[0].status="UPDATE":filterCriterion[0].status="NEW")}FeditorHelper.setCriteriaJSON(criteriaJSON),FeditorHelper.setHiddenCriteriaJSON(criteriaJSON),e.target.setAttribute("disabled",!0)},LevelControl.prototype.focusoutHandlerDisabled=function(e){e.target.setAttribute("disabled",!0)},LevelControl.prototype.getLevelDescriptors=function(parentid,criteria,levelid){let row="";row=null==document.getElementById(parentid)?document.getElementById(this.level.id):document.getElementById(parentid);const criterion=FeditorHelper.getCriterionFromCriteriaCollection(row,criteria);let ids;null!=levelid&&(parentid=levelid),"edit"==this.mode&&null!=levelid&&levelid.toString().indexOf("-")>-1&&(parentid=levelid.slice(levelid.indexOf("-")+1,levelid.length),ids=levelid.split("-"),ids.forEach((function(id,index){ids[index]=id.toString()}),ids));const obj={mode:this.mode,parentid:parentid,parentidaux:this.parentidaux,ids:ids};0==criterion[0].levels.length&&criterion[0].levels.push({score:"",status:"NEW",id:parentid,descriptors:[{checked:!1,descText:"",delete:0,descriptorid:0}]});const levelsdesc=criterion[0].levels.filter((function(level){if(null!=obj.ids){if(obj.ids.includes(level.id.toString()))return level.descriptors}else if(obj.parentid==level.id.toString()||obj.parentid.toString().includes(level.id.toString()))return level.descriptors}),obj);return FeditorHelper.setCriteriaJSON(criteria),FeditorHelper.setHiddenCriteriaJSON(criteria),levelsdesc},LevelControl.prototype.setErrorMessage=function(e,message){e.target.classList.add("total-input-error"),e.target.setAttribute("data-toggle","tooltip"),e.target.setAttribute("data-placement","right"),e.target.setAttribute("data-title",message)},LevelControl.prototype.validatePreviousMarkValue=function(){const previousLevel=document.getElementById(this.id).previousElementSibling,previousMark=previousLevel.querySelector(".fmark");null!=previousMark&&0==previousMark.value&&""!=previousMark.value&&(previousLevel.classList.add("alert-warning"),previousMark.insertAdjacentHTML("afterend","<small>Change Mark</small>"))},LevelControl.prototype.cleanPreviousMarkWarning=function(){const level=document.getElementById(this.id);level.classList.contains("alert-warning")&&(level.classList.remove("alert-warning"),level.querySelector(".level-mark").removeChild(level.querySelector("small")))},LevelControl.prototype.countSelectedDescriptors=function(){},{init:function(id,parentid){const mode=FeditorHelper.getMode();new LevelControl(document.getElementById(id),mode,id,parentid).main()}}}));

//# sourceMappingURL=level_control.min.js.map