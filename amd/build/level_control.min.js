function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("gradingform_frubric/level_control",["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],function(a,b,c,d,f,g){'use strict';function h(a,b,c,d){var e=this;e.level=a;e.mode=b;e.id=c;e.parentid=d;e.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input"}h.prototype.main=function(){var a=this;if("edit"==a.mode){a.editModeSetupEvents(a.level.nextElementSibling)}else{if(null!=a.level){a.validatePreviousMarkValue();a.setupEvents(a.level)}}};h.prototype.editModeSetupEvents=function(){b.debug("editModeSetupEvents");var c=this,d=c.level.nextElementSibling;b.debug(d.getAttribute("data-row-type"));if("result"==d.getAttribute("data-row-type"))return;c.setupEvents(d);var e=_slicedToArray(d.children,2),f=e[0],g=e[1],h=g.querySelector(".level-mark-desc-table");b.debug(h);var i=h.rows;a(i).each(function(b,d){a(d).children().each(function(b,d){a(d).children().each(function(){var a=this;if(a.classList.contains("standard-desc-container")){c.editModeSetupEventsHelper(a)}if(a.classList.contains("add-descriptor")){a.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c))}})})})};h.prototype.editModeSetupEventsHelper=function(c){var d=this;b.debug("editModeSetupEventsHelper");b.debug(c);var e=0;e=c.children.length;d.descriptorIndex=e;d.parentid=c.children[0].getAttribute("data-parent-id");d.lid=c.children[0].getAttribute("id");a(c).each(function(c,e){a(e).children().each(function(a){var c=this;b.debug(c);if(c.classList.contains("fmark")){return}c.setAttribute("descriptor-index",a);var e=c.querySelector(".action-el"),f=c.querySelector(".standard-check"),g=c.querySelector(".standard-desc");g.addEventListener("click",d.clickDescriptorHandler.bind(this,d));e.addEventListener("click",d.deleteDescriptor.bind(d,g,c));f.addEventListener("click",d.selectdescriptor.bind(this,d))})})};h.prototype.setupEvents=function(a){var c=this;b.debug("Level control: setupEvents");var d=_slicedToArray(a.children,2),e=d[0],f=d[1],g=f.querySelector(".level-mark-desc-table"),h=_slicedToArray(g.rows[0].children,2),i=h[0],j=h[1];i.querySelector(".level-mark > textarea").addEventListener("click",c.editmark.bind(c));if("edit"!=c.mode){j.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c))}e.addEventListener("click",c.deleteLevel.bind(c))};h.prototype.editmark=function(a){b.debug("editmark...");var c=this,d=a.target;if("[Min - Max]"==d.innerHTML){d.innerHTML=""}d.focus();if(!d.classList.contains("changeh")){d.addEventListener("change",c.changeMarkHandler.bind(this,c));d.classList.add("changeh")}};h.prototype.changeMarkHandler=function(a,c){b.debug("changeMarkHandler");a.cleanPreviousMarkWarning();c.target.classList.remove("total-input-error");c.target.removeAttribute("data-toggle");c.target.removeAttribute("data-placement");c.target.removeAttribute("data-title");var d=document.getElementById(c.target.getAttribute("aria-describedby"));if(null!=d){d.parentNode.removeChild(d);c.target.removeAttribute("data-original-title");c.target.removeAttribute("title");c.target.removeAttribute("aria-describedby")}var e=f.getCriteriaJSON(),g=f.getCriterionFromCriteriaCollection(document.getElementById(a.id),e),h=a.getLevelDescriptors(a.id,e),i=c.target.value,j=!1,k="";if(0==i){var l=document.getElementById(a.id).previousElementSibling.getAttribute("data-row-type"),m=document.getElementById(a.id).nextElementSibling.getAttribute("data-row-type");if(!("level"==l&&"result"==m)){j=!0;k="Zero mark only allowed in last level"}}else{if(-1==i.indexOf("-")&&-1==i.indexOf("/")){j=!0;k="Invalid value. Accepts min-max or min/max"}else{var n=a.getMinMaxMark(i),o=_slicedToArray(n,2),p=o[0],q=o[1];if(0==p.length||0==q.length){j=!0}else if(0<p.length&&0<q.length&&parseFloat(p)>parseFloat(q)){j=!0;k="Min value is greater than max value"}}}if(j){a.setErrorMessage(c,k);j=!1;return}var r=document.getElementById(a.parentid).getAttribute("data-criterion-group"),s=document.querySelector("[data-criterion-group=\"".concat(r,"\"][data-row-type=\"result\"]")),t=s.querySelector("#out-of-value-".concat(r)).innerHTML.split("/"),u=s.querySelector(".total-input");h[0].score=c.target.value;t=t[t.length-1];if("-"==t){s.querySelector("#out-of-value-".concat(r)).innerHTML="/".concat(q);t=q}else{if(parseFloat(t)<q){t=q;s.querySelector("#out-of-value-".concat(r)).innerHTML="/".concat(q)}}u.setAttribute("max",t);g[0].totaloutof=t;f.setCriteriaJSON(e)};h.prototype.addDescriptor=function(a){var c=this;a.preventDefault();var d=f.getPreviousElement(a.target.parentNode,".standard-desc-container"),e={id:"edit"!=c.mode?"".concat(c.id,"-").concat(f.getRandomID()):"".concat(c.id,"-").concat(d.children[0].getAttribute("id")),parentid:c.parentid,edit:"edit"==c.mode,index:d.children.length};if("edit"!=c.mode){delete e.index}b.debug("CONTEXT");b.debug(e);g.render(c.LEVEL_DESCRIPTOR_INPUT,e).done(function(a){d.insertAdjacentHTML("beforeend",a);var b=d.lastChild,e=b.querySelector(".action-el"),f=b.querySelector(".standard-check"),g=b.querySelector(".standard-desc");g.addEventListener("click",c.clickDescriptorHandler.bind(this,c));e.addEventListener("click",c.deleteDescriptor.bind(c,d,b));f.addEventListener("click",c.selectdescriptor.bind(this,c))}).fail(function(){b.debug("error...")})};h.prototype.clickDescriptorHandler=function(a,c){b.debug("clickDescriptorHandler...");var d=c.target;if("Click to edit level descriptor"==d.innerHTML){d.innerHTML=""}d.focus();d.addEventListener("change",a.changeDescriptorHandler.bind(this,a))};h.prototype.changeDescriptorHandler=function(a,c){b.debug("changeDescriptorHandler");var d=f.getCriteriaJSON(),e=c.target.getAttribute("data-container-id"),g,h=!1;b.debug(d);var i=c.target.parentNode.getAttribute("descriptor-index");if(null!=i){g=c.target.parentNode.getAttribute("id")}else{i=Array.from(document.getElementById(e).parentNode.children).indexOf(c.target.parentNode)}if(g!=void 0&&g.includes("-")){g.slice(g.indexOf("-")+1,g.length);h=!0}b.debug(g);var j=a.getLevelDescriptors(a.id,d,g),k=j[0].descriptors[i];b.debug(k);if(k==void 0){j[0].descriptors.push({checked:!1,descText:c.target.value,delete:0});if(h){j[0].status="UPDATE"}}else{k.descText=c.target.value;if("CREATED"==j[0].status){j[0].status="UPDATE"}}b.debug(j[0].descriptors);f.setCriteriaJSON(d)};h.prototype.selectdescriptor=function(a,c){b.debug("selectdescriptor");b.debug(a);b.debug(c);var e=c.target.getAttribute("data-container-id"),g=f.getCriteriaJSON(),h,i=c.target.parentNode.getAttribute("descriptor-index");if(null!=i){var d=c.target.parentNode.getAttribute("id");h=a.getLevelDescriptors(a.id,g,d)}else{i=Array.from(document.getElementById(e).parentNode.children).indexOf(c.target.parentNode);h=a.getLevelDescriptors(a.id,g)}b.debug(h);var j=h[0].descriptors[i];j.checked=c.target.checked;if("CREATED"==h[0].status){h[0].status="UPDATE"}f.setCriteriaJSON(g)};h.prototype.deleteDescriptor=function(a,e){b.debug("deleteDescriptor");b.debug(a);b.debug(e);var g=this;b.debug(g);if(e.getAttribute("descriptor-index")){c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletedescriptor",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],function(){b.debug("Notification...");var a=f.getCriteriaJSON(),c=e.getAttribute("id"),h=g.id,i=e.getAttribute("descriptor-index"),j=g.getLevelDescriptors(h,a,c),k=j[0].descriptors[i];k.delete=1;j[0].status="UPDATE";f.setCriteriaJSON(a);e.remove()},function(){})})}else{a.removeChild(e)}};h.prototype.deleteLevel=function(a){b.debug("deleteLevel");b.debug(a);c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){var b=document.getElementById("criteriaTable"),c=a.target.parentNode.parentNode.parentNode,d=f.getPreviousElement(c,".criterion-header"),e=JSON.parse(document.getElementById("id_criteria").value);if(0<d.getAttribute("data-criterion-levels").length){for(var g=JSON.parse(d.getAttribute("data-criterion-levels")),h=f.getDistanceFromCriterionHeader(c,".criterion-header"),k=g[h],l=c.getAttribute("data-criterion-group"),m,n=0;n<e.length;n++){if(e[n].id==l){e[n].status="UPDATE";m=e[n].levels;break}}for(var o=0;o<m.length;o++){if(m[o].dbid==k){m[o].status="DELETE";break}}}document.getElementById("id_criteria").value=JSON.stringify(e);b.deleteRow(c.rowIndex)},function(){})})};h.prototype.editlevelhandler=function(a){b.debug("editlevelhandler");b.debug(a);b.debug(this);var c=a.target;if("Click to edit Level description"==c.innerHTML||"Click to edit Mark"==c.innerHTML){c.innerHTML=""}c.removeAttribute("disabled");c.focus();c.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,c));c.addEventListener("focusout",this.focusoutHandlerDisabled)};h.prototype.changeLevelHandlerDisabled=function(a,c){b.debug("changeLevelHandlerDisabled");var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),e=c.target.parentNode.parentNode.parentNode,g=f.getPreviousElement(e,".criterion-header"),h=0<g.getAttribute("data-criterion-levels").length?JSON.parse(g.getAttribute("data-criterion-levels")):[],j=f.getCriteriaJSON(),k=c.target.parentNode.parentNode.parentNode.rowIndex,l=d+"_"+k;if(0<h.length){l=h[k-1]!=void 0?"".concat(d,"_").concat(h[k-1]):l}var m=j.filter(function(a,b){var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");a.rowindex=b;if(d==a.id){return a}},c);if(m[0].levels!=void 0){for(var n=null,o=m[0].levels,p=0;p<o.length;p++){if(o[p].id!=l){continue}else{n=o[p];break}}if(null!=n){if(c.target.classList.contains("mark_txtarea")){n.score=c.target.value}else{n.definition=c.target.value}if("CREATED"==n.status||"UPDATED"==n.status){n.status="UPDATE"}}else{var q={id:l,status:"NEW",score:"",definition:""};if(c.target.classList.contains("mark_txtarea")){q.score=c.target.value}else{q.definition=c.target.value}m[0].levels.push(q)}if("edit"==f.getMode()){if(!0!=m[0].cid.includes("NEWID")){m[0].status="UPDATE"}else{m[0].status="NEW"}}}document.getElementById("id_criteria").value=JSON.stringify(j);c.target.setAttribute("disabled",!0)};h.prototype.focusoutHandlerDisabled=function(a){b.debug("focusoutHandlerDisabled");a.target.setAttribute("disabled",!0)};h.prototype.getLevelDescriptors=function(a,c,d){var e=this;b.debug("getLevelDescriptors...");b.debug(e);var g=document.getElementById(a);b.debug(g);b.debug(a);var h=f.getCriterionFromCriteriaCollection(g,c);b.debug(h);b.debug(d);if(d!=void 0){a=d}if("edit"==e.mode){a=d.slice(d.indexOf("-")+1,d.length)}var i=h[0].levels.filter(function(b){if(a==b.id){return b.descriptors}},a);return i};h.prototype.getMinMaxMark=function(a){if(-1!=a.indexOf("-")){return a.split("-")}else{return a.split("/")}};h.prototype.setErrorMessage=function(a,c){b.debug(c);a.target.classList.add("total-input-error");a.target.setAttribute("data-toggle","tooltip");a.target.setAttribute("data-placement","right");a.target.setAttribute("data-title",c)};h.prototype.validatePreviousMarkValue=function(){var a=this,c=document.getElementById(a.id).previousElementSibling,d=c.querySelector(".fmark");b.debug("previousMark");if(null!=d&&0==d.value&&""!=d.value){b.debug(d.value);c.classList.add("alert-warning");d.insertAdjacentHTML("afterend","<small>Change Mark</small>")}};h.prototype.cleanPreviousMarkWarning=function(){var a=this,b=document.getElementById(a.id);if(b.classList.contains("alert-warning")){b.classList.remove("alert-warning");b.querySelector(".level-mark").removeChild(b.querySelector("small"))}};h.prototype.countSelectedDescriptors=function(){};return{init:function(a,c){b.debug("Level control...");b.debug(a);var d=f.getMode(),e=document.getElementById(a),g=new h(e,d,a,c);g.main()}}});
//# sourceMappingURL=level_control.min.js.map
