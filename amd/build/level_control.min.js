function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("gradingform_frubric/level_control",["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],function(a,b,c,d,f,g){'use strict';function h(a,b,c,d){var e=this;e.level=a;e.mode=b;e.id=c;e.parentid=d;e.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input"}h.prototype.main=function(){var a=this;if(null!=a.level){a.validatePreviousMarkValue();a.setupEvents(a.level)}};h.prototype.setupEvents=function(a){var c=this;b.debug("Level control: setupEvents");var d=_slicedToArray(a.children,2),e=d[0],f=d[1],g=f.querySelector(".level-mark-desc-table"),h=_slicedToArray(g.rows[0].children,2),i=h[0],j=h[1];i.querySelector(".level-mark > textarea").addEventListener("click",c.editmark.bind(c));j.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c));e.addEventListener("click",c.deleteLevel.bind(c))};h.prototype.editmark=function(a){var b=this,c=a.target;if("[Min - Max]"==c.innerHTML){c.innerHTML=""}c.focus();if(!c.classList.contains("changeh")){c.addEventListener("change",b.changeMarkHandler.bind(this,b));c.classList.add("changeh")}};h.prototype.changeMarkHandler=function(a,c){b.debug("changeMarkHandler");a.cleanPreviousMarkWarning();c.target.classList.remove("total-input-error");c.target.removeAttribute("data-toggle");c.target.removeAttribute("data-placement");c.target.removeAttribute("data-title");var d=document.getElementById(c.target.getAttribute("aria-describedby"));if(null!=d){d.parentNode.removeChild(d);c.target.removeAttribute("data-original-title");c.target.removeAttribute("title");c.target.removeAttribute("aria-describedby")}var e=f.getCriteriaJSON(),g=f.getCriterionFromCriteriaCollection(document.getElementById(a.id),e),h=a.getLevelDescriptors(a.id,e),i=c.target.value,j=!1,k="";if(0==i){var l=document.getElementById(a.id).previousElementSibling.getAttribute("data-row-type"),m=document.getElementById(a.id).nextElementSibling.getAttribute("data-row-type");if(!("level"==l&&"result"==m)){j=!0;k="Zero mark only allowed in last level"}}else{if(-1==i.indexOf("-")&&-1==i.indexOf("/")){j=!0;k="Invalid value. Accepts min-max or min/max"}else{var n=a.getMinMaxMark(i),o=_slicedToArray(n,2),p=o[0],q=o[1];if(0==p.length||0==q.length){j=!0}else if(0<p.length&&0<q.length&&parseFloat(p)>parseFloat(q)){j=!0;k="Min value is greater than max value"}}}if(j){a.setErrorMessage(c,k);j=!1;return}var r=document.getElementById(a.parentid).getAttribute("data-criterion-group"),s=document.querySelector("[data-criterion-group=\"".concat(r,"\"][data-row-type=\"result\"]")),t=s.querySelector("#out-of-value-1").innerHTML.split("/"),u=s.querySelector(".total-input");h[0].score=c.target.value;t=t[t.length-1];if("-"==t){s.querySelector("#out-of-value-".concat(r)).innerHTML="/".concat(q);t=q}else{if(parseFloat(t)<q){t=q;s.querySelector("#out-of-value-".concat(r)).innerHTML="/".concat(q)}}u.setAttribute("max",t);g[0].totaloutof=t;f.setCriteriaJSON(e)};h.prototype.addDescriptor=function(a){var c=this;a.preventDefault();var d=f.getPreviousElement(a.target.parentNode,".standard-desc-container"),e={id:"".concat(c.id,"-").concat(f.getRandomID()),parentid:c.parentid};g.render(c.LEVEL_DESCRIPTOR_INPUT,e).done(function(a){d.insertAdjacentHTML("beforeend",a);var b=d.lastChild,e=b.querySelector(".action-el"),f=b.querySelector(".standard-check"),g=b.querySelector(".standard-desc");g.addEventListener("click",c.clickDescriptorHandler.bind(this,c));e.addEventListener("click",c.deleteDescriptor.bind(this,d,b));f.addEventListener("click",c.selectdescriptor.bind(this,c))}).fail(function(){b.debug("error...")})};h.prototype.clickDescriptorHandler=function(a,c){b.debug("clickDescriptorHandler...");var d=c.target;if("Click to edit level descriptor"==d.innerHTML){d.innerHTML=""}d.focus();d.addEventListener("change",a.changeDescriptorHandler.bind(this,a))};h.prototype.changeDescriptorHandler=function(a,c){b.debug("changeDescriptorHandler");var d=f.getCriteriaJSON(),e=a.getLevelDescriptors(a.id,d);b.debug(e);e[0].descriptors.push({checked:!1,descText:c.target.value,delete:0});f.setCriteriaJSON(d)};h.prototype.selectdescriptor=function(a,c){b.debug("selectdescriptor");var e=c.target.getAttribute("data-container-id"),g=Array.from(document.getElementById(e).parentNode.children).indexOf(c.target.parentNode),h=f.getCriteriaJSON(),i=a.getLevelDescriptors(a.id,h);b.debug(i);var j=i[0].descriptors[g];j.checked=c.target.checked;f.setCriteriaJSON(h)};h.prototype.deleteDescriptor=function(a,c){b.debug("deleteDescriptor");b.debug(c);b.debug(a);a.removeChild(c)};h.prototype.deleteLevel=function(a){b.debug("deleteLevel");b.debug(a);c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){var c=document.getElementById("criteriaTable"),d=a.target.parentNode.parentNode.parentNode,e=f.getPreviousElement(d,".criterion-header"),g=JSON.parse(document.getElementById("id_criteria").value);if(0<e.getAttribute("data-criterion-levels").length){for(var h=JSON.parse(e.getAttribute("data-criterion-levels")),k=f.getDistanceFromCriterionHeader(d,".criterion-header"),l=h[k],m=d.getAttribute("data-criterion-group"),n,o=0;o<g.length;o++){if(g[o].id==m){b.debug("en el if");g[o].status="UPDATE";n=g[o].levels;break}}for(var p=0;p<n.length;p++){if(n[p].dbid==l){n[p].status="DELETE";break}}}document.getElementById("id_criteria").value=JSON.stringify(g);c.deleteRow(d.rowIndex)},function(){})})};h.prototype.editlevelhandler=function(a){b.debug("editlevelhandler");b.debug(a);b.debug(this);var c=a.target;if("Click to edit Level description"==c.innerHTML||"Click to edit Mark"==c.innerHTML){c.innerHTML=""}c.removeAttribute("disabled");c.focus();c.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,c));c.addEventListener("focusout",this.focusoutHandlerDisabled)};h.prototype.changeLevelHandlerDisabled=function(a,c){b.debug("changeLevelHandlerDisabled");var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),e=c.target.parentNode.parentNode.parentNode,g=f.getPreviousElement(e,".criterion-header"),h=0<g.getAttribute("data-criterion-levels").length?JSON.parse(g.getAttribute("data-criterion-levels")):[],j=f.getCriteriaJSON(),k=c.target.parentNode.parentNode.parentNode.rowIndex,l=d+"_"+k;if(0<h.length){l=h[k-1]!=void 0?"".concat(d,"_").concat(h[k-1]):l}var m=j.filter(function(a,b){var d=c.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");a.rowindex=b;if(d==a.id){return a}},c);if(m[0].levels!=void 0){for(var n=null,o=m[0].levels,p=0;p<o.length;p++){if(o[p].id!=l){continue}else{n=o[p];break}}if(null!=n){if(c.target.classList.contains("mark_txtarea")){n.score=c.target.value}else{n.definition=c.target.value}if("CREATED"==n.status||"UPDATED"==n.status){n.status="UPDATE"}}else{var q={id:l,status:"NEW",score:"",definition:""};if(c.target.classList.contains("mark_txtarea")){q.score=c.target.value}else{q.definition=c.target.value}m[0].levels.push(q)}if("edit"==f.getMode()){if(!0!=m[0].cid.includes("NEWID")){m[0].status="UPDATE"}else{m[0].status="NEW"}}}document.getElementById("id_criteria").value=JSON.stringify(j);c.target.setAttribute("disabled",!0)};h.prototype.focusoutHandlerDisabled=function(a){b.debug("focusoutHandlerDisabled");a.target.setAttribute("disabled",!0)};h.prototype.updateLevelObject=function(){var a=f.getCriteriaJSON(),b=f.getCriterionFromCriteriaCollection(row)};h.prototype.getLevelDescriptors=function(a,b){var c=document.getElementById(a),d=f.getCriterionFromCriteriaCollection(c,b),e=d[0].levels.filter(function(b){if(a==b.id){return b.descriptors}},a);return e};h.prototype.getMinMaxMark=function(a){if(-1!=a.indexOf("-")){return a.split("-")}else{return a.split("/")}};h.prototype.setErrorMessage=function(a,c){b.debug(c);a.target.classList.add("total-input-error");a.target.setAttribute("data-toggle","tooltip");a.target.setAttribute("data-placement","right");a.target.setAttribute("data-title",c)};h.prototype.validatePreviousMarkValue=function(){var a=this,c=document.getElementById(a.id).previousElementSibling,d=c.querySelector(".fmark");b.debug("previousMark");if(null!=d&&0==d.value&&""!=d.value){b.debug(d.value);c.classList.add("alert-warning");d.insertAdjacentHTML("afterend","<small>Change Mark</small>")}};h.prototype.cleanPreviousMarkWarning=function(){var a=this,b=document.getElementById(a.id);if(b.classList.contains("alert-warning")){b.classList.remove("alert-warning");b.querySelector(".level-mark").removeChild(b.querySelector("small"))}};return{init:function(a,c){b.debug("Level control...");b.debug(a);var d=f.getMode(),e=document.getElementById(a),g=new h(e,d,a,c);g.main()}}});
//# sourceMappingURL=level_control.min.js.map
