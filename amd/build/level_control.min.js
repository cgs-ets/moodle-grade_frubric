function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArrayLimit(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("gradingform_frubric/level_control",["jquery","core/log","core/str","core/notification","gradingform_frubric/feditor_helper","core/templates"],function(a,b,c,d,f,g){'use strict';function h(a,b,c,d){var e=this;e.level=a;e.mode=b;e.id=c;e.parentid=d;e.parentidaux=d;e.LEVEL_DESCRIPTOR_INPUT="gradingform_frubric/level_descriptor_input";e.LEVEL_DECRIPTORS_DELETE_SET="gradingform_frubric/level_decriptors_delete_set"}h.prototype.main=function(){var a=this;if("edit"==a.mode){if(a.level.classList.contains("criterion-header")){a.editModeSetupEvents(a.level.nextElementSibling)}else{a.editModeSetupEvents(a.level)}}else{if(null!=a.level){a.validatePreviousMarkValue();a.setupEvents(a.level)}}};h.prototype.editModeSetupEvents=function(b){var c=this;if("result"==b.getAttribute("data-row-type")||"add-level-r"==b.getAttribute("data-row-type")){b=b.previousElementSibling}var d=_slicedToArray(b.children,2),e=d[0],f=d[1],g=f.querySelector(".level-mark-desc-table");if(g){var h=g.closest("tr");h=a(h).children("td:first")[0];h.querySelector(".action-el").addEventListener("click",c.deleteLevel.bind(c));var i=g.rows;a(i).each(function(b,d){a(d).children().each(function(b,d){if(d.classList.contains("level-mark")){d.querySelector(".level-mark > textarea").addEventListener("focus",c.editmark.bind(c))}a(d).children().each(function(){var a=this;if(a.classList.contains("standard-desc-container")){c.editModeSetupEventsHelper(a)}if(a.classList.contains("add-descriptor")){a.querySelector(".add-desc-btn").addEventListener("click",c.addDescriptor.bind(c))}if(a.classList.contains("action-delete-set-desc")){a.addEventListener("click",c.deleteSetCriterion.bind(c))}})})})}};h.prototype.editModeSetupEventsHelper=function(b){var c=this,d=0;d=b.children.length;if(0<d){c.descriptorIndex=d;c.parentid=b.children[0].getAttribute("data-parent-id");c.lid=b.children[0].getAttribute("id");a(b).each(function(b,d){a(d).children().each(function(a){var b=this;if(b.classList.contains("fmark")){return}b.setAttribute("descriptor-index",a);var d=b.querySelector(".action-el"),e=b.querySelector(".standard-check"),f=b.querySelector(".standard-desc");f.addEventListener("click",c.clickDescriptorHandler.bind(this,c));f.addEventListener("focus",c.clickDescriptorHandler.bind(this,c));d.addEventListener("click",c.deleteDescriptor.bind(c,f,b));e.addEventListener("click",c.selectdescriptor.bind(this,c))})})}};h.prototype.setupEvents=function(a){var b=this,c=_slicedToArray(a.children,2),d=c[0],e=c[1],f=e.querySelector(".level-mark-desc-table");if(f){var g=_slicedToArray(f.rows[0].children,2),h=g[0],i=g[1];h.querySelector(".level-mark > textarea").addEventListener("focus",b.editmark.bind(b));if("edit"!=b.mode){i.querySelector(".add-desc-btn").addEventListener("click",b.addDescriptor.bind(b))}d.addEventListener("click",b.deleteLevel.bind(b))}};h.prototype.editmark=function(a){var b=this,c=a.target;if("[Min - Max]"==c.innerHTML){c.innerHTML=""}if(a.target.classList.contains("is-invalid")){a.target.classList.remove("is-invalid");a.target.classList.remove("form-control");a.target.removeAttribute("title")}c.focus();if(!c.classList.contains("changeh")){c.addEventListener("change",b.changeMarkHandler.bind(this,b));c.classList.add("changeh")}};h.prototype.changeMarkHandler=function(a,b){a.cleanPreviousMarkWarning();b.target.classList.remove("total-input-error");b.target.removeAttribute("data-toggle");b.target.removeAttribute("data-placement");b.target.removeAttribute("data-title");var c=document.getElementById(b.target.getAttribute("aria-describedby"));if(null!=c){c.parentNode.removeChild(c);b.target.removeAttribute("data-original-title");b.target.removeAttribute("title");b.target.removeAttribute("aria-describedby")}var d;if(null!=b.target.getAttribute("data-level-id")){d=b.target.getAttribute("data-level-id")}var e=f.getCriteriaJSON(),g=f.getCriterionFromCriteriaCollection(document.getElementById(a.id),e),h=a.getLevelDescriptors(a.id,e,d),i=b.target.value,j=/[a-z]/gi.test(b.target.value),k=!1,l="";if(j){k=!0;l="Please insert a number value range"}else if(0==i){var m=document.getElementById(a.id).previousElementSibling.getAttribute("data-row-type"),n=document.getElementById(a.id).nextElementSibling.getAttribute("data-row-type");if(!("level"==m&&"result"==n)){k=!0;l="Zero mark only allowed in last level"}}else{if(-1==i.indexOf("-")&&-1==i.indexOf("/")){k=!0;l="Invalid value. Accepts min-max or min/max"}else{var o=a.getMinMaxMark(i),p=_slicedToArray(o,2),q=p[0],r=p[1];if(0==q.length||0==r.length){k=!0}else if(0<q.length&&0<r.length&&parseFloat(q)>parseFloat(r)){k=!0;l="Min value is greater than max value"}}}if(k){a.setErrorMessage(b,l);k=!1;return}var s;if(!a.parentid.includes("frubric-criteria-NEWID")){s=document.getElementById(a.id).getAttribute("data-criterion-group")}else{s=document.getElementById(a.parentid).getAttribute("data-criterion-group")}var t=document.querySelector("[data-criterion-group=\"".concat(s,"\"][data-row-type=\"result\"]")),u=t.querySelector("#out-of-value-".concat(s)).innerHTML.split("/"),v=t.querySelector(".total-input");h[0].score=b.target.value;if("CREATED"==h[0].status||"UPDATED"==h[0].status){h[0].status="UPDATE"}u=u[u.length-1];if(""===u){t.querySelector("#out-of-value-".concat(s)).innerHTML="/".concat(r);u=r}else{if(parseFloat(u)<r){u=r;t.querySelector("#out-of-value-".concat(s)).innerHTML="/".concat(r)}}v.setAttribute("max",u);g[0].totaloutof=u;f.setCriteriaJSON(e);f.setHiddenCriteriaJSON(e)};h.prototype.addDescriptor=function(a){var c=this;a.stopImmediatePropagation();a.preventDefault();var d=f.getPreviousElement(a.target.parentNode,".standard-desc-container"),e=0,h;if("edit"!=c.mode||0==d.children.length){h="".concat(c.id,"-").concat(f.getRandomID());e=d.children.length}else{h="".concat(c.id,"-").concat(d.children[0].getAttribute("id"))}var i=!1;if(0<d.children.length){e=d.children.length-1;if(d.children[0].classList.contains("action-delete-set-desc")){i=!0}}if(c.parentid==void 0){var j=!1}else if(c.parentid.includes("frubric-criteria-NEWID")){j=c.parentid.includes("frubric-criteria-NEWID")}var k={id:h,parentid:c.parentid,edit:"edit"==c.mode,editaddnewlevel:j,index:i?d.children.length-1:d.children.length,poslevel:e};if("edit"!=c.mode){delete k.index}g.render(c.LEVEL_DESCRIPTOR_INPUT,k).done(function(a){var b=!1;if(0==d.children.length){b=!0}d.insertAdjacentHTML("beforeend",a);if(b){d.insertAdjacentHTML("afterbegin","  <span class=\"action-delete-set-desc  first-time-render\"> <i class=\"fa fa-close  first-time-render\" title=\"Delete set of descriptors\"></i></span>");d.querySelector(".action-delete-set-desc").addEventListener("click",c.deleteSetCriterion.bind(c))}var e=d.lastChild,f=e.querySelector(".action-el"),g=e.querySelector(".standard-check"),h=e.querySelector(".standard-desc");h.addEventListener("click",c.clickDescriptorHandler.bind(this,c));f.addEventListener("click",c.deleteDescriptor.bind(c,d,e));g.addEventListener("click",c.selectdescriptor.bind(this,c))}).fail(function(){b.debug("error...")});var l=f.getCriteriaJSON(),m=d.lastElementChild;if(null!=m){f.setCriteriaJSON(l);f.setHiddenCriteriaJSON(l)}};h.prototype.clickDescriptorHandler=function(a,b){var c=b.target;c.focus();if(b.target.classList.contains("is-invalid")){b.target.classList.remove("is-invalid");b.target.classList.remove("form-control");b.target.removeAttribute("title")}c.addEventListener("change",a.changeDescriptorHandler.bind(this,a));c.addEventListener("paste",a.changeDescriptorHandler.bind(this,a))};h.prototype.changeDescriptorHandler=function(a,b){var c=f.getCriteriaJSON(),d=b.target.getAttribute("data-container-id"),e,g=b.target.parentNode.getAttribute("descriptor-index");if(null!=g){e=b.target.parentNode.getAttribute("id")}else{g=Array.from(document.getElementById(d).parentNode.children).indexOf(b.target.parentNode)-1}if(e!=void 0&&e.includes("-")&&!document.getElementById("id_criteria").classList.contains("is-invalid")){e.slice(e.indexOf("-")+1,e.length)}var h=a.getLevelDescriptors(a.id,c,e);if(g>h[0].descriptors.length){for(var j=h[0].descriptors.length;j<g;j++){h[0].descriptors.push({checked:!1,descText:"",delete:0,descriptorid:0})}}var k=h[0].descriptors[g];if(k==void 0){h[0].descriptors.push({checked:!1,descText:b.target.value,delete:0,descriptorid:0})}else{k.descText=b.target.value}if("CREATED"==h[0].status||"UPDATED"==h[0].status){h[0].status="UPDATE"}f.setCriteriaJSON(c);f.setHiddenCriteriaJSON(c)};h.prototype.selectdescriptor=function(a,b){var c=b.target.getAttribute("data-container-id"),e=f.getCriteriaJSON(),g,h=b.target.parentNode.getAttribute("descriptor-index");if(null!=h){var d=b.target.parentNode.getAttribute("id");g=a.getLevelDescriptors(a.id,e,d)}else{h=Array.from(document.getElementById(c).parentNode.children).indexOf(b.target.parentNode);g=a.getLevelDescriptors(a.id,e)}var i=g[0].descriptors[h];i.checked=b.target.checked;if("CREATED"==g[0].status||"UPDATED"==g[0].status){g[0].status="UPDATE"}f.setCriteriaJSON(e);f.setHiddenCriteriaJSON(e)};h.prototype.deleteDescriptor=function(a,b){var e=this;if(b.getAttribute("descriptor-index")){c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletedescriptor",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(c){d.confirm(c[0],c[1],c[2],c[3],function(){var c=f.getCriteriaJSON(),g=b.getAttribute("id"),h=e.id,i=b.getAttribute("descriptor-index"),j=e.getLevelDescriptors(h,c,g),k=j[0].descriptors[i];if(0!=k.descriptorid){k.delete=1;j[0].status="UPDATE";var d=0;j[0].descriptors.forEach(function(a){if(1==a.delete){d++}},d);if(j[0].descriptors.length==d){j[0].status="DELETE";if(1==c.length){c[0].status="DELETE"}c.forEach(function(a){if(a.id==h){if(1==a.levels.length){a.status="DELETE"}else{a.status="UPDATE"}}},h)}}else{j[0].descriptors.splice(i,1);e.updateDescriptorIndex(a)}b.remove();f.setCriteriaJSON(c);f.setHiddenCriteriaJSON(c)},function(){})})}else{var g=b.getAttribute("data-pos-level"),h=e.id,i=f.getCriteriaJSON(),j=document.getElementById(h),k=f.getCriterionFromCriteriaCollection(j,i),l=k[0].levels.filter(function(a){if(a.id==h){return a.descriptors}},h),m=l[0].descriptors;m.splice(g,1);a.removeChild(b);e.updateDescriptorIndex(a);f.setCriteriaJSON(i);f.setHiddenCriteriaJSON(i)}};h.prototype.deleteSingleDescriptorNotSavedInDB=function(a){var b=a.getAttribute("data-pos-level"),c=self.id,d=f.getCriteriaJSON(),e=document.getElementById(c),g=f.getCriterionFromCriteriaCollection(e,d),h=g[0].levels.filter(function(a){if(a.id==c){return a.descriptors}},c),i=h[0].descriptors;i.splice(b,1);descriptorContainer.removeChild(a);self.updateDescriptorIndex(descriptorContainer);f.setCriteriaJSON(d);f.setHiddenCriteriaJSON(d)};h.prototype.updateDescriptorIndex=function(b){a(b).children("div.checkbox-container").each(function(a){this.setAttribute("data-pos-level",a)})};h.prototype.deleteSetCriterion=function(a){c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletesetcriterion",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){var b=a.target.closest("tr"),c=a.target.closest(".level-mark-desc-table"),d=JSON.parse(document.getElementById("id_criteria").value),e=a.target.classList.contains("first-time-render");if(1==c.rows.length){var j=c.closest("[data-criterion-group]");if(!e){d.forEach(function(a){if(a.id==j.getAttribute("data-criterion-group")){a.status="DELETE";var b=Object.values(a.levels);b.forEach(function(b){if("NEW"!=b.status){b.status="DELETE";a.status="UPDATE"}},a)}})}j.remove()}else{var g=b.closest("[data-criterion-group]"),h=Array.from(a.target.parentNode.nextElementSibling.children),i=[];h.forEach(function(a){i.push(a.id)},i);var k={crit:g,descids:i};if(!e){d.forEach(function(a){if(a.id==k.crit.getAttribute("data-criterion-group")){a.status="UPDATE";if(!Array.isArray(a.levels)){a.levels=Object.values(a.levels)}a.levels.forEach(function(a){if(k.descids.includes(a.id.toString())){a.descriptors.forEach(function(a){a.delete=1});a.status="DELETE"}},k.descids)}},k)}c.deleteRow(b.rowIndex)}f.setCriteriaJSON(d);f.setHiddenCriteriaJSON(d)},function(){})})};h.prototype.deleteLevel=function(a){c.get_strings([{key:"confirm",component:"gradingform_frubric"},{key:"confirmdeletelevel",component:"gradingform_frubric"},{key:"yes"},{key:"no"}]).done(function(b){d.confirm(b[0],b[1],b[2],b[3],function(){var b=document.getElementById("criteriaTable"),c=a.target.parentNode.parentNode.parentNode,e=f.getPreviousElement(c,".criterion-header"),g=f.getCriteriaJSON(),h=c.getAttribute("data-criterion-group");if(0<e.getAttribute("data-criterion-levels").length){for(var k=JSON.parse(e.getAttribute("data-criterion-levels")),l=f.getDistanceFromCriterionHeader(c,".criterion-header"),m=k[l],n,o=0;o<g.length;o++){if(g[o].id==h){g[o].status="UPDATE";n=g[o].levels;break}}for(var d=0;d<n.length;d++){if(n[d].id==m){n[d].status="DELETE";break}}}else{var p=a.target.closest("tr"),q=p.getAttribute("id"),r=e.getAttribute("id"),s={levelid:parseInt(q),criterionid:r};g.forEach(function(a){if(a.cid==s.criterionid){a.levels=a.levels.filter(function(a){if(a.id!=s.levelid){return a}},s)}},s)}f.setCriteriaJSON(g);f.setHiddenCriteriaJSON(g);b.deleteRow(c.rowIndex)},function(){})})};h.prototype.editlevelhandler=function(a){var b=a.target;b.removeAttribute("disabled");b.focus();b.addEventListener("change",this.changeLevelHandlerDisabled.bind(this,b));b.addEventListener("focusout",this.focusoutHandlerDisabled)};h.prototype.changeLevelHandlerDisabled=function(a,b){var c=b.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group"),d=b.target.parentNode.parentNode.parentNode,e=f.getPreviousElement(d,".criterion-header"),g=0<e.getAttribute("data-criterion-levels").length?JSON.parse(e.getAttribute("data-criterion-levels")):[],h=f.getCriteriaJSON(),j=b.target.parentNode.parentNode.parentNode.rowIndex,k=c+"_"+j;if(0<g.length){k=g[j-1]!=void 0?"".concat(c,"_").concat(g[j-1]):k}var l=h.filter(function(a,c){var d=b.target.parentNode.parentNode.parentNode.getAttribute("data-criterion-group");a.rowindex=c;if(d==a.id){return a}},b);if(l[0].levels!=void 0){for(var m=null,n=l[0].levels,o=0;o<n.length;o++){if(n[o].id!=k){continue}else{m=n[o];break}}if(null!=m){if(b.target.classList.contains("mark_txtarea")){m.score=b.target.value}else{m.definition=b.target.value}if("CREATED"==m.status||"UPDATED"==m.status){m.status="UPDATE"}}else{var p={id:k,status:"NEW",score:"",definition:""};if(b.target.classList.contains("mark_txtarea")){p.score=b.target.value}else{p.definition=b.target.value}l[0].levels.push(p)}if("edit"==f.getMode()){if(!0!=l[0].cid.includes("NEWID")){l[0].status="UPDATE"}else{l[0].status="NEW"}}}f.setCriteriaJSON(h);f.setHiddenCriteriaJSON(h);b.target.setAttribute("disabled",!0)};h.prototype.focusoutHandlerDisabled=function(a){a.target.setAttribute("disabled",!0)};h.prototype.getLevelDescriptors=function(a,b,c){var d=this,e="";if(null==document.getElementById(a)){e=document.getElementById(d.level.id)}else{e=document.getElementById(a)}var g=f.getCriterionFromCriteriaCollection(e,b),h;if(c!=void 0){a=c}if("edit"==d.mode&&c!=void 0){if(-1<c.toString().indexOf("-")){a=c.slice(c.indexOf("-")+1,c.length);h=c.split("-");h.forEach(function(a,b){h[b]=a.toString()},h)}}var i={mode:d.mode,parentid:a,parentidaux:d.parentidaux,ids:h};if(0==g[0].levels.length){g[0].levels.push({score:"",status:"NEW",id:a,descriptors:[{checked:!1,descText:"",delete:0,descriptorid:0}]})}var j=g[0].levels.filter(function(a){if(i.ids!=void 0){if(i.ids.includes(a.id.toString())){return a.descriptors}}else if(i.parentid==a.id.toString()||i.parentid.toString().includes(a.id.toString())){return a.descriptors}},i);f.setCriteriaJSON(b);f.setHiddenCriteriaJSON(b);return j};h.prototype.getMinMaxMark=function(a){if(-1!=a.indexOf("-")){return a.split("-")}else{return a.split("/")}};h.prototype.setErrorMessage=function(a,b){a.target.classList.add("total-input-error");a.target.setAttribute("data-toggle","tooltip");a.target.setAttribute("data-placement","right");a.target.setAttribute("data-title",b)};h.prototype.validatePreviousMarkValue=function(){var a=this,b=document.getElementById(a.id).previousElementSibling,c=b.querySelector(".fmark");if(null!=c&&0==c.value&&""!=c.value){b.classList.add("alert-warning");c.insertAdjacentHTML("afterend","<small>Change Mark</small>")}};h.prototype.cleanPreviousMarkWarning=function(){var a=this,b=document.getElementById(a.id);if(b.classList.contains("alert-warning")){b.classList.remove("alert-warning");b.querySelector(".level-mark").removeChild(b.querySelector("small"))}};h.prototype.countSelectedDescriptors=function(){};return{init:function(a,b){var c=f.getMode(),d=document.getElementById(a),e=new h(d,c,a,b);e.main()}}});
//# sourceMappingURL=level_control.min.js.map
