{"version":3,"file":"feditor.min.js","sources":["../src/feditor.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable promise/always-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/log', 'core/templates', 'gradingform_frubric/feditor_helper'],\n    function (Log, Templates, FeditorHelper) {\n        'use strict';\n\n        function init() {\n            const mode = FeditorHelper.getMode();\n            let criterioncollection;\n         \n            // In case the all the rubric is deleted and saved in the DB. We need to put an empty one again.\n            //Otherwise the add button submits the form.\n            const empty = JSON.parse(document.getElementById('id_criteria').value).length == 0;\n            \n            if (mode === 'create' && empty) {\n                // Initialise the first criterion\n                var criterion = {\n                    id: '1',\n                    cid: `frubric-criteria-NEWID${document.querySelectorAll(\".criterion-header\").length}`, // Criterion ID for the DB\n                    status: \"NEW\",\n                    description: \"\", // Criterion descrption\n                    rowindex: 1, // Keep track of the header row.\n                    definitionid: document\n                        .getElementById(\"cont\")\n                        .getAttribute(\"data-definition-id\"), // Id from mdl_grading_definitions/\n                    levels: [],\n                    sumscore: \"\",\n                    totaloutof: \"\"\n                };\n\n                criterioncollection = [criterion]; // Collects all the criterions\n\n                FeditorHelper.setCriteriaJSON(criterioncollection);\n                FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n\n            }\n            if (mode === 'edit' || (mode === 'create' && document.getElementById('id_criteria').classList.contains('is-invalid') != undefined)) { // Validation error, keep the values inserted\n                criterioncollection = document.getElementById('id_criteria').value;\n\n            } else {\n                // Initialise the first criterion\n                var criterion = {\n                    id: \"1\",\n                    cid: `frubric-criteria-NEWID${document.querySelectorAll(\".criterion-header\").length}`, // Criterion ID for the DB\n                    status: \"NEW\",\n                    description: \"\", // Criterion descrption\n                    rowindex: 1, // Keep track of the header row.\n                    definitionid: document\n                        .getElementById(\"cont\")\n                        .getAttribute(\"data-definition-id\"), // Id from mdl_grading_definitions/\n                    levels: [],\n                    sumscore: \"\",\n                    totaloutof: \"\",\n                };\n\n                criterioncollection = [criterion]; // Collects all the criterions\n               \n                FeditorHelper.setCriteriaJSON(criterioncollection);\n                FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n\n            }\n\n            let control = new Feditor(criterioncollection);\n            control.main();\n\n        }\n\n        /**\n         *\n         * @param {*} criterioncollection\n         */\n        function Feditor(criterioncollection) {\n            let self = this;\n            self.CRITERION_ROW = 'gradingform_frubric/editor_criterion_row';\n            self.FEDITOR = 'gradingform_frubric/frubriceditor';\n            self.criterioncollection = criterioncollection;\n        }\n\n        /**\n         * Run the controller.\n         *\n         */\n        Feditor.prototype.main = function () {\n            let self = this;\n            self.setupEvents();\n\n        };\n\n        Feditor.prototype.setupEvents = function () {\n            let self = this;\n            // Add criterio btn\n            document.getElementById('addCriterion').addEventListener('click', self.addCriterion.bind(this));\n        };\n\n        Feditor.prototype.addCriterion = function () {\n            let self = this;\n\n            const countcriteria = document.querySelectorAll('.criterion-header').length;\n            // Set context\n            const context = {\n                id: `frubric-criteria-NEWID${countcriteria + 1}`,\n                criteriongroupid: countcriteria + 1,\n                new: 1, // Adds the result row\n            };\n\n\n            Templates.render(self.CRITERION_ROW, context)\n                .done(function (html, js) {\n\n                    Templates.appendNodeContents(document.getElementById('criteriaTable'), html, js);\n                    const cr = document.querySelector(\"tbody\").lastElementChild;\n\n                    let criterion = {\n                        id: cr.getAttribute('data-criterion-group'),\n                        cid: `frubric-criteria-NEWID${countcriteria + 1}`, // Criterion ID for the DB\n                        status: 'NEW',\n                        new: 1, // to add the result row\n                        description: '', // Criterion descrption\n                        rowindex: cr.rowIndex, // Keep track of the header row.\n                        definitionid: document.getElementById('cont').getAttribute('data-definition-id'), // Id from mdl_grading_definitions\n                        levels: [],\n                        sumscore: \"\",\n                    };\n\n\n                    if (FeditorHelper.getCriteriaJSON() != '') {\n                        self.criterioncollection = JSON.parse(document.getElementById('id_criteria').value);\n                    }\n\n                    self.criterioncollection.push(criterion);\n                    FeditorHelper.setCriteriaJSON(self.criterioncollection);\n                    FeditorHelper.setHiddenCriteriaJSON(self.criterioncollection);\n\n                })\n                .fail(function (ex) {\n                    Log.debug(ex);\n                });\n\n\n        };\n\n        return {\n            init: init\n        };\n    });"],"names":["define","Log","Templates","FeditorHelper","Feditor","criterioncollection","this","CRITERION_ROW","FEDITOR","prototype","main","setupEvents","document","getElementById","addEventListener","addCriterion","bind","self","countcriteria","querySelectorAll","length","context","id","criteriongroupid","new","render","done","html","js","appendNodeContents","cr","querySelector","lastElementChild","criterion","getAttribute","cid","status","description","rowindex","rowIndex","definitionid","levels","sumscore","getCriteriaJSON","JSON","parse","value","push","setCriteriaJSON","setHiddenCriteriaJSON","fail","ex","debug","init","mode","getMode","empty","totaloutof","undefined","classList","contains"],"mappings":";;;;;AAwBAA,qCAAO,CAAC,WAAY,iBAAkB,uCAClC,SAAUC,IAAKC,UAAWC,wBAoEbC,QAAQC,qBACFC,KACNC,cAAgB,2CADVD,KAENE,QAAU,oCAFJF,KAGND,oBAAsBA,2BAO/BD,QAAQK,UAAUC,KAAO,WACVJ,KACNK,eAITP,QAAQK,UAAUE,YAAc,WAG5BC,SAASC,eAAe,gBAAgBC,iBAAiB,QAF9CR,KAE4DS,aAAaC,KAAKV,QAG7FF,QAAQK,UAAUM,aAAe,eACzBE,KAAOX,KAELY,cAAgBN,SAASO,iBAAiB,qBAAqBC,OAE/DC,QAAU,CACZC,mCAA6BJ,cAAgB,GAC7CK,iBAAkBL,cAAgB,EAClCM,IAAK,GAITtB,UAAUuB,OAAOR,KAAKV,cAAec,SAChCK,MAAK,SAAUC,KAAMC,IAElB1B,UAAU2B,mBAAmBjB,SAASC,eAAe,iBAAkBc,KAAMC,QACvEE,GAAKlB,SAASmB,cAAc,SAASC,iBAEvCC,UAAY,CACZX,GAAIQ,GAAGI,aAAa,wBACpBC,oCAA8BjB,cAAgB,GAC9CkB,OAAQ,MACRZ,IAAK,EACLa,YAAa,GACbC,SAAUR,GAAGS,SACbC,aAAc5B,SAASC,eAAe,QAAQqB,aAAa,sBAC3DO,OAAQ,GACRC,SAAU,IAIyB,IAAnCvC,cAAcwC,oBACd1B,KAAKZ,oBAAsBuC,KAAKC,MAAMjC,SAASC,eAAe,eAAeiC,QAGjF7B,KAAKZ,oBAAoB0C,KAAKd,WAC9B9B,cAAc6C,gBAAgB/B,KAAKZ,qBACnCF,cAAc8C,sBAAsBhC,KAAKZ,wBAG5C6C,MAAK,SAAUC,IACZlD,IAAImD,MAAMD,QAMf,CACHE,oBAtIIhD,oBADEiD,KAAOnD,cAAcoD,UAKrBC,MAA2E,GAAnEZ,KAAKC,MAAMjC,SAASC,eAAe,eAAeiC,OAAO1B,OAE1D,WAATkC,MAAqBE,QAgBrBnD,oBAAsB,CAdN,CACZiB,GAAI,IACJa,oCAA8BvB,SAASO,iBAAiB,qBAAqBC,QAC7EgB,OAAQ,MACRC,YAAa,GACbC,SAAU,EACVE,aAAc5B,SACTC,eAAe,QACfqB,aAAa,sBAClBO,OAAQ,GACRC,SAAU,GACVe,WAAY,KAKhBtD,cAAc6C,gBAAgB3C,qBAC9BF,cAAc8C,sBAAsB5C,sBAG3B,SAATiD,MAA6B,WAATA,MAAgGI,MAA3E9C,SAASC,eAAe,eAAe8C,UAAUC,SAAS,cACnGvD,oBAAsBO,SAASC,eAAe,eAAeiC,OAkB7DzC,oBAAsB,CAdN,CACZiB,GAAI,IACJa,oCAA8BvB,SAASO,iBAAiB,qBAAqBC,QAC7EgB,OAAQ,MACRC,YAAa,GACbC,SAAU,EACVE,aAAc5B,SACTC,eAAe,QACfqB,aAAa,sBAClBO,OAAQ,GACRC,SAAU,GACVe,WAAY,KAKhBtD,cAAc6C,gBAAgB3C,qBAC9BF,cAAc8C,sBAAsB5C,sBAI1B,IAAID,QAAQC,qBAClBK,QAiFf"}