{"version":3,"sources":["../src/feditor.js"],"names":["define","$","Log","Templates","FeditorHelper","Rerender","Feditor","criterioncollection","debug","self","CRITERION_ROW","FEDITOR","prototype","main","setupEvents","document","getElementById","addEventListener","addCriterion","bind","countcriteria","querySelectorAll","length","context","id","criteriongroupid","new","render","done","html","js","appendNodeContents","cr","querySelector","lastElementChild","criterion","getAttribute","cid","status","description","rowindex","rowIndex","definitionid","levels","sumscore","getCriteriaJSON","JSON","parse","value","push","setCriteriaJSON","fail","ex","isreadytouse","setAttribute","init","mode","getMode","classList","contains","totaloutof","stringify","control"],"mappings":"AAwBAA,OAAM,+BAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,gBAAvB,CAAyC,oCAAzC,CAA+E,sCAA/E,CAAD,CACF,SAAUC,CAAV,CAAaC,CAAb,CAAkBC,CAAlB,CAA6BC,CAA7B,CAA4CC,CAA5C,CAAsD,CAClD,aAsDA,QAASC,CAAAA,CAAT,CAAiBC,CAAjB,CAAsC,CAClCL,CAAG,CAACM,KAAJ,CAAU,0BAAV,EACA,GAAIC,CAAAA,CAAI,CAAG,IAAX,CACAA,CAAI,CAACC,aAAL,CAAqB,0CAArB,CACAD,CAAI,CAACE,OAAL,CAAe,mCAAf,CACAF,CAAI,CAACF,mBAAL,CAA2BA,CAE9B,CAMDD,CAAO,CAACM,SAAR,CAAkBC,IAAlB,CAAyB,UAAY,CACjC,GAAIJ,CAAAA,CAAI,CAAG,IAAX,CAKAA,CAAI,CAACK,WAAL,EAGH,CATD,CAWAR,CAAO,CAACM,SAAR,CAAkBE,WAAlB,CAAgC,UAAY,CACxC,GAAIL,CAAAA,CAAI,CAAG,IAAX,CAEAM,QAAQ,CAACC,cAAT,CAAwB,cAAxB,EAAwCC,gBAAxC,CAAyD,OAAzD,CAAkER,CAAI,CAACS,YAAL,CAAkBC,IAAlB,CAAuB,IAAvB,CAAlE,CACH,CAJD,CAMAb,CAAO,CAACM,SAAR,CAAkBM,YAAlB,CAAiC,UAAY,CACzChB,CAAG,CAACM,KAAJ,CAAU,kBAAV,EADyC,GAErCC,CAAAA,CAAI,CAAG,IAF8B,CAInCW,CAAa,CAAGL,QAAQ,CAACM,gBAAT,CAA0B,mBAA1B,EAA+CC,MAJ5B,CAMnCC,CAAO,CAAG,CACZC,EAAE,iCAA2BJ,CAAa,CAAG,CAA3C,CADU,CAEZK,gBAAgB,CAAEL,CAAa,CAAG,CAFtB,CAIZM,GAAG,CAAE,CAJO,CANyB,CAczCvB,CAAS,CAACwB,MAAV,CAAiBlB,CAAI,CAACC,aAAtB,CAAqCa,CAArC,EACKK,IADL,CACU,SAAUC,CAAV,CAAgBC,CAAhB,CAAoB,CAEtB3B,CAAS,CAAC4B,kBAAV,CAA6BhB,QAAQ,CAACC,cAAT,CAAwB,eAAxB,CAA7B,CAAuEa,CAAvE,CAA6EC,CAA7E,EAFsB,GAGhBE,CAAAA,CAAE,CAAGjB,QAAQ,CAACkB,aAAT,CAAuB,OAAvB,EAAgCC,gBAHrB,CAKlBC,CAAS,CAAG,CACZX,EAAE,CAAEQ,CAAE,CAACI,YAAH,CAAgB,sBAAhB,CADQ,CAEZC,GAAG,iCAA2BjB,CAAa,CAAG,CAA3C,CAFS,CAGZkB,MAAM,CAAE,KAHI,CAIZZ,GAAG,CAAE,CAJO,CAKZa,WAAW,CAAE,EALD,CAMZC,QAAQ,CAAER,CAAE,CAACS,QAND,CAOZC,YAAY,CAAE3B,QAAQ,CAACC,cAAT,CAAwB,MAAxB,EAAgCoB,YAAhC,CAA6C,oBAA7C,CAPF,CAQZO,MAAM,CAAE,EARI,CASZC,QAAQ,CAAE,EATE,CALM,CAkBtB,GAAuC,EAAnC,EAAAxC,CAAa,CAACyC,eAAd,EAAJ,CAA2C,CACvCpC,CAAI,CAACF,mBAAL,CAA2BuC,IAAI,CAACC,KAAL,CAAWhC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCgC,KAAlD,CAC9B,CAEDvC,CAAI,CAACF,mBAAL,CAAyB0C,IAAzB,CAA8Bd,CAA9B,EACA/B,CAAa,CAAC8C,eAAd,CAA8BzC,CAAI,CAACF,mBAAnC,CAEH,CA1BL,EA2BK4C,IA3BL,CA2BU,SAAUC,CAAV,CAAc,CAChBlD,CAAG,CAACM,KAAJ,CAAU,UAAV,EACAN,CAAG,CAACM,KAAJ,CAAU4C,CAAV,CACH,CA9BL,EAgCA,GAAMC,CAAAA,CAAY,CAAiD,IAA9C,EAAAtC,QAAQ,CAACC,cAAT,CAAwB,WAAxB,EAAqCgC,KAA1D,CACA,GAAIK,CAAJ,CAAkB,CACdtC,QAAQ,CAACkB,aAAT,CAAuB,6BAAvB,EAAsDqB,YAAtD,CAAmE,QAAnE,IACH,CAEJ,CAnDD,CAgHA,MAAO,CACHC,IAAI,CAnMR,UAAgB,CACZrD,CAAG,CAACM,KAAJ,CAAU,oBAAV,EADY,GAENgD,CAAAA,CAAI,CAAGpD,CAAa,CAACqD,OAAd,EAFD,CAGRlD,CAHQ,CAMZ,GAAa,QAAT,GAAAiD,CAAI,EAAiBzC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuC0C,SAAvC,CAAiDC,QAAjD,CAA0D,YAA1D,CAAzB,CAAkG,CAE9FtD,CAAQ,CAACkD,IAAT,CAAc,gBAAd,CACH,CAED,GAAa,MAAT,GAAAC,CAAI,EAAyB,QAAT,GAAAA,CAAI,EAAiBzC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuC0C,SAAvC,CAAiDC,QAAjD,CAA0D,YAA1D,SAA7C,CAAoI,CAChIpD,CAAmB,CAAGQ,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCgC,KAEhE,CAHD,IAGO,CAEH,GAAIb,CAAAA,CAAS,CAAG,CACZX,EAAE,CAAE,CADQ,CAEZa,GAAG,iCAA2BtB,QAAQ,CAACM,gBAAT,CAA0B,mBAA1B,EAA+CC,MAA1E,CAFS,CAGZgB,MAAM,CAAE,KAHI,CAIZC,WAAW,CAAE,EAJD,CAKZC,QAAQ,CAAE,CALE,CAMZE,YAAY,CAAE3B,QAAQ,CACjBC,cADS,CACM,MADN,EAEToB,YAFS,CAEI,oBAFJ,CANF,CASZO,MAAM,CAAE,EATI,CAUZC,QAAQ,CAAE,EAVE,CAWZgB,UAAU,CAAE,EAXA,CAAhB,CAcArD,CAAmB,CAAG,CAAC4B,CAAD,CAAtB,CACApB,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuCgC,KAAvC,CAA+CF,IAAI,CAACe,SAAL,CAAetD,CAAf,CAElD,CAED,GAAuE,CAAnE,EAAAQ,QAAQ,CAACC,cAAT,CAAwB,MAAxB,EAAgCoB,YAAhC,CAA6C,iBAA7C,CAAJ,CAA2E,CAEvE,GAAY,MAAR,EAAAoB,CAAI,EAAc,IAAAzC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,EAAuC0C,SAAvC,CAAiDC,QAAjD,CAA0D,YAA1D,CAAtB,CAAuG,CACnGtD,CAAQ,CAACkD,IAAT,CAAc,gBAAd,CACH,CACJ,CAGD,GAAIO,CAAAA,CAAO,CAAG,GAAIxD,CAAAA,CAAJ,CAAYC,CAAZ,CAAd,CACAuD,CAAO,CAACjD,IAAR,EAEH,CAoJM,CAGV,CAzMC,CAAN","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable promise/always-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/templates', 'gradingform_frubric/feditor_helper', 'gradingform_frubric/rerender_control'],\n    function ($, Log, Templates, FeditorHelper, Rerender) {\n        'use strict';\n\n        function init() {\n            Log.debug(\"Feditor control...\");\n            const mode = FeditorHelper.getMode();\n            let criterioncollection;\n            // let rerender = 0;\n\n            if (mode === 'create' && document.getElementById('id_criteria').classList.contains('is-invalid')) { // Re render the template with the previous values\n                //  rerender = 1;\n                Rerender.init('rerendercreate')\n            }\n\n            if (mode === 'edit' || (mode === 'create' && document.getElementById('id_criteria').classList.contains('is-invalid') != undefined)) { // Validation error, keep the values inserted\n                criterioncollection = document.getElementById('id_criteria').value;\n\n            } else {\n                // Initialise the first criterion\n                var criterion = {\n                    id: 1,\n                    cid: `frubric-criteria-NEWID${document.querySelectorAll(\".criterion-header\").length}`, // Criterion ID for the DB\n                    status: \"NEW\",\n                    description: \"\", // Criterion descrption\n                    rowindex: 1, // Keep track of the header row.\n                    definitionid: document\n                        .getElementById(\"cont\")\n                        .getAttribute(\"data-definition-id\"), // Id from mdl_grading_definitions/\n                    levels: [],\n                    sumscore: \"\",\n                    totaloutof: \"\"\n                };\n\n                criterioncollection = [criterion]; // Collects all the criterions\n                document.getElementById('id_criteria').value = JSON.stringify(criterioncollection);\n\n            }\n\n            if (document.getElementById('cont').getAttribute('data-rerendered') == 0 ) {\n\n                if (mode == 'edit' && document.getElementById('id_criteria').classList.contains('is-invalid') == true) {\n                    Rerender.init('rerenderupdate');\n                }\n            }\n\n          \n            let control = new Feditor(criterioncollection);\n            control.main();\n\n        }\n\n        /**\n         *\n         * @param {*} criterioncollection\n         */\n        function Feditor(criterioncollection) {\n            Log.debug('Feditor: initialising...');\n            let self = this;\n            self.CRITERION_ROW = 'gradingform_frubric/editor_criterion_row';\n            self.FEDITOR = 'gradingform_frubric/frubriceditor';\n            self.criterioncollection = criterioncollection;\n            //self.rerender = rerender;\n        }\n\n        /**\n         * Run the controller.\n         *\n         */\n        Feditor.prototype.main = function () {\n            let self = this;\n            // Log.debug(this);\n            // if (self.rerender == 1) {\n            //     self.rerenderEditor();\n            // } else {\n            self.setupEvents();\n            // }\n\n        };\n\n        Feditor.prototype.setupEvents = function () {\n            let self = this;\n            // Add criterio btn\n            document.getElementById('addCriterion').addEventListener('click', self.addCriterion.bind(this));\n        };\n\n        Feditor.prototype.addCriterion = function () {\n            Log.debug(\"Add criterion...\");\n            let self = this;\n\n            const countcriteria = document.querySelectorAll('.criterion-header').length;\n            // Set context\n            const context = {\n                id: `frubric-criteria-NEWID${countcriteria + 1}`,\n                criteriongroupid: countcriteria + 1,\n                // description: 'Click to edit criterion',\n                new: 1, // Adds the result row\n            };\n\n\n            Templates.render(self.CRITERION_ROW, context)\n                .done(function (html, js) {\n\n                    Templates.appendNodeContents(document.getElementById('criteriaTable'), html, js);\n                    const cr = document.querySelector(\"tbody\").lastElementChild;\n\n                    let criterion = {\n                        id: cr.getAttribute('data-criterion-group'),\n                        cid: `frubric-criteria-NEWID${countcriteria + 1}`, // Criterion ID for the DB\n                        status: 'NEW',\n                        new: 1, // to add the result row\n                        description: '', // Criterion descrption\n                        rowindex: cr.rowIndex, // Keep track of the header row.\n                        definitionid: document.getElementById('cont').getAttribute('data-definition-id'), // Id from mdl_grading_definitions\n                        levels: [],\n                        sumscore: \"\",\n                    };\n\n\n                    if (FeditorHelper.getCriteriaJSON() != '') {\n                        self.criterioncollection = JSON.parse(document.getElementById('id_criteria').value);\n                    }\n\n                    self.criterioncollection.push(criterion);\n                    FeditorHelper.setCriteriaJSON(self.criterioncollection);\n\n                })\n                .fail(function (ex) {\n                    Log.debug(\"error...\");\n                    Log.debug(ex);\n                });\n\n            const isreadytouse = document.getElementById('id_status').value == '20'; // 20 ==> STATUS READY\n            if (isreadytouse) {\n                document.querySelector('.gradingform_rubric-regrade').setAttribute('hidden', true)\n            }\n\n        };\n\n\n        // Feditor.prototype.rerenderEditor = function () {\n        //     var self = this;\n\n        //     const context = JSON.parse(self.criterioncollection);\n        //     const definitionid = document.getElementById(\"cont\").getAttribute(\"data-definition-id\")\n\n        //     const data = {\n        //         edit: 1,\n        //         rerender: 1,\n        //         definitionid: definitionid,\n        //         \"criteria\": []\n        //     }\n\n        //     context.forEach(function (element) {\n        //         let auxid = element.id;\n        //         //element.id = element.cid;\n        //         element.criteriongroupid = auxid;\n        //         if (element.levels.length == 0) {\n        //             element.levels.push({\n        //                 score: '',\n        //                 status: \"NEW\",\n        //                 id: FeditorHelper.getRandomID(),\n        //                 descriptors: [{\n        //                     checked: false,\n        //                     descText: '',\n        //                     delete: 0\n        //                 }]\n        //             });\n        //         } else {\n        //             element.levels.forEach(level => {\n        //                 if (level.descriptors.length == 0) {\n        //                     level.descriptors.push({\n        //                         checked: false,\n        //                         descText: '',\n        //                         delete: 0\n        //                     });\n        //                 }\n        //             });\n        //         }\n        //         data.criteria.push(element);\n\n        //     });\n\n        //     Templates.render(self.FEDITOR, data)\n        //         .done(function (html, js) {\n        //             Y.log(html);\n        //             // Replace with editor with previous values\n        //             const editor = document.getElementById('cont');\n        //             Templates.replaceNode(editor, html, js);\n\n        //         }).fail(function (ex) {\n        //             Log.debug(\"error...\");\n        //             Log.debug(ex);\n        //         });\n\n        // }\n\n\n        return {\n            init: init\n        };\n    });"],"file":"feditor.min.js"}