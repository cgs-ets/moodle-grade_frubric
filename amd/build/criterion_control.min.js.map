{"version":3,"file":"criterion_control.min.js","sources":["../src/criterion_control.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/log', 'core/templates',\n            'core/str', 'core/notification',\n            'gradingform_frubric/level_control',\n            'gradingform_frubric/feditor_helper'\n        ],\n        function (Log, Templates, Str, Notification, LevelControl, FeditorHelper) {\n        'use strict';\n        /**\n         *\n         * @param {*} id\n         */\n        function init(id) {\n            const mode = FeditorHelper.getMode();\n            let control = new CriterionControl(mode, id);\n            control.main();\n        }\n\n        /**\n         *\n         * @param {*} mode\n         * @param {*} id\n         */\n        function CriterionControl(mode, id) {\n            const self = this;\n            self.LEVEL_ROW = 'gradingform_frubric/editor_level_row';\n            self.mode = mode;\n            self.id = id;\n        }\n\n        /**\n         * Run the controller.\n         *\n         */\n        CriterionControl.prototype.main = function () {\n            let self = this;\n            const currentRow = document.getElementById(self.id);\n\n            if (self.mode == 'edit') { // Add the listeners to all the criterion rows.\n                try {\n                    self.setupEvents(currentRow);\n                    // Attach level listeners.\n                    currentRow.getAttribute('data-criterion-group');\n                    LevelControl.init(self.id);\n\n                } catch (error) {\n                    Log.debug(error);\n                }\n\n            } else {\n                self.setupEvents(currentRow);\n            }\n\n        };\n\n        CriterionControl.prototype.setupEvents = function (currentRow) {\n            let self = this;\n            const actions = currentRow.querySelector('.act'); // Get actions cell data-row-type=\"criterion-add-level\"\n            const addLevelRow = FeditorHelper.getNextElement(currentRow, '.add-level-r');\n\n            if (!actions) {\n                return;\n            }\n\n            const actionChildren = actions.children;\n\n            // Criterion actions.\n            actionChildren[0].addEventListener('click', self.removeCriterion.bind(currentRow));\n           addLevelRow.children[0].addEventListener('click', self.addLevel.bind(self, currentRow));\n\n            const description = currentRow.querySelector('.crit-desc'); // Get description\n            description.addEventListener('click', self.editCriterionDescription.bind(this));\n            description.addEventListener('focusout', self.focusoutHandlerDisabled);\n\n            // Get the previous criterion to attach events to the total criterion row at the top of this one.\n            const resultRow = FeditorHelper.getNextElement(currentRow, '.result-r');\n\n            if (resultRow != undefined) {\n                const [criterionTitletd, criterionTotaltd] = resultRow.children;\n                criterionTotaltd.querySelector('.total-input').addEventListener('blur', self.validateTotal);\n            }\n\n\n        };\n\n        CriterionControl.prototype.addLevel = function (row) {\n            let self = this;\n            const randomid = FeditorHelper.getRandomID();\n            const context = {\n                'score': 'Click to edit Mark',\n                'definition': 'Click to edit Level description',\n                'criteriongroupid': row.getAttribute('data-criterion-group'),\n                'id': randomid,\n            };\n\n            Templates.render(self.LEVEL_ROW, context)\n                .done(function (html, js) {\n\n                    var prevlevel;\n                    const classname = `.level-${row.getAttribute('data-criterion-group')}`;\n                    let nextCriterion = FeditorHelper.getNextElement(row, '.criterion-header');\n                     //  If there is another criterion the level is on top of this row.\n                    if (nextCriterion != undefined) {\n                        // The new level is on top of the result row for this criterion.\n                        const prevresultlevel = FeditorHelper.getPreviousElement(nextCriterion, '.result-r');\n                        prevlevel = FeditorHelper.getPreviousElement(prevresultlevel, classname);\n                        // If undefined, the criterion represented by row has no levels.\n                        // Add the level under the current criterion\n                        if (prevlevel == undefined) {\n                            prevlevel = row;\n                        }\n\n                    } else {\n                        // Get the result row for this criterion\n                        const resultrow = FeditorHelper.getNextElement(row, '.result-r');\n                        prevlevel = FeditorHelper.getPreviousElement(resultrow, classname);\n\n\n                        if (prevlevel == undefined) { // This criterion doesnt have levels yet.\n                            prevlevel = row;\n                        }\n\n                          // Check if the row has a red border around when it failed validation.\n                        if (prevlevel.classList.contains('is-invalid')) {\n                            prevlevel.classList.remove('is-invalid');\n                            prevlevel.classList.remove('form-control');\n                        }\n                    }\n\n                    prevlevel.insertAdjacentHTML('beforebegin', html);\n\n                    const levelObject = {\n                        score: 0,\n                        status: 'NEW',\n                        id: randomid,\n                        descriptors: []\n                    };\n                    const criterioncollection = FeditorHelper.getCriteriaJSON();\n                    const filterCriterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criterioncollection);\n\n                    filterCriterion[0].levels.push(levelObject);\n                    // Refresh the JSON input.\n                    FeditorHelper.setCriteriaJSON(criterioncollection);\n                    FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n                    LevelControl.init(randomid, self.id);\n                })\n                .fail(function (ex) {\n                    Log.debug(\"error...\");\n                    Log.debug(ex);\n                });\n\n\n        };\n\n\n        CriterionControl.prototype.removeCriterion = function (row) {\n\n            Str.get_strings([{\n                    key: 'confirm',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'confirmdeletecriterion',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'yes'\n                },\n                {\n                    key: 'no'\n                },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n                    let criTable = document.getElementById('criteriaTable');\n                    let criterionToDelete = row.target.parentNode.parentNode.parentNode.parentNode.rowIndex;\n\n                    const criteariaID = row.target.parentNode.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n\n                    // Change the criterion status tu DELETE, to be able to delete from the DB.\n                    let frc = FeditorHelper.getCriteriaJSON();\n                    // Check if this is a criteriont that is not saved in the DB yet. If it is, the object has a new:1 property.\n                    // Change the description in the JSON\n                    const frctodel = frc.filter(function (criterion, index) {\n                        const criteariaID = this.getAttribute('data-criterion-group');\n                        criterion.rowindex = index;\n                        if (criteariaID == criterion.id) {\n                            return criterion;\n                        }\n                    }, row.target.parentNode.parentNode.parentNode.parentNode);\n\n\n                    frctodel[0].status = \"DELETE\";\n                    const levels = frctodel[0].levels;\n\n                    // Change the status for the levels in this criterion\n\n                    for (let j = 0; j < levels.length; j++) {\n                        levels[j].status = \"DELETE\";\n                    }\n                    if ('new' in frctodel[0]) {\n                        const postodel = frctodel[0].id - 1;\n                        frc.splice(postodel, 1);\n\n                    }\n                    FeditorHelper.setCriteriaJSON(frc);\n                    FeditorHelper.setHiddenCriteriaJSON(frc);\n\n                    // Delete all the levels in that criterion.\n                    for (let i = (criterionToDelete + 1); i < criTable.rows.length; i++) {\n                        if (criTable.rows[i].getAttribute('data-criterion-group') == criteariaID) {\n                            criTable.rows[i].classList.add('to-remove'); // Tag the rows to delete.\n                        } else {\n                            break;\n                        }\n                    }\n\n                    removeElementsByClass('to-remove');\n\n                    function removeElementsByClass(className) {\n                        var elements = document.getElementsByClassName(className);\n                        while (elements.length > 0) {\n                            elements[0].parentNode.removeChild(elements[0]);\n                        }\n                    }\n\n                    criTable.deleteRow(criterionToDelete);\n\n                    //if this is a new criterion that is not saved in the DB. We can just delete it. We do the previous work to\n\n\n                }, function () {\n                    return;\n                });\n            });\n        };\n\n\n        CriterionControl.prototype.editCriterionDescription = function (e) {\n            e.stopPropagation();\n\n            let textarea = e.target;\n\n            textarea.removeAttribute('disabled');\n            textarea.focus();\n\n            textarea.addEventListener('change', this.changeCriterionHandlerDisabled.bind(this));\n        };\n\n\n        CriterionControl.prototype.focusoutHandlerDisabled = function (e) {\n            e.target.setAttribute('disabled', true);\n        };\n\n        CriterionControl.prototype.changeCriterionHandlerDisabled = function (e) {\n\n            const criterioncollection = (document.getElementById('id_criteria').value) ? FeditorHelper.getCriteriaJSON() : [];\n\n            // Change the description in the JSON.\n            const filterCriterion = criterioncollection.filter(function (criterion, index) {\n                const id = e.target.parentNode.parentNode.getAttribute('data-criterion-group');\n                criterion.rowindex = index;\n                if (id == criterion.id) {\n                    return criterion;\n                }\n            }, e);\n\n            if (filterCriterion[0].description != e.target.value && (FeditorHelper.getMode() == 'edit' &&\n                    !filterCriterion[0].cid.includes('frubric-criteria-NEWID'))) { // A new criterion is added to an existing definition\n                filterCriterion[0].status = 'UPDATE';\n            }\n\n            filterCriterion[0].description = e.target.value;\n            // Refresh the Criteria JSON input\n            //document.getElementById('id_criteria').value = JSON.stringify(criterioncollection);\n            FeditorHelper.setCriteriaJSON(criterioncollection);\n            FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n\n            // Check if the criterion has a red border because it comes from a failed attempt to save and make ready.\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title');\n            }\n        };\n\n        CriterionControl.prototype.validateTotal = function (e) {\n\n            // In case the user put the wrong value before, clean the style\n            e.target.classList.remove('total-input-error');\n            e.target.removeAttribute('data-toggle');\n            e.target.removeAttribute('data-placement');\n            e.target.removeAttribute('data-title');\n\n            const inputvalue = e.target.valueAsNumber;\n            const min = e.target.getAttribute('min');\n            const max = e.target.getAttribute('max');\n\n            if ((inputvalue != NaN) && (inputvalue < min || inputvalue > max)) {\n                e.target.classList.add('total-input-error');\n                e.target.setAttribute('data-toggle', 'tooltip');\n                e.target.setAttribute('data-placement', 'right');\n                e.target.setAttribute('data-title', 'Value out of range');\n            } else {\n                // Change the description in the JSON.\n                const criteria = FeditorHelper.getCriteriaJSON();\n                const criterion = FeditorHelper.getCriterionFromCriteriaCollection(e.target.parentNode.parentNode.parentNode, criteria);\n\n                criterion[0].sumscore = inputvalue;\n                FeditorHelper.setCriteriaJSON(criteria);\n                FeditorHelper.setHiddenCriteriaJSON(criteria);\n            }\n\n        }\n\n\n        return {\n            init: init\n        };\n    });"],"names":["define","Log","Templates","Str","Notification","LevelControl","FeditorHelper","CriterionControl","mode","id","this","LEVEL_ROW","prototype","main","self","currentRow","document","getElementById","setupEvents","getAttribute","init","error","debug","actions","querySelector","addLevelRow","getNextElement","children","addEventListener","removeCriterion","bind","addLevel","description","editCriterionDescription","focusoutHandlerDisabled","resultRow","undefined","criterionTitletd","criterionTotaltd","validateTotal","row","randomid","getRandomID","context","render","done","html","js","prevlevel","classname","nextCriterion","prevresultlevel","getPreviousElement","resultrow","classList","contains","remove","insertAdjacentHTML","levelObject","score","status","descriptors","criterioncollection","getCriteriaJSON","getCriterionFromCriteriaCollection","levels","push","setCriteriaJSON","setHiddenCriteriaJSON","fail","ex","get_strings","key","component","strs","confirm","criTable","criterionToDelete","target","parentNode","rowIndex","criteariaID","frc","frctodel","filter","criterion","index","rowindex","j","length","postodel","splice","i","rows","add","className","elements","getElementsByClassName","removeChild","removeElementsByClass","deleteRow","e","stopPropagation","textarea","removeAttribute","focus","changeCriterionHandlerDisabled","setAttribute","value","filterCriterion","getMode","cid","includes","inputvalue","valueAsNumber","min","max","NaN","criteria","sumscore"],"mappings":"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"}