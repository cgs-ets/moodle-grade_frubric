{"version":3,"file":"criterion_control.min.js","sources":["../src/criterion_control.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @package   gradingform_frubric\n * @copyright 2021 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/log', 'core/templates',\n            'core/str', 'core/notification',\n            'gradingform_frubric/level_control',\n            'gradingform_frubric/feditor_helper'\n        ],\n        function (Log, Templates, Str, Notification, LevelControl, FeditorHelper) {\n        'use strict';\n        /**\n         *\n         * @param {*} id\n         */\n        function init(id) {\n            const mode = FeditorHelper.getMode();\n            let control = new CriterionControl(mode, id);\n            control.main();\n        }\n\n        /**\n         *\n         * @param {*} mode\n         * @param {*} id\n         */\n        function CriterionControl(mode, id) {\n            const self = this;\n            self.LEVEL_ROW = 'gradingform_frubric/editor_level_row';\n            self.mode = mode;\n            self.id = id;\n        }\n\n        /**\n         * Run the controller.\n         *\n         */\n        CriterionControl.prototype.main = function () {\n            let self = this;\n            const currentRow = document.getElementById(self.id);\n\n            if (self.mode == 'edit') { // Add the listeners to all the criterion rows.\n                try {\n                    self.setupEvents(currentRow);\n                    // Attach level listeners.\n                    currentRow.getAttribute('data-criterion-group');\n                    LevelControl.init(self.id);\n\n                } catch (error) {\n                    Log.debug(error);\n                }\n\n            } else {\n                self.setupEvents(currentRow);\n            }\n\n        };\n\n        CriterionControl.prototype.setupEvents = function (currentRow) {\n            let self = this;\n            const actions = currentRow.querySelector('.act'); // Get actions cell data-row-type=\"criterion-add-level\"\n            const addLevelRow = FeditorHelper.getNextElement(currentRow, '.add-level-r');\n\n            if (!actions) {\n                return;\n            }\n\n            const actionChildren = actions.children;\n\n            // Criterion actions.\n            actionChildren[0].addEventListener('click', self.removeCriterion.bind(currentRow));\n           addLevelRow.children[0].addEventListener('click', self.addLevel.bind(self, currentRow));\n\n            const description = currentRow.querySelector('.crit-desc'); // Get description\n            description.addEventListener('click', self.editCriterionDescription.bind(this));\n            description.addEventListener('focusout', self.focusoutHandlerDisabled);\n\n            // Get the previous criterion to attach events to the total criterion row at the top of this one.\n            const resultRow = FeditorHelper.getNextElement(currentRow, '.result-r');\n\n            if (resultRow != undefined) {\n                const [criterionTitletd, criterionTotaltd] = resultRow.children;\n                criterionTotaltd.querySelector('.total-input').addEventListener('blur', self.validateTotal);\n            }\n\n\n        };\n\n        CriterionControl.prototype.addLevel = function (row) {\n            let self = this;\n            const randomid = FeditorHelper.getRandomID();\n            const context = {\n                'score': 'Click to edit Mark',\n                'definition': 'Click to edit Level description',\n                'criteriongroupid': row.getAttribute('data-criterion-group'),\n                'id': randomid,\n            };\n\n            Templates.render(self.LEVEL_ROW, context)\n                .done(function (html, js) {\n\n                    var prevlevel;\n                    const classname = `.level-${row.getAttribute('data-criterion-group')}`;\n                    let nextCriterion = FeditorHelper.getNextElement(row, '.criterion-header');\n                     //  If there is another criterion the level is on top of this row.\n                    if (nextCriterion != undefined) {\n                        // The new level is on top of the result row for this criterion.\n                        const prevresultlevel = FeditorHelper.getPreviousElement(nextCriterion, '.result-r');\n                        prevlevel = FeditorHelper.getPreviousElement(prevresultlevel, classname);\n                        // If undefined, the criterion represented by row has no levels.\n                        // Add the level under the current criterion\n                        if (prevlevel == undefined) {\n                            prevlevel = row;\n                        }\n\n                    } else {\n                        // Get the result row for this criterion\n                        const resultrow = FeditorHelper.getNextElement(row, '.result-r');\n                        prevlevel = FeditorHelper.getPreviousElement(resultrow, classname);\n\n\n                        if (prevlevel == undefined) { // This criterion doesnt have levels yet.\n                            prevlevel = row;\n                        }\n\n                          // Check if the row has a red border around when it failed validation.\n                        if (prevlevel.classList.contains('is-invalid')) {\n                            prevlevel.classList.remove('is-invalid');\n                            prevlevel.classList.remove('form-control');\n                        }\n                    }\n\n                    prevlevel.insertAdjacentHTML('beforebegin', html);\n\n                    const levelObject = {\n                        score: 0,\n                        status: 'NEW',\n                        id: randomid,\n                        descriptors: []\n                    };\n                    const criterioncollection = FeditorHelper.getCriteriaJSON();\n                    const filterCriterion = FeditorHelper.getCriterionFromCriteriaCollection(row, criterioncollection);\n\n                    filterCriterion[0].levels.push(levelObject);\n                    // Refresh the JSON input.\n                    FeditorHelper.setCriteriaJSON(criterioncollection);\n                    FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n                    LevelControl.init(randomid, self.id);\n                })\n                .fail(function (ex) {\n                    Log.debug(\"error...\");\n                    Log.debug(ex);\n                });\n\n\n        };\n\n\n        CriterionControl.prototype.removeCriterion = function (row) {\n\n            Str.get_strings([{\n                    key: 'confirm',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'confirmdeletecriterion',\n                    component: 'gradingform_frubric'\n                },\n                {\n                    key: 'yes'\n                },\n                {\n                    key: 'no'\n                },\n\n            ]).done(function (strs) {\n                Notification.confirm(strs[0], strs[1], strs[2], strs[3], function () {\n                    let criTable = document.getElementById('criteriaTable');\n                    let criterionToDelete = row.target.parentNode.parentNode.parentNode.parentNode.rowIndex;\n\n                    const criteariaID = row.target.parentNode.parentNode.parentNode.parentNode.getAttribute('data-criterion-group');\n\n                    // Change the criterion status tu DELETE, to be able to delete from the DB.\n                    let frc = FeditorHelper.getCriteriaJSON();\n                    // Check if this is a criteriont that is not saved in the DB yet. If it is, the object has a new:1 property.\n                    // Change the description in the JSON\n                    const frctodel = frc.filter(function (criterion, index) {\n                        const criteariaID = this.getAttribute('data-criterion-group');\n                        criterion.rowindex = index;\n                        if (criteariaID == criterion.id) {\n                            return criterion;\n                        }\n                    }, row.target.parentNode.parentNode.parentNode.parentNode);\n\n\n                    frctodel[0].status = \"DELETE\";\n                    const levels = frctodel[0].levels;\n\n                    // Change the status for the levels in this criterion\n\n                    for (let j = 0; j < levels.length; j++) {\n                        levels[j].status = \"DELETE\";\n                    }\n                    if ('new' in frctodel[0]) {\n                        const postodel = frctodel[0].id - 1;\n                        frc.splice(postodel, 1);\n\n                    }\n                    FeditorHelper.setCriteriaJSON(frc);\n                    FeditorHelper.setHiddenCriteriaJSON(frc);\n\n                    // Delete all the levels in that criterion.\n                    for (let i = (criterionToDelete + 1); i < criTable.rows.length; i++) {\n                        if (criTable.rows[i].getAttribute('data-criterion-group') == criteariaID) {\n                            criTable.rows[i].classList.add('to-remove'); // Tag the rows to delete.\n                        } else {\n                            break;\n                        }\n                    }\n\n                    removeElementsByClass('to-remove');\n\n                    function removeElementsByClass(className) {\n                        var elements = document.getElementsByClassName(className);\n                        while (elements.length > 0) {\n                            elements[0].parentNode.removeChild(elements[0]);\n                        }\n                    }\n\n                    criTable.deleteRow(criterionToDelete);\n\n                    //if this is a new criterion that is not saved in the DB. We can just delete it. We do the previous work to\n\n\n                }, function () {\n                    return;\n                });\n            });\n        };\n\n\n        CriterionControl.prototype.editCriterionDescription = function (e) {\n            e.stopPropagation();\n\n            let textarea = e.target;\n\n            textarea.removeAttribute('disabled');\n            textarea.focus();\n\n            textarea.addEventListener('change', this.changeCriterionHandlerDisabled.bind(this));\n        };\n\n\n        CriterionControl.prototype.focusoutHandlerDisabled = function (e) {\n            e.target.setAttribute('disabled', true);\n        };\n\n        CriterionControl.prototype.changeCriterionHandlerDisabled = function (e) {\n\n            const criterioncollection = (document.getElementById('id_criteria').value) ? FeditorHelper.getCriteriaJSON() : [];\n\n            // Change the description in the JSON.\n            const filterCriterion = criterioncollection.filter(function (criterion, index) {\n                const id = e.target.parentNode.parentNode.getAttribute('data-criterion-group');\n                criterion.rowindex = index;\n                if (id == criterion.id) {\n                    return criterion;\n                }\n            }, e);\n\n            if (filterCriterion[0].description != e.target.value && (FeditorHelper.getMode() == 'edit' &&\n                    !filterCriterion[0].cid.includes('frubric-criteria-NEWID'))) { // A new criterion is added to an existing definition\n                filterCriterion[0].status = 'UPDATE';\n            }\n\n            filterCriterion[0].description = e.target.value;\n            // Refresh the Criteria JSON input\n            //document.getElementById('id_criteria').value = JSON.stringify(criterioncollection);\n            FeditorHelper.setCriteriaJSON(criterioncollection);\n            FeditorHelper.setHiddenCriteriaJSON(criterioncollection);\n\n            // Check if the criterion has a red border because it comes from a failed attempt to save and make ready.\n\n            if (e.target.classList.contains('is-invalid')) {\n                e.target.classList.remove('is-invalid');\n                e.target.classList.remove('form-control');\n                e.target.removeAttribute('title');\n            }\n        };\n\n        CriterionControl.prototype.validateTotal = function (e) {\n\n            // In case the user put the wrong value before, clean the style\n            e.target.classList.remove('total-input-error');\n            e.target.removeAttribute('data-toggle');\n            e.target.removeAttribute('data-placement');\n            e.target.removeAttribute('data-title');\n\n            const inputvalue = e.target.valueAsNumber;\n            const min = e.target.getAttribute('min');\n            const max = e.target.getAttribute('max');\n\n            if ((inputvalue != NaN) && (inputvalue < min || inputvalue > max)) {\n                e.target.classList.add('total-input-error');\n                e.target.setAttribute('data-toggle', 'tooltip');\n                e.target.setAttribute('data-placement', 'right');\n                e.target.setAttribute('data-title', 'Value out of range');\n            } else {\n                // Change the description in the JSON.\n                const criteria = FeditorHelper.getCriteriaJSON();\n                const criterion = FeditorHelper.getCriterionFromCriteriaCollection(e.target.parentNode.parentNode.parentNode, criteria);\n\n                criterion[0].sumscore = inputvalue;\n                FeditorHelper.setCriteriaJSON(criteria);\n                FeditorHelper.setHiddenCriteriaJSON(criteria);\n            }\n\n        }\n\n\n        return {\n            init: init\n        };\n    });"],"names":["define","Log","Templates","Str","Notification","LevelControl","FeditorHelper","CriterionControl","mode","id","this","LEVEL_ROW","prototype","main","currentRow","document","getElementById","setupEvents","getAttribute","init","error","debug","actions","querySelector","addLevelRow","getNextElement","children","addEventListener","removeCriterion","bind","addLevel","description","editCriterionDescription","focusoutHandlerDisabled","resultRow","undefined","validateTotal","row","self","randomid","getRandomID","context","render","done","html","js","prevlevel","classname","nextCriterion","prevresultlevel","getPreviousElement","resultrow","classList","contains","remove","insertAdjacentHTML","levelObject","score","status","descriptors","criterioncollection","getCriteriaJSON","getCriterionFromCriteriaCollection","levels","push","setCriteriaJSON","setHiddenCriteriaJSON","fail","ex","get_strings","key","component","strs","confirm","criTable","criterionToDelete","target","parentNode","rowIndex","criteariaID","frc","frctodel","filter","criterion","index","rowindex","j","length","postodel","splice","i","rows","add","className","elements","getElementsByClassName","removeChild","removeElementsByClass","deleteRow","e","stopPropagation","textarea","removeAttribute","focus","changeCriterionHandlerDisabled","setAttribute","value","filterCriterion","getMode","cid","includes","inputvalue","valueAsNumber","min","max","NaN","criteria","sumscore"],"mappings":";;;;;miCAuBAA,+CAAO,CAAC,WAAY,iBACR,WAAY,oBACZ,oCACA,uCAEJ,SAAUC,IAAKC,UAAWC,IAAKC,aAAcC,aAAcC,wBAiBlDC,iBAAiBC,KAAMC,IACfC,KACRC,UAAY,uCADJD,KAERF,KAAOA,KAFCE,KAGRD,GAAKA,UAOdF,iBAAiBK,UAAUC,KAAO,eAExBC,WAAaC,SAASC,eADjBN,KACqCD,OAE/B,QAHNC,KAGFF,SAHEE,KAKEO,YAAYH,YAEjBA,WAAWI,aAAa,wBACxBb,aAAac,KARVT,KAQoBD,IAEzB,MAAOW,OACLnB,IAAIoB,MAAMD,YAXPV,KAeFO,YAAYH,aAKzBP,iBAAiBK,UAAUK,YAAc,SAAUH,gBAEzCQ,QAAUR,WAAWS,cAAc,QACnCC,YAAclB,cAAcmB,eAAeX,WAAY,mBAExDQ,SAIkBA,QAAQI,SAGhB,GAAGC,iBAAiB,QAXxBjB,KAWsCkB,gBAAgBC,KAAKf,aACvEU,YAAYE,SAAS,GAAGC,iBAAiB,QAZ7BjB,KAY2CoB,SAASD,KAZpDnB,KAY+DI,iBAEpEiB,YAAcjB,WAAWS,cAAc,cAC7CQ,YAAYJ,iBAAiB,QAflBjB,KAegCsB,yBAAyBH,KAAKnB,OACzEqB,YAAYJ,iBAAiB,WAhBlBjB,KAgBmCuB,6BAGxCC,UAAY5B,cAAcmB,eAAeX,WAAY,gBAE1CqB,MAAbD,UAAwB,wCACqBA,UAAUR,0DACtCH,cAAc,gBAAgBI,iBAAiB,OAvBzDjB,KAuBsE0B,kBAMrF7B,iBAAiBK,UAAUkB,SAAW,SAAUO,SACxCC,KAAO5B,KACL6B,SAAWjC,cAAckC,cACzBC,QAAU,OACH,gCACK,mDACMJ,IAAInB,aAAa,2BAC/BqB,UAGVrC,UAAUwC,OAAOJ,KAAK3B,UAAW8B,SAC5BE,MAAK,SAAUC,KAAMC,QAEdC,UACEC,2BAAsBV,IAAInB,aAAa,yBACzC8B,cAAgB1C,cAAcmB,eAAeY,IAAK,wBAEjCF,MAAjBa,cAA4B,KAEtBC,gBAAkB3C,cAAc4C,mBAAmBF,cAAe,aAIvDb,OAHjBW,UAAYxC,cAAc4C,mBAAmBD,gBAAiBF,cAI1DD,UAAYT,SAGb,KAEGc,UAAY7C,cAAcmB,eAAeY,IAAK,aAInCF,OAHjBW,UAAYxC,cAAc4C,mBAAmBC,UAAWJ,cAIpDD,UAAYT,KAIZS,UAAUM,UAAUC,SAAS,gBAC7BP,UAAUM,UAAUE,OAAO,cAC3BR,UAAUM,UAAUE,OAAO,iBAInCR,UAAUS,mBAAmB,cAAeX,UAEtCY,YAAc,CAChBC,MAAO,EACPC,OAAQ,MACRjD,GAAI8B,SACJoB,YAAa,IAEXC,oBAAsBtD,cAAcuD,kBAClBvD,cAAcwD,mCAAmCzB,IAAKuB,qBAE9D,GAAGG,OAAOC,KAAKR,aAE/BlD,cAAc2D,gBAAgBL,qBAC9BtD,cAAc4D,sBAAsBN,qBACpCvD,aAAac,KAAKoB,SAAUD,KAAK7B,OAEpC0D,MAAK,SAAUC,IACZnE,IAAIoB,MAAM,YACVpB,IAAIoB,MAAM+C,QAOtB7D,iBAAiBK,UAAUgB,gBAAkB,SAAUS,KAEnDlC,IAAIkE,YAAY,CAAC,CACTC,IAAK,UACLC,UAAW,uBAEf,CACID,IAAK,yBACLC,UAAW,uBAEf,CACID,IAAK,OAET,CACIA,IAAK,QAGV3B,MAAK,SAAU6B,MACdpE,aAAaqE,QAAQD,KAAK,GAAIA,KAAK,GAAIA,KAAK,GAAIA,KAAK,IAAI,eACjDE,SAAW3D,SAASC,eAAe,iBACnC2D,kBAAoBtC,IAAIuC,OAAOC,WAAWA,WAAWA,WAAWA,WAAWC,SAEzEC,YAAc1C,IAAIuC,OAAOC,WAAWA,WAAWA,WAAWA,WAAW3D,aAAa,wBAGpF8D,IAAM1E,cAAcuD,kBAGlBoB,SAAWD,IAAIE,QAAO,SAAUC,UAAWC,WACvCL,YAAcrE,KAAKQ,aAAa,2BACtCiE,UAAUE,SAAWD,MACjBL,aAAeI,UAAU1E,UAClB0E,YAEZ9C,IAAIuC,OAAOC,WAAWA,WAAWA,WAAWA,YAG/CI,SAAS,GAAGvB,OAAS,iBACfK,OAASkB,SAAS,GAAGlB,OAIlBuB,EAAI,EAAGA,EAAIvB,OAAOwB,OAAQD,IAC/BvB,OAAOuB,GAAG5B,OAAS,YAEnB,QAASuB,SAAS,GAAI,KAChBO,SAAWP,SAAS,GAAGxE,GAAK,EAClCuE,IAAIS,OAAOD,SAAU,GAGzBlF,cAAc2D,gBAAgBe,KAC9B1E,cAAc4D,sBAAsBc,SAG/B,IAAIU,EAAKf,kBAAoB,EAAIe,EAAIhB,SAASiB,KAAKJ,QAChDb,SAASiB,KAAKD,GAAGxE,aAAa,yBAA2B6D,YADDW,IAExDhB,SAASiB,KAAKD,GAAGtC,UAAUwC,IAAI,uBAQRC,eACvBC,SAAW/E,SAASgF,uBAAuBF,gBACxCC,SAASP,OAAS,GACrBO,SAAS,GAAGjB,WAAWmB,YAAYF,SAAS,IALpDG,CAAsB,aAStBvB,SAASwB,UAAUvB,sBAKpB,mBAOXpE,iBAAiBK,UAAUoB,yBAA2B,SAAUmE,GAC5DA,EAAEC,sBAEEC,SAAWF,EAAEvB,OAEjByB,SAASC,gBAAgB,YACzBD,SAASE,QAETF,SAAS1E,iBAAiB,SAAUjB,KAAK8F,+BAA+B3E,KAAKnB,QAIjFH,iBAAiBK,UAAUqB,wBAA0B,SAAUkE,GAC3DA,EAAEvB,OAAO6B,aAAa,YAAY,IAGtClG,iBAAiBK,UAAU4F,+BAAiC,SAAUL,OAE5DvC,oBAAuB7C,SAASC,eAAe,eAAe0F,MAASpG,cAAcuD,kBAAoB,GAGzG8C,gBAAkB/C,oBAAoBsB,QAAO,SAAUC,UAAWC,WAC9D3E,GAAK0F,EAAEvB,OAAOC,WAAWA,WAAW3D,aAAa,2BACvDiE,UAAUE,SAAWD,MACjB3E,IAAM0E,UAAU1E,UACT0E,YAEZgB,GAECQ,gBAAgB,GAAG5E,aAAeoE,EAAEvB,OAAO8B,OAAqC,QAA3BpG,cAAcsG,WAC9DD,gBAAgB,GAAGE,IAAIC,SAAS,4BACrCH,gBAAgB,GAAGjD,OAAS,UAGhCiD,gBAAgB,GAAG5E,YAAcoE,EAAEvB,OAAO8B,MAG1CpG,cAAc2D,gBAAgBL,qBAC9BtD,cAAc4D,sBAAsBN,qBAIhCuC,EAAEvB,OAAOxB,UAAUC,SAAS,gBAC5B8C,EAAEvB,OAAOxB,UAAUE,OAAO,cAC1B6C,EAAEvB,OAAOxB,UAAUE,OAAO,gBAC1B6C,EAAEvB,OAAO0B,gBAAgB,WAIjC/F,iBAAiBK,UAAUwB,cAAgB,SAAU+D,GAGjDA,EAAEvB,OAAOxB,UAAUE,OAAO,qBAC1B6C,EAAEvB,OAAO0B,gBAAgB,eACzBH,EAAEvB,OAAO0B,gBAAgB,kBACzBH,EAAEvB,OAAO0B,gBAAgB,kBAEnBS,WAAaZ,EAAEvB,OAAOoC,cACtBC,IAAMd,EAAEvB,OAAO1D,aAAa,OAC5BgG,IAAMf,EAAEvB,OAAO1D,aAAa,UAEfiG,KAAdJ,aAAuBA,WAAaE,KAAOF,WAAaG,KACzDf,EAAEvB,OAAOxB,UAAUwC,IAAI,qBACvBO,EAAEvB,OAAO6B,aAAa,cAAe,WACrCN,EAAEvB,OAAO6B,aAAa,iBAAkB,SACxCN,EAAEvB,OAAO6B,aAAa,aAAc,0BACjC,KAEGW,SAAW9G,cAAcuD,kBACbvD,cAAcwD,mCAAmCqC,EAAEvB,OAAOC,WAAWA,WAAWA,WAAYuC,UAEpG,GAAGC,SAAWN,WACxBzG,cAAc2D,gBAAgBmD,UAC9B9G,cAAc4D,sBAAsBkD,YAMrC,CACHjG,cAlTUV,IAEI,IAAIF,iBADLD,cAAcsG,UACcnG,IACjCI,QAiTf"}